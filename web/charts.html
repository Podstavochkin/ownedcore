<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>OwnedCore - –ì—Ä–∞—Ñ–∏–∫–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' stroke='%2300ff41' stroke-width='2' fill='none'/><path d='M30 70 L70 30 M30 30 L70 70' stroke='%2300ff41' stroke-width='2'/></svg>">
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js" 
            onerror="console.warn('Failed to load lightweight-charts from unpkg, trying jsdelivr...'); 
                     this.src='https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js';"></script>
    <style>
        :root {
            /* –û—Å–Ω–æ–≤–Ω–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ - Dark Cyberpunk */
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --bg-card: rgba(0, 255, 65, 0.05);
            --bg-modal: rgba(0, 0, 0, 0.98);
            
            /* –¢–µ–∫—Å—Ç */
            --text-primary: #00ff41;
            --text-secondary: #00cc33;
            --text-muted: #008822;
            
            /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ - Cyberpunk Neon */
            --accent-primary: #00ff41;
            --accent-secondary: #ff006e;
            --accent-success: #00ff41;
            --accent-danger: #ff006e;
            --accent-warning: #ffaa00;
            --accent-info: #00d9ff;
            
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã - Cyberpunk */
            --gradient-primary: linear-gradient(135deg, #00ff41 0%, #00cc33 50%, #ff006e 100%);
            --gradient-success: linear-gradient(135deg, #00ff41 0%, #00cc33 100%);
            --gradient-danger: linear-gradient(135deg, #ff006e 0%, #cc0055 100%);
            --gradient-warning: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            
            /* Cyberpunk —ç—Ñ—Ñ–µ–∫—Ç—ã */
            --glass-bg: rgba(0, 255, 65, 0.08);
            --glass-border: rgba(0, 255, 65, 0.3);
            --neon-glow: 0 0 10px rgba(0, 255, 65, 0.5), 0 0 20px rgba(0, 255, 65, 0.3), 0 0 30px rgba(0, 255, 65, 0.2);
            --neon-glow-pink: 0 0 10px rgba(255, 0, 110, 0.5), 0 0 20px rgba(255, 0, 110, 0.3), 0 0 30px rgba(255, 0, 110, 0.2);
            
            /* –¢–µ–Ω–∏ */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
            
            /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
            --transition-fast: 0.15s ease-in-out;
            --transition-normal: 0.3s ease-in-out;
            --transition-slow: 0.5s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Monaco', 'Consolas', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--glass-border);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            min-height: 80px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
            width: 100%;
            gap: 2rem;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .logo {
            width: 52px;
            height: 52px;
        }

        .logo svg {
            width: 100%;
            height: 100%;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0;
        }

        .nav-menu {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: var(--transition-fast);
            font-size: 0.9rem;
        }

        .nav-item:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .nav-item.active {
            color: var(--text-primary);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }

        .design-dropdown {
            position: relative;
        }

        .design-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition-fast);
        }

        .design-btn:hover {
            background: var(--glass-bg);
        }

        .design-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            min-width: 150px;
            display: none;
            z-index: 1001;
        }

        .design-menu.show,
        .design-menu.active {
            display: block;
        }

        .design-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
            color: var(--text-secondary);
        }

        .design-option:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .design-option.active {
            color: var(--text-primary);
            background: var(--glass-bg);
        }

        .live-toggle-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition-fast);
        }

        .live-toggle-btn.live-on {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--accent-success);
            color: var(--accent-success);
        }

        .live-toggle-btn.live-off {
            background: rgba(255, 0, 110, 0.1);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        /* Main Layout - Three Panels */
        .charts-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: calc(100vh - 80px);
        }

        /* Left Panel - Pairs List */
        .pairs-panel {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--glass-border);
            overflow-y: auto;
            padding: 1rem;
        }

        .pairs-panel-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .pairs-panel-header h2 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .pairs-search {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .pairs-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .pair-item {
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .pair-item:hover {
            background: var(--glass-bg);
            border-color: var(--accent-primary);
        }

        .pair-item.active {
            background: var(--glass-bg);
            border-color: var(--accent-primary);
            box-shadow: var(--neon-glow);
        }

        .pair-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .pair-symbol {
            font-weight: bold;
            font-size: 1rem;
        }

        .pair-price {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .pair-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .pair-stat {
            display: flex;
            flex-direction: column;
        }

        .pair-stat-label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .pair-stat-value {
            color: var(--text-secondary);
        }

        .pair-stat-value.positive {
            color: var(--accent-success);
        }

        .pair-stat-value.negative {
            color: var(--accent-danger);
        }

        /* Center Panel - Chart */
        .chart-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .chart-header {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .chart-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .timeframe-selector {
            display: flex;
            gap: 0.5rem;
        }

        .timeframe-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition-fast);
        }

        .timeframe-btn:hover {
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .timeframe-btn.active {
            background: var(--glass-bg);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 400px;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        /* Right Panel - Pair Info */
        .info-panel {
            width: 350px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--glass-border);
            overflow-y: auto;
            padding: 1rem;
        }

        .info-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .info-section-compact {
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .info-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .info-item-label {
            color: var(--text-muted);
        }

        .info-item-value {
            color: var(--text-primary);
            font-weight: bold;
        }

        .levels-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .level-item {
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .level-price {
            font-weight: bold;
            color: var(--text-primary);
        }

        .level-type {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .level-distance {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }


        /* ========== –¢–ï–ú–´ ========== */
        
        /* –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ç–µ–º–∞ */
        body.theme-classic {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.theme-classic:root,
        body.theme-classic {
            --bg-primary: #0a0e1a;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #252a3a;
            --bg-card: #1e2332;
            --bg-modal: rgba(10, 14, 26, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #b8b8d4;
            --text-muted: #6b6b8a;
            --accent-primary: #6c5ce7;
            --accent-secondary: #fdcb6e;
            --accent-success: #00b894;
            --accent-danger: #d63031;
            --accent-warning: #fdcb6e;
            --accent-info: #74b9ff;
            --gradient-primary: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            --gradient-success: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            --gradient-danger: linear-gradient(135deg, #d63031 0%, #c0392b 100%);
            --gradient-warning: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            --glass-bg: rgba(30, 35, 50, 0.6);
            --glass-border: rgba(108, 92, 231, 0.3);
            --neon-glow: 0 0 20px rgba(108, 92, 231, 0.4);
            --neon-glow-pink: 0 0 20px rgba(253, 203, 110, 0.4);
        }

        body.theme-classic::before,
        body.theme-classic::after {
            display: none;
        }

        /* –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Ç–µ–º–∞ */
        body.theme-cosmic {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.theme-cosmic:root,
        body.theme-cosmic {
            --bg-primary: #0a0e27;
            --bg-secondary: #14142e;
            --bg-tertiary: #1a1a3e;
            --bg-card: rgba(26, 26, 62, 0.6);
            --bg-modal: rgba(10, 14, 39, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #b8b8d4;
            --text-muted: #6b6b8a;
            --accent-primary: #6c5ce7;
            --accent-secondary: #fdcb6e;
            --accent-success: #00b894;
            --accent-danger: #d63031;
            --accent-warning: #fdcb6e;
            --accent-info: #74b9ff;
            --gradient-primary: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 50%, #fdcb6e 100%);
            --gradient-success: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            --gradient-danger: linear-gradient(135deg, #d63031 0%, #c0392b 100%);
            --gradient-warning: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            --glass-bg: rgba(26, 26, 62, 0.4);
            --glass-border: rgba(108, 92, 231, 0.3);
            --neon-glow: 0 0 20px rgba(108, 92, 231, 0.4), 0 0 40px rgba(108, 92, 231, 0.2);
            --neon-glow-pink: 0 0 20px rgba(253, 203, 110, 0.4), 0 0 40px rgba(253, 203, 110, 0.2);
        }

        body.theme-cosmic::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(108, 92, 231, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(253, 203, 110, 0.2), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 200%, 150% 150%, 100% 100%;
            animation: starField 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes starField {
            0% { background-position: 0% 0%, 0% 0%, 0% 0%; }
            100% { background-position: 100% 100%, 50% 50%, 25% 25%; }
        }

        body.theme-cosmic::after {
            display: none;
        }

        body.theme-cosmic header {
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(108, 92, 231, 0.3);
            box-shadow: 0 8px 32px rgba(108, 92, 231, 0.2);
        }

        body.theme-cosmic .design-menu {
            z-index: 99999 !important;
            overflow: visible !important;
            position: fixed !important;
        }

        body.theme-cosmic .design-menu.active {
            display: block !important;
        }

        .cosmic-menu-portal {
            position: fixed !important;
            z-index: 99999 !important;
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid var(--accent-primary) !important;
            box-shadow: var(--neon-glow) !important;
            min-width: 200px !important;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid var(--glass-border);
            border-top: 2px solid var(--accent-primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== –¢–ï–ú–´ ========== */
        
        /* –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ç–µ–º–∞ */
        body.theme-classic {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.theme-classic:root,
        body.theme-classic {
            --bg-primary: #0a0e1a;
            --bg-secondary: #1a1f2e;
            --bg-tertiary: #252a3a;
            --bg-card: #1e2332;
            --bg-modal: rgba(10, 14, 26, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #b8b8d4;
            --text-muted: #6b6b8a;
            --accent-primary: #6c5ce7;
            --accent-secondary: #fdcb6e;
            --accent-success: #00b894;
            --accent-danger: #d63031;
            --accent-warning: #fdcb6e;
            --accent-info: #74b9ff;
            --gradient-primary: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            --gradient-success: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            --gradient-danger: linear-gradient(135deg, #d63031 0%, #c0392b 100%);
            --gradient-warning: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            --glass-bg: rgba(30, 35, 50, 0.6);
            --glass-border: rgba(108, 92, 231, 0.3);
            --neon-glow: 0 0 20px rgba(108, 92, 231, 0.4);
            --neon-glow-pink: 0 0 20px rgba(253, 203, 110, 0.4);
        }

        body.theme-classic::before,
        body.theme-classic::after {
            display: none;
        }

        /* –ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Ç–µ–º–∞ */
        body.theme-cosmic {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.theme-cosmic:root,
        body.theme-cosmic {
            --bg-primary: #0a0e27;
            --bg-secondary: #14142e;
            --bg-tertiary: #1a1a3e;
            --bg-card: rgba(26, 26, 62, 0.6);
            --bg-modal: rgba(10, 14, 39, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #b8b8d4;
            --text-muted: #6b6b8a;
            --accent-primary: #6c5ce7;
            --accent-secondary: #fdcb6e;
            --accent-success: #00b894;
            --accent-danger: #d63031;
            --accent-warning: #fdcb6e;
            --accent-info: #74b9ff;
            --gradient-primary: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 50%, #fdcb6e 100%);
            --gradient-success: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            --gradient-danger: linear-gradient(135deg, #d63031 0%, #c0392b 100%);
            --gradient-warning: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            --glass-bg: rgba(26, 26, 62, 0.4);
            --glass-border: rgba(108, 92, 231, 0.3);
            --neon-glow: 0 0 20px rgba(108, 92, 231, 0.4), 0 0 40px rgba(108, 92, 231, 0.2);
            --neon-glow-pink: 0 0 20px rgba(253, 203, 110, 0.4), 0 0 40px rgba(253, 203, 110, 0.2);
        }

        body.theme-cosmic::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20% 30%, rgba(108, 92, 231, 0.3), transparent),
                radial-gradient(2px 2px at 60% 70%, rgba(253, 203, 110, 0.2), transparent),
                radial-gradient(1px 1px at 50% 50%, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 200%, 150% 150%, 100% 100%;
            animation: starField 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes starField {
            0% { background-position: 0% 0%, 0% 0%, 0% 0%; }
            100% { background-position: 100% 100%, 50% 50%, 25% 25%; }
        }

        body.theme-cosmic::after {
            display: none;
        }

        body.theme-cosmic header {
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(108, 92, 231, 0.3);
            box-shadow: 0 8px 32px rgba(108, 92, 231, 0.2);
        }

        body.theme-cosmic .design-menu {
            z-index: 99999 !important;
            overflow: visible !important;
            position: fixed !important;
        }

        body.theme-cosmic .design-menu.active {
            display: block !important;
        }

        .cosmic-menu-portal {
            position: fixed !important;
            z-index: 99999 !important;
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid var(--accent-primary) !important;
            box-shadow: var(--neon-glow) !important;
            min-width: 200px !important;
        }
    </style>
</head>
<body class="theme-cosmic">
    <header>
        <div class="header-inner">
            <div class="logo-container">
                <div class="logo">
                    <svg viewBox="0 0 100 100" width="52" height="52">
                        <defs>
                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#00ff99"/>
                                <stop offset="100%" stop-color="#ff00ff"/>
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <circle cx="50" cy="50" r="45" stroke="url(#logoGradient)" stroke-width="2" fill="none" filter="url(#glow)"/>
                        <path d="M30 70 L70 30 M30 30 L70 70" stroke="url(#logoGradient)" stroke-width="2" filter="url(#glow)"/>
                    </svg>
                </div>
                <h1>OwnedCore</h1>
            </div>
            <div class="header-controls">
                <nav class="nav-menu">
                    <a href="/dashboard" class="nav-item" id="nav-dashboard">–î–∞—à–±–æ—Ä–¥</a>
                    <a href="/charts" class="nav-item active" id="nav-charts">–ì—Ä–∞—Ñ–∏–∫–∏</a>
                    <a href="/signals" class="nav-item" id="nav-signals">–°–∏–≥–Ω–∞–ª—ã</a>
                    <a href="/potential-signals" class="nav-item" id="nav-potential">ES</a>
                    <a href="/demo-trading" class="nav-item" id="nav-demo">–î–µ–º–æ</a>
                    <div class="design-dropdown">
                        <button class="design-btn" onclick="toggleDesignMenu()">–î–∏–∑–∞–π–Ω</button>
                        <div class="design-menu" id="design-menu">
                            <div class="design-option" onclick="switchTheme('classic')" data-theme="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</div>
                            <div class="design-option" onclick="switchTheme('cyberpunk')" data-theme="cyberpunk">Cyberpunk</div>
                            <div class="design-option active" onclick="switchTheme('cosmic')" data-theme="cosmic">–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π</div>
                        </div>
                    </div>
                </nav>
                <button id="live-trading-toggle" class="live-toggle-btn live-on" onclick="toggleLiveTrading(event)">
                    LIVE: –í–ö–õ
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content - Three Panels -->
    <div class="charts-container">
        <!-- Left Panel: Pairs List -->
        <div class="pairs-panel">
            <div class="pairs-panel-header">
                <h2>–¢–æ—Ä–≥–æ–≤—ã–µ –ø–∞—Ä—ã</h2>
                <input type="text" class="pairs-search" id="pairs-search" placeholder="–ü–æ–∏—Å–∫ –ø–∞—Ä—ã...">
            </div>
            <div class="pairs-list" id="pairs-list">
                <div class="chart-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä...</div>
            </div>
        </div>

        <!-- Center Panel: Chart -->
        <div class="chart-panel">
            <div class="chart-header">
                <div class="chart-title" id="chart-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—É</div>
                <div class="chart-controls">
                    <div class="timeframe-selector">
                        <button class="timeframe-btn" data-tf="15m">15m</button>
                        <button class="timeframe-btn active" data-tf="1h">1h</button>
                        <button class="timeframe-btn" data-tf="4h">4h</button>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <div id="chart"></div>
                <div class="chart-loading" id="chart-loading">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</div>
            </div>
        </div>

        <!-- Right Panel: Pair Info -->
        <div class="info-panel">
            <div class="info-section">
                <div class="info-section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä–µ</div>
                <div id="pair-info">
                    <div class="info-item">
                        <span class="info-item-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—É</span>
                    </div>
                </div>
            </div>
            <div class="info-section">
                <div class="info-section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ —É—Ä–æ–≤–Ω–∏</div>
                <div class="levels-list" id="levels-list">
                </div>
            </div>
            <div class="info-section">
                <div class="info-section-title">–¶–µ–Ω–æ–≤—ã–µ —Ñ–∏–≥—É—Ä—ã</div>
                <div class="levels-list" id="chart-patterns-list">
                    <div style="color: var(--text-muted); font-size: 0.9rem;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
            </div>
            <div class="info-section info-section-compact">
                <div class="info-section-title">–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                <div class="info-item">
                    <span class="info-item-label">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                    <span class="info-item-value" id="last-update">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const serverPort = 8000;
        const baseUrl = `http://localhost:${serverPort}`;
        
        // State
        let currentPair = null;
        let currentTimeframe = '1h';
        let chart = null;
        let candlestickSeries = null;
        let levelLineSeries = []; // –•—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫–∏ –Ω–∞ line series –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
        let patternLineSeries = []; // –•—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫–∏ –Ω–∞ line series –¥–ª—è —Ñ–∏–≥—É—Ä
        let pairsData = {};
        let liveTradingEnabled = true;
        let chartUpdateInterval = null;
        let pairsUpdateInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é cosmic)
            const savedTheme = localStorage.getItem('selectedTheme') || 'cosmic';
            if (savedTheme) {
                document.body.className = `theme-${savedTheme}`;
                document.querySelectorAll('.design-option').forEach(option => {
                    option.classList.toggle('active', option.dataset.theme === savedTheme);
                });
            }
            
            fetchLiveTradingStatus();
            loadPairsList();
            setupEventListeners();
            
            // Auto-update pairs list every 5 minutes
            pairsUpdateInterval = setInterval(loadPairsList, 5 * 60 * 1000);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—é –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –¥–ª—è –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —Ç–µ–º—ã
            document.addEventListener('scroll', function() {
                const cosmicMenu = document.getElementById('design-menu-cosmic');
                const dropdown = document.querySelector('.design-dropdown');
                
                if (cosmicMenu && dropdown) {
                    const rect = dropdown.getBoundingClientRect();
                    cosmicMenu.style.top = (rect.bottom + 8) + 'px';
                    cosmicMenu.style.right = (window.innerWidth - rect.right) + 'px';
                }
            }, true);
        });

        // Event Listeners
        function setupEventListeners() {
            // Timeframe selector
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tf = e.target.dataset.tf;
                    if (tf && currentPair) {
                        switchTimeframe(tf);
                    }
                });
            });

            // Search
            const searchInput = document.getElementById('pairs-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterPairs(e.target.value);
                });
            }
        }

        // Load Pairs List
        async function loadPairsList() {
            try {
                const response = await fetch(`${baseUrl}/api/pairs-status`);
                const data = await response.json();
                
                if (data.status === 'success' && data.results) {
                    pairsData = data.results;
                    renderPairsList(data.results);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–∞—Ä:', error);
            }
        }

        function renderPairsList(pairs) {
            const container = document.getElementById('pairs-list');
            if (!container) return;

            if (!pairs || Object.keys(pairs).length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞—Ä</div>';
                return;
            }

            const pairsArray = Object.entries(pairs).sort((a, b) => {
                // Sort by symbol
                return a[0].localeCompare(b[0]);
            });

            container.innerHTML = pairsArray.map(([symbol, data]) => {
                const isActive = currentPair === symbol;
                const priceChange = data.price_change_24h || 0;
                const volume = data.volume_24h || 0;
                const levelsCount = data.active_levels || 0;
                
                return `
                    <div class="pair-item ${isActive ? 'active' : ''}" data-pair="${symbol}" onclick="selectPair('${symbol}')">
                        <div class="pair-item-header">
                            <span class="pair-symbol">${symbol}</span>
                            <span class="pair-price">$${formatPrice(data.current_price || 0)}</span>
                        </div>
                        <div class="pair-stats">
                            <div class="pair-stat">
                                <span class="pair-stat-label">24—á</span>
                                <span class="pair-stat-value ${priceChange >= 0 ? 'positive' : 'negative'}">
                                    ${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%
                                </span>
                            </div>
                            <div class="pair-stat">
                                <span class="pair-stat-label">–û–±—ä–µ–º</span>
                                <span class="pair-stat-value">${volume.toFixed(1)}M</span>
                            </div>
                            <div class="pair-stat">
                                <span class="pair-stat-label">–£—Ä–æ–≤–Ω–∏</span>
                                <span class="pair-stat-value">${levelsCount}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterPairs(query) {
            const items = document.querySelectorAll('.pair-item');
            const lowerQuery = query.toLowerCase();
            
            items.forEach(item => {
                const symbol = item.dataset.pair.toLowerCase();
                if (symbol.includes(lowerQuery)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
        function clearChart() {
            try {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (chartUpdateInterval) {
                    clearInterval(chartUpdateInterval);
                    chartUpdateInterval = null;
                }
                
                // –û—á–∏—â–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º —Å–µ—Ä–∏–π
                if (candlestickSeries && typeof candlestickSeries.setMarkers === 'function') {
                    try {
                        candlestickSeries.setMarkers([]);
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                    }
                }
                
                // –û—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                window.signalMarkers = [];
                window.allChartMarkers = [];
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–µ—Ä–∏–∏ —É—Ä–æ–≤–Ω–µ–π
                if (levelLineSeries && Array.isArray(levelLineSeries)) {
                    levelLineSeries.forEach(series => {
                        try {
                            if (chart && series && typeof chart.removeSeries === 'function') {
                                chart.removeSeries(series);
                            }
                        } catch (e) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - —Å–µ—Ä–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞
                        }
                    });
                    levelLineSeries = [];
                }
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–µ—Ä–∏–∏ —Ñ–∏–≥—É—Ä
                if (patternLineSeries && Array.isArray(patternLineSeries)) {
                    patternLineSeries.forEach(series => {
                        try {
                            if (chart && series && typeof chart.removeSeries === 'function') {
                                chart.removeSeries(series);
                            }
                        } catch (e) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ - —Å–µ—Ä–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞
                        }
                    });
                    patternLineSeries = [];
                }
                
                // –£–¥–∞–ª—è–µ–º —Å–µ—Ä–∏—é —Å–≤–µ—á–µ–π
                if (candlestickSeries && chart) {
                    try {
                        if (typeof chart.removeSeries === 'function') {
                            chart.removeSeries(candlestickSeries);
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                    }
                    candlestickSeries = null;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞:', e);
            }
        }

        // Select Pair
        async function selectPair(pairSymbol) {
            if (currentPair === pairSymbol) return;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
            clearChart();
            
            currentPair = pairSymbol;
            
            // Update UI
            document.querySelectorAll('.pair-item').forEach(item => {
                item.classList.toggle('active', item.dataset.pair === pairSymbol);
            });
            
            document.getElementById('chart-title').textContent = `${pairSymbol} - ${currentTimeframe}`;
            
            // Load chart data
            try {
                await loadChartData(pairSymbol, currentTimeframe);
                startChartAutoUpdate();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
            }
            
            // Load pair info
            try {
                await loadPairInfo(pairSymbol);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞—Ä–µ:', error);
            }
        }

        // Switch Timeframe
        async function switchTimeframe(tf) {
            if (currentTimeframe === tf || !currentPair) return;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
            clearChart();
            
            currentTimeframe = tf;
            
            // Update UI
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tf === tf);
            });
            
            document.getElementById('chart-title').textContent = `${currentPair} - ${tf}`;
            
            // Reload chart
            try {
                await loadChartData(currentPair, tf);
                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
                startChartAutoUpdate();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞:', error);
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
            }
        }

        // Load Chart Data
        async function loadChartData(pair, timeframe) {
            const loadingEl = document.getElementById('chart-loading');
            if (loadingEl) {
                loadingEl.style.display = 'block';
                loadingEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞...';
            }

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞ –∏ —Ü–µ–Ω–æ–≤—ã–µ —Ñ–∏–≥—É—Ä—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                try {
                    const [chartResponse, patternsResponse, signalsResponse] = await Promise.all([
                        fetch(`${baseUrl}/api/chart-data?pair=${encodeURIComponent(pair)}&timeframe=${timeframe}`, {
                            signal: controller.signal
                        }),
                        fetch(`${baseUrl}/api/chart-patterns?symbol=${encodeURIComponent(pair)}&timeframe=${timeframe}&is_active=true&limit=50`, {
                            signal: controller.signal
                        }),
                        fetch(`${baseUrl}/api/signals-by-pair?pair=${encodeURIComponent(pair)}`, {
                            signal: controller.signal
                        })
                    ]);
                    
                    clearTimeout(timeoutId);
                    
                    if (!chartResponse.ok) {
                        throw new Error(`HTTP error! status: ${chartResponse.status}`);
                    }
                    if (!patternsResponse.ok) {
                        throw new Error(`HTTP error! status: ${patternsResponse.status}`);
                    }
                    // –°–∏–≥–Ω–∞–ª—ã –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å, —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
                    let signalsData = { success: false, signals: [] };
                    if (signalsResponse.ok) {
                        try {
                            signalsData = await signalsResponse.json();
                        } catch (e) {
                            console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤:', e);
                            signalsData = { success: false, signals: [] };
                        }
                    } else {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã: HTTP ${signalsResponse.status}`);
                    }
                    
                    const chartData = await chartResponse.json();
                    const patternsData = await patternsResponse.json();
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    console.log('üìä Chart data:', chartData.success, chartData.candles?.length || 0, 'candles');
                    console.log('üìà Patterns data:', patternsData.success, patternsData.patterns?.length || 0, 'patterns');
                    console.log('üìä Signals data:', signalsData.success, signalsData.signals?.length || 0, 'signals');
                    
                    if (chartData.success && chartData.candles) {
                        const chartPatterns = patternsData.success ? (patternsData.patterns || []) : [];
                        const signals = signalsData.success ? (signalsData.signals || []) : [];
                        console.log('üéØ Rendering chart with', chartPatterns.length, 'patterns and', signals.length, 'signals');
                        
                        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏ –≥—Ä–∞—Ñ–∏–∫–∞
                        if (chartData.candles && chartData.candles.length > 0) {
                            const lastCandle = chartData.candles[chartData.candles.length - 1];
                            const currentPriceFromChart = lastCandle.close || lastCandle[4] || 0;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –≤ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—ã
                            if (pairsData[pair]) {
                                pairsData[pair].current_price = currentPriceFromChart;
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –≤ –ª–µ–≤–æ–º –∏ –ø—Ä–∞–≤–æ–º –±–ª–æ–∫–∞—Ö
                            updateCurrentPriceDisplay(pair, currentPriceFromChart);
                        }
                        
                        renderChart(chartData.candles, chartData.levels || [], chartPatterns, signals);
                        if (loadingEl) loadingEl.style.display = 'none';
                        
                        // Update last update time
                        document.getElementById('last-update').textContent = new Date().toLocaleTimeString('ru-RU');
                    } else {
                        if (loadingEl) {
                            loadingEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                            loadingEl.style.color = 'var(--accent-danger)';
                        }
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    }
                    throw fetchError;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
                if (chart && !candlestickSeries) {
                    try {
                        const chartContainer = document.getElementById('chart');
                        if (chartContainer) {
                            chart.remove();
                            chart = null;
                        }
                    } catch (e) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', e);
                    }
                }
            }
        }

        // Render Chart
        function renderChart(candles, levels, chartPatterns = [], signals = []) {
            console.log('üéØ renderChart –≤—ã–∑–≤–∞–Ω —Å:', {
                candlesCount: candles?.length || 0,
                levelsCount: levels?.length || 0,
                patternsCount: chartPatterns?.length || 0,
                signalsCount: signals?.length || 0
            });
            
            // –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ candles - —ç—Ç–æ –º–∞—Å—Å–∏–≤
            if (!Array.isArray(candles)) {
                console.error('renderChart: candles –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', typeof candles, candles);
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º null/undefined —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –º–∞—Å—Å–∏–≤–∞ candles
            candles = candles.filter(c => c != null && typeof c === 'object');
            
            if (candles.length === 0) {
                console.error('renderChart: –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–≤–µ—á–µ–π');
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                return;
            }
            const chartContainer = document.getElementById('chart');
            if (!chartContainer) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (!candles || !Array.isArray(candles) || candles.length === 0) {
                console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ—á–µ–π:', candles);
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                return;
            }

            // Initialize chart if not exists
            if (!chart) {
                chart = LightweightCharts.createChart(chartContainer, {
                    layout: {
                        background: { color: '#000000' },
                        textColor: '#00ff41',
                    },
                    grid: {
                        vertLines: { color: 'rgba(0, 255, 65, 0.1)' },
                        horzLines: { color: 'rgba(0, 255, 65, 0.1)' },
                    },
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });
                
                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–ª—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
                // –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–≥, –∫–æ–≥–¥–∞ –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–æ–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞
                chart.timeScale().subscribeVisibleTimeRangeChange(() => {
                    // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                    if (candlestickSeries && window.allChartMarkers && window.allChartMarkers.length > 0) {
                        try {
                            candlestickSeries.setMarkers(window.allChartMarkers);
                        } catch (e) {
                            console.warn('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ:', e);
                        }
                    }
                });
            }

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞)
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–∏—è –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –≥—Ä–∞—Ñ–∏–∫–µ
            if (candlestickSeries) {
                try {
                    // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                    if (candlestickSeries && typeof candlestickSeries.setData === 'function') {
                        try {
                            candlestickSeries.setData([]);
                        } catch (e) {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—á–∏—Å—Ç–∫–∏
                        }
                    }
                    
                    // –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º —Å–µ—Ä–∏—é
                    if (chart && typeof chart.removeSeries === 'function') {
                        chart.removeSeries(candlestickSeries);
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è - —Å–µ—Ä–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞
                    // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∫–æ–Ω—Å–æ–ª—å
                } finally {
                    // –í—Å–µ–≥–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É, –¥–∞–∂–µ –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
                    candlestickSeries = null;
                }
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é candlestick series
            candlestickSeries = chart.addCandlestickSeries({
                upColor: '#00ff41',
                downColor: '#ff006e',
                borderVisible: false,
                wickUpColor: '#00ff41',
                wickDownColor: '#ff006e',
            });

            // Convert candles to chart format –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const chartData = candles
                .map((c, index) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å–≤–µ—á–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    if (!c || typeof c !== 'object') {
                        console.warn(`–°–≤–µ—á–∞ ${index} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º:`, c);
                        return null;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–∞–ª–∏–¥–Ω—ã
                    let timestamp = c.timestamp;
                    let open = c.open;
                    let high = c.high;
                    let low = c.low;
                    let close = c.close;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                    if (timestamp === null || timestamp === undefined ||
                        open === null || open === undefined ||
                        high === null || high === undefined ||
                        low === null || low === undefined ||
                        close === null || close === undefined) {
                        console.warn(`–°–≤–µ—á–∞ ${index} —Å–æ–¥–µ—Ä–∂–∏—Ç null/undefined –∑–Ω–∞—á–µ–Ω–∏—è:`, c);
                        return null;
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–∞
                    open = Number(open);
                    high = Number(high);
                    low = Number(low);
                    close = Number(close);
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º timestamp (–º–æ–∂–µ—Ç –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π)
                    if (typeof timestamp === 'string') {
                        const dateObj = new Date(timestamp);
                        if (isNaN(dateObj.getTime())) {
                            console.warn(`–°–≤–µ—á–∞ ${index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π timestamp (—Å—Ç—Ä–æ–∫–∞):`, timestamp);
                            return null;
                        }
                        timestamp = dateObj.getTime();
                    } else if (typeof timestamp === 'number') {
                        // –ï—Å–ª–∏ timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö (–±–æ–ª—å—à–µ 1e12), –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        // –ï—Å–ª–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–º–µ–Ω—å—à–µ 1e12), —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 1000
                        if (timestamp < 1e12) {
                            timestamp = timestamp * 1000;
                        }
                    } else {
                        console.warn(`–°–≤–µ—á–∞ ${index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø timestamp:`, typeof timestamp, timestamp);
                        return null;
                    }
                    
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–µ—á–∏ —Å null, undefined –∏–ª–∏ NaN –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    if (!timestamp || isNaN(timestamp) || !isFinite(timestamp) ||
                        isNaN(open) || !isFinite(open) ||
                        isNaN(high) || !isFinite(high) || 
                        isNaN(low) || !isFinite(low) || 
                        isNaN(close) || !isFinite(close)) {
                        console.warn(`–°–≤–µ—á–∞ ${index}: —Å–æ–¥–µ—Ä–∂–∏—Ç NaN –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:`, { timestamp, open, high, low, close });
                        return null;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É OHLC (high >= low, high >= open, high >= close, low <= open, low <= close)
                    if (high < low || high < open || high < close || low > open || low > close) {
                        console.warn(`–°–≤–µ—á–∞ ${index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ OHLC:`, { open, high, low, close });
                        return null;
                    }
                    
                    const timeValue = Math.floor(timestamp / 1000);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ time –≤–∞–ª–∏–¥–µ–Ω
                    if (!timeValue || isNaN(timeValue) || !isFinite(timeValue) || timeValue <= 0) {
                        console.warn(`–°–≤–µ—á–∞ ${index}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π timeValue:`, timeValue);
                        return null;
                    }
                    
                    return {
                        time: timeValue,
                        open: open,
                        high: high,
                        low: low,
                        close: close,
                    };
                })
                .filter(c => {
                    // –°–¢–†–û–ì–ê–Ø –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º
                    if (c === null || c === undefined) return false;
                    if (typeof c !== 'object') return false;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π
                    if (c.time === null || c.time === undefined || 
                        c.open === null || c.open === undefined ||
                        c.high === null || c.high === undefined ||
                        c.low === null || c.low === undefined ||
                        c.close === null || c.close === undefined) {
                        return false;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π
                    if (!isFinite(c.time) || c.time <= 0) return false;
                    if (!isFinite(c.open) || c.open <= 0) return false;
                    if (!isFinite(c.high) || c.high <= 0) return false;
                    if (!isFinite(c.low) || c.low <= 0) return false;
                    if (!isFinite(c.close) || c.close <= 0) return false;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É OHLC –µ—â–µ —Ä–∞–∑
                    if (c.high < c.low || c.high < c.open || c.high < c.close || 
                        c.low > c.open || c.low > c.close) {
                        return false;
                    }
                    
                    return true;
                });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (!chartData || chartData.length === 0) {
                console.error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                return;
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Å–≤–µ—á–∏ –≤–∞–ª–∏–¥–Ω—ã
            const validChartData = chartData.filter(c => {
                return c && 
                       c.time && 
                       isFinite(c.time) && 
                       c.time > 0 &&
                       c.open !== null && 
                       c.open !== undefined && 
                       isFinite(c.open) &&
                       c.high !== null && 
                       c.high !== undefined && 
                       isFinite(c.high) &&
                       c.low !== null && 
                       c.low !== undefined && 
                       isFinite(c.low) &&
                       c.close !== null && 
                       c.close !== undefined && 
                       isFinite(c.close);
            });

            if (validChartData.length === 0) {
                console.error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏');
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                return;
            }

            // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ –≥—Ä–∞—Ñ–∏–∫
            const finalValidData = validChartData.filter(c => {
                if (!c || typeof c !== 'object') return false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø–æ–ª—è –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
                const time = c.time;
                const open = c.open;
                const high = c.high;
                const low = c.low;
                const close = c.close;
                
                // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏ –∏ –∫–æ–Ω–µ—á–Ω—ã–º–∏
                return time !== null && 
                       time !== undefined && 
                       typeof time === 'number' &&
                       isFinite(time) && 
                       time > 0 &&
                       open !== null && 
                       open !== undefined && 
                       typeof open === 'number' &&
                       isFinite(open) &&
                       high !== null && 
                       high !== undefined && 
                       typeof high === 'number' &&
                       isFinite(high) &&
                       low !== null && 
                       low !== undefined && 
                       typeof low === 'number' &&
                       isFinite(low) &&
                       close !== null && 
                       close !== undefined && 
                       typeof close === 'number' &&
                       isFinite(close) &&
                       // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ OHLC
                       high >= low &&
                       high >= open &&
                       high >= close &&
                       low <= open &&
                       low <= close;
            });

            if (finalValidData.length === 0) {
                console.error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏');
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                return;
            }

            // Set data - –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ candlestickSeries —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!candlestickSeries) {
                console.error('candlestickSeries –Ω–µ —Å–æ–∑–¥–∞–Ω–∞');
                return;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–ª–∏–¥–Ω—ã
            // –û–±—ä—è–≤–ª—è–µ–º safeData –∏ monotonicData –≤–Ω–µ try, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —É—Ä–æ–≤–Ω–µ–π –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
            let safeData = null;
            let monotonicData = null;
            
            try {
                // –°–¢–†–û–ì–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø: –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                safeData = finalValidData
                    .map((c, idx) => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        if (!c || typeof c !== 'object') {
                            return null;
                        }
                        
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ null/undefined –ü–ï–†–ï–î –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º
                        if (c.time === null || c.time === undefined ||
                            c.open === null || c.open === undefined ||
                            c.high === null || c.high === undefined ||
                            c.low === null || c.low === undefined ||
                            c.close === null || c.close === undefined) {
                            console.error(`safeData: –∑–∞–ø–∏—Å—å ${idx} —Å–æ–¥–µ—Ä–∂–∏—Ç null/undefined –∑–Ω–∞—á–µ–Ω–∏—è:`, c);
                            return null;
                        }
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–∏—Å–ª–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                        const time = Number(c.time);
                        const open = Number(c.open);
                        const high = Number(c.high);
                        const low = Number(c.low);
                        const close = Number(c.close);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ (–Ω–µ NaN, –Ω–µ Infinity)
                        if (isNaN(time) || !isFinite(time) || time <= 0 ||
                            isNaN(open) || !isFinite(open) || open <= 0 ||
                            isNaN(high) || !isFinite(high) || high <= 0 ||
                            isNaN(low) || !isFinite(low) || low <= 0 ||
                            isNaN(close) || !isFinite(close) || close <= 0) {
                            console.error(`safeData: –∑–∞–ø–∏—Å—å ${idx} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:`, {time, open, high, low, close});
                            return null;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É OHLC
                        if (high < low || high < open || high < close || low > open || low > close) {
                            return null;
                        }
                        
                        return { time, open, high, low, close };
                    })
                    .filter(c => c !== null); // –£–¥–∞–ª—è–µ–º –≤—Å–µ null –∑–∞–ø–∏—Å–∏
                
                if (!safeData || safeData.length === 0) {
                    console.error('–ù–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏');
                    const loadingEl = document.getElementById('chart-loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'block';
                        loadingEl.textContent = '–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
                        loadingEl.style.color = 'var(--accent-danger)';
                    }
                    return;
                }
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ø–µ—Ä–µ–¥ setData: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ safeData –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç null
                const finalSafeData = safeData.filter((c, idx) => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º
                    if (!c || typeof c !== 'object') {
                        console.error(`finalSafeData: –∑–∞–ø–∏—Å—å ${idx} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º:`, c);
                        return false;
                    }
                    
                    // –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null/undefined
                    if (c.time === null || c.time === undefined ||
                        c.open === null || c.open === undefined ||
                        c.high === null || c.high === undefined ||
                        c.low === null || c.low === undefined ||
                        c.close === null || c.close === undefined) {
                        console.error(`finalSafeData: –∑–∞–ø–∏—Å—å ${idx} —Å–æ–¥–µ—Ä–∂–∏—Ç null/undefined:`, c);
                        return false;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
                    const time = Number(c.time);
                    const open = Number(c.open);
                    const high = Number(c.high);
                    const low = Number(c.low);
                    const close = Number(c.close);
                    
                    const isValid = !isNaN(time) && isFinite(time) && time > 0 &&
                                   !isNaN(open) && isFinite(open) && open > 0 &&
                                   !isNaN(high) && isFinite(high) && high > 0 &&
                                   !isNaN(low) && isFinite(low) && low > 0 &&
                                   !isNaN(close) && isFinite(close) && close > 0 &&
                                   high >= low && high >= open && high >= close &&
                                   low <= open && low <= close;
                    
                    if (!isValid) {
                        console.error(`finalSafeData: –∑–∞–ø–∏—Å—å ${idx} –Ω–µ –ø—Ä–æ—à–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é:`, {time, open, high, low, close, original: c});
                    }
                    
                    return isValid;
                });
                
                if (finalSafeData.length === 0) {
                    console.error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏. –ò—Å—Ö–æ–¥–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', safeData.length);
                    const loadingEl = document.getElementById('chart-loading');
                    if (loadingEl) {
                        loadingEl.style.display = 'block';
                        loadingEl.textContent = '–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
                        loadingEl.style.color = 'var(--accent-danger)';
                    }
                    return;
                }
                
                // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —á–∏—Å–ª–∞
                const ultraSafeData = finalSafeData.map((c, idx) => {
                    return {
                        time: Math.floor(Number(c.time)),
                        open: Number(c.open),
                        high: Number(c.high),
                        low: Number(c.low),
                        close: Number(c.close)
                    };
                }).filter((c, idx) => {
                    const isValid = isFinite(c.time) && c.time > 0 &&
                                   isFinite(c.open) && c.open > 0 &&
                                   isFinite(c.high) && c.high > 0 &&
                                   isFinite(c.low) && c.low > 0 &&
                                   isFinite(c.close) && c.close > 0;
                    
                    if (!isValid) {
                        console.error(`ultraSafeData: –∑–∞–ø–∏—Å—å ${idx} –Ω–µ –ø—Ä–æ—à–ª–∞ —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:`, c);
                    }
                    
                    return isValid;
                });
                
                if (ultraSafeData.length === 0) {
                    console.error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ ultra-–ø—Ä–æ–≤–µ—Ä–∫–∏');
                    return;
                }
                
                // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ time –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –≤—Ä–µ–º–µ–Ω–∏
                const seenTimes = new Set();
                const dedupedData = [];
                for (const c of ultraSafeData) {
                    if (!seenTimes.has(c.time)) {
                        seenTimes.add(c.time);
                        dedupedData.push(c);
                    }
                }
                dedupedData.sort((a, b) => a.time - b.time);
                // –£–±–∏—Ä–∞–µ–º –Ω–µ—Å—Ç—Ä–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–∏–µ —Ç–æ—á–∫–∏ (LightweightCharts —Ç—Ä–µ–±—É–µ—Ç —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ—Å—Ç–∏)
                monotonicData = [];
                for (let i = 0; i < dedupedData.length; i++) {
                    if (i === 0 || dedupedData[i].time > dedupedData[i - 1].time) {
                        monotonicData.push(dedupedData[i]);
                    } else {
                        console.warn('–£–¥–∞–ª–µ–Ω–∞ –Ω–µ –º–æ–Ω–æ—Ç–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞', dedupedData[i]);
                    }
                }
                
                if (monotonicData.length === 0) {
                    console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏/–º–æ–Ω–æ—Ç–æ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏');
                    return;
                }
                
                // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log(`–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ${monotonicData.length} –≤–∞–ª–∏–¥–Ω—ã—Ö —Å–≤–µ—á–µ–π. –ü–µ—Ä–≤—ã–µ 3:`, monotonicData.slice(0, 3));
                
                try {
                    candlestickSeries.setData(monotonicData);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
                    window.signalMarkers = [];
                    if (signals && Array.isArray(signals) && signals.length > 0 && monotonicData.length > 0) {
                        console.log(`üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${signals.length} —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤`);
                        console.log(`üìä –î–æ—Å—Ç—É–ø–Ω–æ ${monotonicData.length} —Å–≤–µ—á–µ–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ`);
                        console.log(`üìÖ –î–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ —Å–≤–µ—á–µ–π: ${monotonicData[0]?.time} - ${monotonicData[monotonicData.length - 1]?.time}`);
                        
                        let processedCount = 0;
                        let entryMarkersCount = 0;
                        let exitMarkersCount = 0;
                        
                        signals.forEach((signal, idx) => {
                            if (!signal || typeof signal !== 'object') {
                                console.warn(`–°–∏–≥–Ω–∞–ª ${idx} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º:`, signal);
                                return;
                            }
                            
                            const entryTimestamp = signal.timestamp || signal.created_at;
                            const exitTimestamp = signal.exit_timestamp || signal.closed_at;
                            const entryPrice = signal.entry_price || signal.level_price;
                            const exitPrice = signal.exit_price;
                            const signalType = signal.signal_type; // LONG –∏–ª–∏ SHORT
                            const pnlPercent = signal.pnl_percent || 0;
                            
                            if (!entryTimestamp || !entryPrice) {
                                console.warn(`–°–∏–≥–Ω–∞–ª ${idx} –Ω–µ –∏–º–µ–µ—Ç entryTimestamp –∏–ª–∏ entryPrice:`, { entryTimestamp, entryPrice });
                                return;
                            }
                            
                            processedCount++;
                            
                            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º timestamp –≤ —Å–µ–∫—É–Ω–¥—ã (LightweightCharts —Ñ–æ—Ä–º–∞—Ç)
                            let entryTime;
                            try {
                                if (typeof entryTimestamp === 'string') {
                                    entryTime = Math.floor(new Date(entryTimestamp).getTime() / 1000);
                                } else if (typeof entryTimestamp === 'number') {
                                    entryTime = entryTimestamp < 1e12 ? entryTimestamp : Math.floor(entryTimestamp / 1000);
                                } else {
                                    console.warn(`–°–∏–≥–Ω–∞–ª ${idx}: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø entryTimestamp:`, typeof entryTimestamp);
                                    return;
                                }
                            } catch (e) {
                                console.warn(`–°–∏–≥–Ω–∞–ª ${idx}: –æ—à–∏–±–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è entryTimestamp:`, e);
                                return;
                            }
                            
                            // –ù–∞—Ö–æ–¥–∏–º —Å–≤–µ—á—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª –æ—Ç–∫—Ä—ã—Ç —Å–∏–≥–Ω–∞–ª
                            // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –ø–æ—Ç–æ–º –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 2 —á–∞—Å–æ–≤
                            let entryCandle = monotonicData.find(c => c.time === entryTime);
                            if (!entryCandle) {
                                entryCandle = monotonicData.find(c => Math.abs(c.time - entryTime) < 7200); // –í –ø—Ä–µ–¥–µ–ª–∞—Ö 2 —á–∞—Å–æ–≤
                            }
                            
                            if (entryCandle) {
                                // –ú–∞—Ä–∫–µ—Ä –≤—Ö–æ–¥–∞ - –º–∞–ª–µ–Ω—å–∫–∏–µ —Å—Ç—Ä–µ–ª–∫–∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
                                const entryColor = signalType === 'LONG' ? '#00ff41' : '#ff006e';
                                const entryShape = signalType === 'LONG' ? 'arrowUp' : 'arrowDown';
                                
                                window.signalMarkers.push({
                                    time: entryCandle.time,
                                    position: 'inBar', // –í–Ω—É—Ç—Ä–∏ —Å–≤–µ—á–∏
                                    color: entryColor,
                                    shape: entryShape,
                                    text: '', // –ë–µ–∑ —Ç–µ–∫—Å—Ç–∞
                                    size: 1 // –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä (–±—ã–ª–æ 2)
                                });
                                entryMarkersCount++;
                            } else {
                                console.warn(`–°–∏–≥–Ω–∞–ª ${idx}: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Å–≤–µ—á–∞ –¥–ª—è –≤—Ö–æ–¥–∞. entryTime: ${entryTime}, –¥–∏–∞–ø–∞–∑–æ–Ω: ${monotonicData[0]?.time} - ${monotonicData[monotonicData.length - 1]?.time}`);
                            }
                            
                            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã—Ö–æ–¥ –∏–∑ —Å–¥–µ–ª–∫–∏
                            if (exitTimestamp && exitPrice) {
                                let exitTime;
                                try {
                                    if (typeof exitTimestamp === 'string') {
                                        exitTime = Math.floor(new Date(exitTimestamp).getTime() / 1000);
                                    } else if (typeof exitTimestamp === 'number') {
                                        exitTime = exitTimestamp < 1e12 ? exitTimestamp : Math.floor(exitTimestamp / 1000);
                                    } else {
                                        return;
                                    }
                                } catch (e) {
                                    console.warn(`–°–∏–≥–Ω–∞–ª ${idx}: –æ—à–∏–±–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è exitTimestamp:`, e);
                                    return;
                                }
                                
                                // –ù–∞—Ö–æ–¥–∏–º —Å–≤–µ—á—É, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª –∑–∞–∫—Ä—ã—Ç —Å–∏–≥–Ω–∞–ª
                                let exitCandle = monotonicData.find(c => c.time === exitTime);
                                if (!exitCandle) {
                                    exitCandle = monotonicData.find(c => Math.abs(c.time - exitTime) < 7200); // –í –ø—Ä–µ–¥–µ–ª–∞—Ö 2 —á–∞—Å–æ–≤
                                }
                                
                                if (exitCandle) {
                                    // –ú–∞—Ä–∫–µ—Ä –≤—ã—Ö–æ–¥–∞ - –ø—Ä–æ—Å—Ç–æ–π –∫—Ä—É–∂–æ–∫, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä
                                    const exitColor = pnlPercent > 0 ? '#00ff41' : pnlPercent < 0 ? '#ff006e' : '#ffff00';
                                    
                                    window.signalMarkers.push({
                                        time: exitCandle.time,
                                        position: 'inBar', // –í–Ω—É—Ç—Ä–∏ —Å–≤–µ—á–∏
                                        color: exitColor,
                                        shape: 'circle',
                                        text: '', // –ë–µ–∑ —Ç–µ–∫—Å—Ç–∞
                                        size: 1 // –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä
                                    });
                                    exitMarkersCount++;
                                } else {
                                    console.warn(`–°–∏–≥–Ω–∞–ª ${idx}: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Å–≤–µ—á–∞ –¥–ª—è –≤—ã—Ö–æ–¥–∞. exitTime: ${exitTime}`);
                                }
                            }
                        });
                        
                        console.log(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedCount} —Å–∏–≥–Ω–∞–ª–æ–≤, —Å–æ–∑–¥–∞–Ω–æ ${window.signalMarkers.length} –º–∞—Ä–∫–µ—Ä–æ–≤ (${entryMarkersCount} –≤—Ö–æ–¥–æ–≤, ${exitMarkersCount} –≤—ã—Ö–æ–¥–æ–≤)`);
                    } else {
                        console.log(`‚ÑπÔ∏è –ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. signals: ${signals?.length || 0}, candles: ${monotonicData?.length || 0}`);
                    }
                } catch (e) {
                    console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ setData:', e);
                    console.error('–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–µ—Ä–≤—ã–µ 5):', monotonicData.slice(0, 5));
                    // –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ, —á—Ç–æ–±—ã –Ω–µ —Ä–æ–Ω—è—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    return;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–≤–µ—á–µ–π:', e);
                console.error('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', finalValidData.length);
                if (finalValidData.length > 0) {
                    console.error('–ü–µ—Ä–≤—ã–µ 5 –∑–∞–ø–∏—Å–µ–π:', finalValidData.slice(0, 5));
                }
                const loadingEl = document.getElementById('chart-loading');
                if (loadingEl) {
                    loadingEl.style.display = 'block';
                    loadingEl.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö';
                    loadingEl.style.color = 'var(--accent-danger)';
                }
                return;
            }
            
            // –ï—Å–ª–∏ safeData –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º finalValidData
            if (!safeData) {
                safeData = finalValidData;
            }

            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ line series –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–∏–∏ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            levelLineSeries.forEach((series, index) => {
                if (series) {
                    try {
                        // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–∏–∏
                        if (series && typeof series.setData === 'function') {
                            try {
                                series.setData([]);
                            } catch (e) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—á–∏—Å—Ç–∫–∏
                            }
                        }
                        
                        // –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º —Å–µ—Ä–∏—é
                        if (chart && typeof chart.removeSeries === 'function') {
                            chart.removeSeries(series);
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è - —Å–µ—Ä–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–∞
                        // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∫–æ–Ω—Å–æ–ª—å
                    }
                }
            });
            levelLineSeries = [];
            
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ line series –¥–ª—è —Ñ–∏–≥—É—Ä
            patternLineSeries.forEach((series, index) => {
                if (series) {
                    try {
                        if (series && typeof series.setData === 'function') {
                            try {
                                series.setData([]);
                            } catch (e) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—á–∏—Å—Ç–∫–∏
                            }
                        }
                        
                        if (chart && typeof chart.removeSeries === 'function') {
                            chart.removeSeries(series);
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                    }
                }
            });
            patternLineSeries = [];
            
            // –°–æ–∑–¥–∞–µ–º line series –¥–ª—è —É—Ä–æ–≤–Ω–µ–π, –Ω–∞—á–∏–Ω–∞—è —Å –º–æ–º–µ–Ω—Ç–∞ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º safeData (–µ—Å–ª–∏ –±—ã–ª —Å–æ–∑–¥–∞–Ω) –∏–ª–∏ finalValidData
            const dataForLevels = (safeData && safeData.length > 0) ? safeData : finalValidData;
            
            console.log('üìä –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —É—Ä–æ–≤–Ω–µ–π:', {
                levelsCount: levels?.length || 0,
                hasLevels: !!(levels && Array.isArray(levels) && levels.length > 0),
                hasData: !!(dataForLevels && dataForLevels.length > 0),
                dataLength: dataForLevels?.length || 0
            });
            
            if (levels && Array.isArray(levels) && levels.length > 0 && dataForLevels && dataForLevels.length > 0) {
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π timestamp –∏–∑ —Å–≤–µ—á–µ–π
                const lastCandleTime = dataForLevels[dataForLevels.length - 1].time;
                const firstCandleTime = dataForLevels[0].time;
                
                console.log('üìä –ù–∞—á–∞–ª–æ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —É—Ä–æ–≤–Ω–µ–π:', {
                    levelsCount: levels.length,
                    lastCandleTime,
                    firstCandleTime,
                    activeLevels: levels.filter(l => l.is_active).length
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ lastCandleTime –≤–∞–ª–∏–¥–µ–Ω
                if (!lastCandleTime || !isFinite(lastCandleTime) || lastCandleTime <= 0) {
                    console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π lastCandleTime:', lastCandleTime);
                    return;
                }
                
                levels.forEach(level => {
                    // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω—è
                    if (!level || typeof level !== 'object') {
                        return;
                    }
                    
                    if (!level.is_active || !level.price) {
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–Ω–∞ —É—Ä–æ–≤–Ω—è –≤–∞–ª–∏–¥–Ω–∞
                    const priceValue = Number(level.price);
                    if (isNaN(priceValue) || !isFinite(priceValue) || priceValue <= 0) {
                        console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞ —É—Ä–æ–≤–Ω—è:', level.price, level);
                        return;
                    }
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —É—Ä–æ–≤–Ω—è
                    let levelStartTime = null;
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º created_at, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ first_touch
                    if (level.created_at) {
                        try {
                            const createdDate = new Date(level.created_at);
                            if (!isNaN(createdDate.getTime())) {
                                levelStartTime = Math.floor(createdDate.getTime() / 1000);
                            }
                        } catch (e) {
                            console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ created_at:', level.created_at, e);
                        }
                    }
                    
                    if (!levelStartTime && level.first_touch) {
                        try {
                            const touchDate = new Date(level.first_touch);
                            if (!isNaN(touchDate.getTime())) {
                                levelStartTime = Math.floor(touchDate.getTime() / 1000);
                            }
                        } catch (e) {
                            console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ first_touch:', level.first_touch, e);
                        }
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –∏–ª–∏ –æ–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é —Å–≤–µ—á—É
                    if (!levelStartTime || !isFinite(levelStartTime) || levelStartTime <= 0 || levelStartTime < firstCandleTime) {
                        levelStartTime = firstCandleTime;
                    }
                    
                    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ levelStartTime –≤–∞–ª–∏–¥–µ–Ω
                    if (!levelStartTime || !isFinite(levelStartTime) || levelStartTime <= 0) {
                        console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π levelStartTime –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫:', levelStartTime, '–∏—Å–ø–æ–ª—å–∑—É–µ–º firstCandleTime');
                        levelStartTime = firstCandleTime;
                    }
                    
                    // –ï—Å–ª–∏ levelStartTime –±–æ–ª—å—à–µ lastCandleTime, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —É—Ä–æ–≤–µ–Ω—å –±—ã–ª —Å–æ–∑–¥–∞–Ω
                    // –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å.
                    if (levelStartTime > lastCandleTime) {
                        // –£—Ä–æ–≤–µ–Ω—å —Å–æ–∑–¥–∞–Ω –≤ –±—É–¥—É—â–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ
                        return;
                    }
                    
                    // –ï—â–µ –æ–¥–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º lineData
                    if (!levelStartTime || !isFinite(levelStartTime) || levelStartTime <= 0) {
                        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: levelStartTime –≤—Å–µ –µ—â–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω:', levelStartTime);
                        return;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–∏–Ω–∏–∏-–ª—É—á–∞: –æ—Ç –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏ (–ª—É—á –≤–ø—Ä–∞–≤–æ)
                    // –õ–∏–Ω–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Ç —Ç–æ—á–∫–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏–¥–µ—Ç –≤–ø—Ä–∞–≤–æ –¥–æ –∫–æ–Ω—Ü–∞ –≥—Ä–∞—Ñ–∏–∫–∞
                    const lineData = [
                        { time: levelStartTime, value: priceValue },
                        { time: lastCandleTime, value: priceValue }
                    ];
                    
                    // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ lineData
                    const isValidLineData = lineData.every(point => {
                        return point && 
                               typeof point === 'object' &&
                               point.time !== null && 
                               point.time !== undefined &&
                               isFinite(point.time) &&
                               point.time > 0 &&
                               point.value !== null &&
                               point.value !== undefined &&
                               isFinite(point.value) &&
                               point.value > 0;
                    });
                    
                    if (!isValidLineData) {
                        console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–∏–Ω–∏–∏ —É—Ä–æ–≤–Ω—è:', lineData, level);
                        return;
                    }
                    
                    const color = level.level_type === 'support' ? '#00ff41' : '#ff006e';
                    try {
                        const lineSeries = chart.addLineSeries({
                            color: color,
                            lineWidth: 2, // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 1 –¥–æ 2 –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
                            lineStyle: LightweightCharts.LineStyle.Dashed, // –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è
                            title: `${level.level_type === 'support' ? '–ü–æ–¥–¥–µ—Ä–∂–∫–∞' : '–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ'} @ ${priceValue.toFixed(4)}`,
                            priceLineVisible: false, // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º price line
                            lastValueVisible: false, // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            crosshairMarkerVisible: true, // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫—Ä–æ—Å—Å—Ö—ç—Ä–µ
                            crosshairMarkerRadius: 4,
                        });
                        
                        lineSeries.setData(lineData);
                        levelLineSeries.push(lineSeries);
                        
                        const durationHours = (lastCandleTime - levelStartTime) / 3600;
                        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ª–∏–Ω–∏—è —É—Ä–æ–≤–Ω—è: ${level.level_type} @ ${priceValue.toFixed(4)}, –æ—Ç ${levelStartTime} (${new Date(levelStartTime * 1000).toLocaleString('ru-RU')}) –¥–æ ${lastCandleTime} (${new Date(lastCandleTime * 1000).toLocaleString('ru-RU')}), –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${durationHours.toFixed(1)} —á–∞—Å–æ–≤`);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ line series –¥–ª—è —É—Ä–æ–≤–Ω—è:', e, level, lineData);
                    }
                });
                
                console.log(`‚úÖ –û—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ ${levelLineSeries.length} –ª–∏–Ω–∏–π —É—Ä–æ–≤–Ω–µ–π`);
            } else {
                console.warn('‚ö†Ô∏è –£—Ä–æ–≤–Ω–∏ –Ω–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã:', {
                    hasLevels: !!(levels && Array.isArray(levels) && levels.length > 0),
                    hasData: !!(dataForLevels && dataForLevels.length > 0),
                    levelsType: typeof levels,
                    levelsLength: levels?.length,
                    dataLength: dataForLevels?.length
                });
            }

            // Render Chart Patterns (—Ü–µ–Ω–æ–≤—ã–µ —Ñ–∏–≥—É—Ä—ã)
            console.log('üé® Patterns visualization:', {
                patternsCount: chartPatterns?.length || 0,
                candlesCount: monotonicData?.length || 0,
                hasPatterns: !!(chartPatterns && chartPatterns.length > 0),
                hasCandles: !!(monotonicData && monotonicData.length > 0)
            });
            
            if (chartPatterns && chartPatterns.length > 0 && monotonicData && monotonicData.length > 0) {
                try {
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∏–≥—É—Ä—ã –ø–æ —Ç–∏–ø—É:
                    // - –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏,
                    //   –∞ –≤–æ–ø—Ä–æ—Å –∏—Ö –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ—à–∞–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (is_active, –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö —Ñ–∏–≥—É—Ä)
                    const lastCandle = monotonicData[monotonicData.length - 1];
                    const lastTime = lastCandle.time;
                    const lastClose = lastCandle.close;

                    // –û–∫–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏: —Å–∫–æ–ª—å–∫–æ —Å–≤–µ—á–µ–π –Ω–∞–∑–∞–¥ —Å—á–∏—Ç–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏
                    const timeframeSecondsMap = {
                        '15m': 15 * 60,
                        '1h': 60 * 60,
                        '4h': 4 * 60 * 60,
                    };
                    const tfSec = timeframeSecondsMap[currentTimeframe] || 60 * 60;
                    
                    // –¢–∏–ø—ã —Ñ–∏–≥—É—Ä
                    const triangleTypes = ['ascending_triangle', 'descending_triangle', 'symmetrical_triangle'];
                    const allPatternTypes = [...triangleTypes, 'head_and_shoulders', 'double_top', 'double_bottom', 'flag', 'pennant', 'wedge', 'rectangle'];
                    
                    // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
                    function getTriangleStatus(pattern, currentPrice, currentCandleIndex) {
                        if (!pattern.pattern_data) return 'UNKNOWN';
                        
                        const pd = pattern.pattern_data;
                        const resSlope = Number(pd.resistance_slope) || 0;
                        const resIntercept = Number(pd.resistance_intercept) || 0;
                        const supSlope = Number(pd.support_slope) || 0;
                        const supIntercept = Number(pd.support_intercept) || 0;
                        const startIdx = pd.start_index !== undefined ? pd.start_index : 0;
                        const endIdx = pd.end_index !== undefined ? pd.end_index : currentCandleIndex;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è —Å–≤–µ—á–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
                        if (currentCandleIndex < startIdx) {
                            return 'EXPIRED'; // –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è
                        }
                        if (currentCandleIndex > endIdx) {
                            // –ï—Å–ª–∏ —Å–≤–µ—á–∞ –ø–æ—Å–ª–µ end_idx, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ–±–∏—Ç –ª–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Ä–æ–≤–Ω–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç end_idx
                            const endResistance = resSlope * endIdx + resIntercept;
                            const endSupport = supSlope * endIdx + supIntercept;
                            
                            const tolerance = currentPrice * 0.003;
                            if (currentPrice > endResistance + tolerance) {
                                return 'BREAKOUT_UP';
                            } else if (currentPrice < endSupport - tolerance) {
                                return 'BREAKOUT_DOWN';
                            } else {
                                return 'EXPIRED'; // –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –∏—Å—Ç–µ–∫, –Ω–æ –ø—Ä–æ–±–æ—è –Ω–µ—Ç
                            }
                        }
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ —É—Ä–æ–≤–Ω–∏ –ª–∏–Ω–∏–π –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å–≤–µ—á–µ
                        const currentResistance = resSlope * currentCandleIndex + resIntercept;
                        const currentSupport = supSlope * currentCandleIndex + supIntercept;
                        
                        // –¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–±–æ—è (0.3%)
                        const tolerance = currentPrice * 0.003;
                        
                        if (currentPrice > currentResistance + tolerance) {
                            return 'BREAKOUT_UP'; // –ü—Ä–æ–±–∏—Ç –≤–≤–µ—Ä—Ö
                        } else if (currentPrice < currentSupport - tolerance) {
                            return 'BREAKOUT_DOWN'; // –ü—Ä–æ–±–∏—Ç –≤–Ω–∏–∑
                        } else if (currentSupport <= currentPrice && currentPrice <= currentResistance) {
                            return 'INSIDE'; // –í–Ω—É—Ç—Ä–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
                        } else {
                            return 'NEAR_BOUNDARY'; // –ë–ª–∏–∑–∫–æ –∫ –≥—Ä–∞–Ω–∏—Ü–µ
                        }
                    }
                    
                    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–π
                    function filterBestTriangle(patterns, currentPrice, currentCandleIndex) {
                        const triangles = patterns.filter(p => 
                            triangleTypes.includes(p.pattern_type)
                        );
                        
                        if (triangles.length === 0) return [];
                        
                        // 1. –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ (—Ü–µ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –∏–ª–∏ –±–ª–∏–∑–∫–æ)
                        const activeTriangles = triangles.filter(t => {
                            const status = getTriangleStatus(t, currentPrice, currentCandleIndex);
                            const isActive = status === 'INSIDE' || status === 'NEAR_BOUNDARY';
                            console.log(`üîç –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ${t.pattern_type}: —Å—Ç–∞—Ç—É—Å=${status}, –∞–∫—Ç–∏–≤–Ω—ã–π=${isActive}`);
                            return isActive;
                        });
                        
                        if (activeTriangles.length > 0) {
                            // –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π (–ø–æ reliability)
                            const bestActive = activeTriangles.sort((a, b) => 
                                (b.reliability || 0) - (a.reliability || 0)
                            )[0];
                            console.log('‚úÖ –ù–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫:', bestActive.pattern_type, 'reliability:', bestActive.reliability);
                            return [bestActive];
                        }
                        
                        // 2. –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—É—á—à–∏–π –ø—Ä–æ–±–∏—Ç—ã–π (reliability > 0.5, –±–æ–ª–µ–µ –º—è–≥–∫–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π)
                        const brokenTriangles = triangles.filter(t => {
                            const status = getTriangleStatus(t, currentPrice, currentCandleIndex);
                            const isBroken = (status === 'BREAKOUT_UP' || status === 'BREAKOUT_DOWN') && 
                                            (t.reliability || 0) > 0.5;
                            console.log(`üîç –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ${t.pattern_type}: —Å—Ç–∞—Ç—É—Å=${status}, –ø—Ä–æ–±–∏—Ç=${isBroken}, reliability=${t.reliability}`);
                            return isBroken;
                        });
                        
                        if (brokenTriangles.length > 0) {
                            const bestBroken = brokenTriangles.sort((a, b) => 
                                (b.reliability || 0) - (a.reliability || 0)
                            )[0];
                            console.log('üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—É—á—à–∏–π –ø—Ä–æ–±–∏—Ç—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫:', bestBroken.pattern_type, 'reliability:', bestBroken.reliability);
                            return [bestBroken];
                        }
                        
                        // 3. –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—É—á—à–∏–π –ø–æ reliability (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                        if (triangles.length > 0) {
                            const bestByReliability = triangles.sort((a, b) => 
                                (b.reliability || 0) - (a.reliability || 0)
                            )[0];
                            console.log('‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö/–ø—Ä–æ–±–∏—Ç—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª—É—á—à–∏–π –ø–æ reliability:', bestByReliability.pattern_type, 'reliability:', bestByReliability.reliability);
                            return [bestByReliability];
                        }
                        
                        return [];
                    }

                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ (1970 –≥–æ–¥ –∏–ª–∏ —Ä–∞–Ω—å—à–µ)
                    const MIN_VALID_TIMESTAMP = 946684800; // 2000-01-01 00:00:00 UTC –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                    
                    const filteredPatterns = chartPatterns.filter(pattern => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞—Ç
                        if (!pattern.start_time || !pattern.end_time) {
                            console.warn('‚ö†Ô∏è –ü–∞—Ç—Ç–µ—Ä–Ω –±–µ–∑ –¥–∞—Ç:', pattern);
                            return false;
                        }
                        
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –≤ timestamp –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                        const startTs = Math.floor(new Date(pattern.start_time).getTime() / 1000);
                        const endTs = Math.floor(new Date(pattern.end_time).getTime() / 1000);
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ (–¥–æ 2000 –≥–æ–¥–∞)
                        if (startTs < MIN_VALID_TIMESTAMP || endTs < MIN_VALID_TIMESTAMP) {
                            console.warn('‚ö†Ô∏è –ü–∞—Ç—Ç–µ—Ä–Ω —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –¥–∞—Ç–æ–π (1970 –∏–ª–∏ —Ä–∞–Ω—å—à–µ):', {
                                pattern: pattern.pattern_type,
                                start: pattern.start_time,
                                end: pattern.end_time,
                                startTs,
                                endTs
                            });
                            return false;
                        }
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –¥–∞—Ç–∞–º–∏ –≤ –¥–∞–ª–µ–∫–æ–º –±—É–¥—É—â–µ–º (–±–æ–ª–µ–µ —á–µ–º –Ω–∞ 1 –¥–µ–Ω—å)
                        const MAX_VALID_TIMESTAMP = Math.floor(Date.now() / 1000) + (24 * 60 * 60);
                        if (startTs > MAX_VALID_TIMESTAMP || endTs > MAX_VALID_TIMESTAMP) {
                            console.warn('‚ö†Ô∏è –ü–∞—Ç—Ç–µ—Ä–Ω —Å –¥–∞—Ç–æ–π –≤ –±—É–¥—É—â–µ–º:', {
                                pattern: pattern.pattern_type,
                                start: pattern.start_time,
                                end: pattern.end_time
                            });
                            return false;
                        }
                        
                        return true;
                    }).filter(pattern => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã —Ñ–∏–≥—É—Ä, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ
                        if (!pattern.pattern_type) {
                            console.warn('Pattern without type:', pattern);
                            return false;
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã —Ñ–∏–≥—É—Ä (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏)
                        // if (!allPatternTypes.includes(pattern.pattern_type)) {
                        //     return false;
                        // }

                        // –°—Ç—Ä–æ–≥–∞—è –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                        if (!pattern.start_time || !pattern.end_time) {
                            console.warn('Pattern without time:', pattern.pattern_type);
                            return false;
                        }

                        const support = Number(pattern.support_level);
                        const resistance = Number(pattern.resistance_level);
                        if (!isFinite(support) || !isFinite(resistance) || support <= 0 || resistance <= 0) {
                            console.warn('Pattern with invalid levels:', pattern.pattern_type, {support, resistance});
                            return false;
                        }

                        const endTs = Math.floor(new Date(pattern.end_time).getTime() / 1000);
                        if (!endTs || !isFinite(endTs) || endTs <= 0) {
                            console.warn('Pattern with invalid end time:', pattern.pattern_type);
                            return false;
                        }

                        return true;
                    });

                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–π
                    const triangles = filteredPatterns.filter(p => triangleTypes.includes(p.pattern_type));
                    const otherPatterns = filteredPatterns.filter(p => !triangleTypes.includes(p.pattern_type));
                    
                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π —Å–≤–µ—á–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                    let currentCandleIndex = monotonicData.length - 1;
                    if (monotonicData.length === 0) {
                        currentCandleIndex = 0;
                    }
                    
                    console.log(`üîç –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${triangles.length}, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã: ${otherPatterns.length}`);
                    console.log(`üîç –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å —Å–≤–µ—á–∏: ${currentCandleIndex}, —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: ${lastClose}`);
                    
                    // –í–†–ï–ú–ï–ù–ù–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≥—Ä–∞—Ñ–∏–∫–∞
                    const visibleTriangles = triangles.filter(t => {
                        if (!t.start_time || !t.end_time) {
                            console.warn('‚ö†Ô∏è –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏:', t);
                            return false;
                        }
                        const startTs = Math.floor(new Date(t.start_time).getTime() / 1000);
                        const endTs = Math.floor(new Date(t.end_time).getTime() / 1000);
                        const firstCandleTime = monotonicData[0]?.time || 0;
                        const lastCandleTime = lastTime;
                        const isVisible = endTs >= firstCandleTime && startTs <= lastCandleTime;
                        console.log(`üîç –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ${t.pattern_type}:`, {
                            start: new Date(t.start_time).toISOString(),
                            end: new Date(t.end_time).toISOString(),
                            startTs,
                            endTs,
                            firstCandleTime,
                            lastCandleTime,
                            isVisible
                        });
                        return isVisible;
                    });
                    
                    console.log(`üîç –í–∏–¥–∏–º—ã–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏: ${visibleTriangles.length} –∏–∑ ${triangles.length}`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ (–∞–∫—Ç–∏–≤–Ω—ã–π –∏–ª–∏ –ª—É—á—à–∏–π –ø—Ä–æ–±–∏—Ç—ã–π)
                    const bestTriangles = filterBestTriangle(visibleTriangles, lastClose, currentCandleIndex);
                    
                    console.log(`‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ${bestTriangles.length} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –∏–∑ ${visibleTriangles.length} –≤–∏–¥–∏–º—ã—Ö`);
                    
                    // –í–ê–ñ–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏, —Å–∫—Ä—ã–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –≥—Ä–∞—Ñ–∏–∫–∞
                    let finalPatterns;
                    if (bestTriangles.length === 0 && visibleTriangles.length > 0) {
                        console.warn('‚ö†Ô∏è –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –Ω–µ –ø—Ä–æ—à–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.');
                        // –í–†–ï–ú–ï–ù–ù–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–∏–¥–∏–º—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                        finalPatterns = [visibleTriangles[0]];
                    } else {
                        // –û–±—ä–µ–¥–∏–Ω—è–µ–º: —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏ (–±–µ–∑ –¥—Ä—É–≥–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
                        finalPatterns = [...bestTriangles];
                    }
                    
                    console.log(`üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ ${finalPatterns.length} —Ñ–∏–≥—É—Ä (${bestTriangles.length} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤, ${otherPatterns.length} –¥—Ä—É–≥–∏—Ö) –∏–∑ ${chartPatterns.length} –≤—Å–µ–≥–æ`);
                    if (finalPatterns.length > 0) {
                        console.log('üìä Pattern types:', finalPatterns.map(p => p.pattern_type));
                    }

                    if (!finalPatterns.length) {
                        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∏–≥—É—Ä –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏, –µ—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –Ω–µ—Ç
                        const patternsContainer = document.getElementById('chart-patterns-list');
                        if (patternsContainer) {
                            patternsContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">–ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∏–≥—É—Ä —Ä—è–¥–æ–º —Å —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–æ–π</div>';
                        }
                    }
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ñ–∏–≥—É—Ä
                    const patternMarkers = [];
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º signalMarkers, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
                    if (!window.signalMarkers) {
                        window.signalMarkers = [];
                    }
                    
                    finalPatterns.forEach(pattern => {
                        if (!pattern.start_time || !pattern.end_time) {
                            return;
                        }
                        
                        try {
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–∞ –≤ Unix timestamp (—Å–µ–∫—É–Ω–¥—ã)
                            const startTime = Math.floor(new Date(pattern.start_time).getTime() / 1000);
                            const endTime = Math.floor(new Date(pattern.end_time).getTime() / 1000);

                            // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
                            if (
                                !startTime || !endTime ||
                                !isFinite(startTime) || !isFinite(endTime) ||
                                startTime <= 0 || endTime <= 0 ||
                                endTime < startTime
                            ) {
                                console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∞ —Ñ–∏–≥—É—Ä—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', pattern);
                                return;
                            }
                            
                            // –ü—Ä–∏–≤–æ–¥–∏–º —É—Ä–æ–≤–Ω–∏ –∫ —á–∏—Å–ª—É –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
                            const supportLevel = Number(pattern.support_level);
                            const resistanceLevel = Number(pattern.resistance_level);

                            const hasValidLevels =
                                isFinite(supportLevel) &&
                                isFinite(resistanceLevel) &&
                                supportLevel > 0 &&
                                resistanceLevel > 0;

                            // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
                            // –î–ª—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∫–ª–æ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏ –∏–∑ pattern_data
                            const isTriangle = pattern.pattern_type && (
                                pattern.pattern_type === 'ascending_triangle' ||
                                pattern.pattern_type === 'descending_triangle' ||
                                pattern.pattern_type === 'symmetrical_triangle'
                            );
                            
                            if (hasValidLevels) {
                                let supportLineData = [];
                                let resistanceLineData = [];
                                
                                if (isTriangle && pattern.pattern_data) {
                                    // –î–ª—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ —Å—Ç—Ä–æ–∏–º –Ω–∞–∫–ª–æ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏ —á–µ—Ä–µ–∑ –†–ï–ê–õ–¨–ù–´–ï —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è
                                    const pd = pattern.pattern_data;
                                    
                                    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è –∏–∑ pattern_data
                                    const resistancePoints = pd.resistance_points || [];
                                    const supportPoints = pd.support_points || [];
                                    
                                    // –°—Ç—Ä–æ–∏–º –ª–∏–Ω–∏–∏ —á–µ—Ä–µ–∑ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è
                                    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–≤–µ—á–∏ –≤ monotonicData –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                    const resistanceLinePoints = [];
                                    const supportLinePoints = [];
                                    
                                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è
                                    // resistance_points –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç [{index: number, time: number, price: number, candle: {...}}, ...]
                                    if (resistancePoints && Array.isArray(resistancePoints) && resistancePoints.length > 0) {
                                        for (const point of resistancePoints) {
                                            if (!point || point.price === undefined) continue;
                                            
                                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ–º
                                            let pointTime;
                                            if (point.time !== undefined) {
                                                // –í—Ä–µ–º—è —É–∂–µ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (Unix timestamp)
                                                pointTime = Math.floor(point.time);
                                            } else if (point.index !== undefined) {
                                                // Fallback: –≤—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ start_time –∏ –∏–Ω–¥–µ–∫—Å–∞
                                                pointTime = Math.floor(new Date(pattern.start_time).getTime() / 1000) + point.index * tfSec;
                                            } else {
                                                continue; // –ù–µ—Ç –Ω–∏ –≤—Ä–µ–º–µ–Ω–∏, –Ω–∏ –∏–Ω–¥–µ–∫—Å–∞
                                            }
                                            
                                            // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å–≤–µ—á—É –≤ monotonicData –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                            let closestCandle = null;
                                            let minDiff = Infinity;
                                            for (let i = 0; i < monotonicData.length; i++) {
                                                const diff = Math.abs(monotonicData[i].time - pointTime);
                                                if (diff < minDiff) {
                                                    minDiff = diff;
                                                    closestCandle = { index: i, time: monotonicData[i].time };
                                                }
                                            }
                                            
                                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è –∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å–≤–µ—á–∏
                                            if (closestCandle && point.price) {
                                                resistanceLinePoints.push({
                                                    time: closestCandle.time,
                                                    value: Number(point.price)
                                                });
                                            }
                                        }
                                    }
                                    
                                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
                                    // support_points –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç [{index: number, time: number, price: number, candle: {...}}, ...]
                                    if (supportPoints && Array.isArray(supportPoints) && supportPoints.length > 0) {
                                        for (const point of supportPoints) {
                                            if (!point || point.price === undefined) continue;
                                            
                                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ–º
                                            let pointTime;
                                            if (point.time !== undefined) {
                                                // –í—Ä–µ–º—è —É–∂–µ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (Unix timestamp)
                                                pointTime = Math.floor(point.time);
                                            } else if (point.index !== undefined) {
                                                // Fallback: –≤—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ start_time –∏ –∏–Ω–¥–µ–∫—Å–∞
                                                pointTime = Math.floor(new Date(pattern.start_time).getTime() / 1000) + point.index * tfSec;
                                            } else {
                                                continue; // –ù–µ—Ç –Ω–∏ –≤—Ä–µ–º–µ–Ω–∏, –Ω–∏ –∏–Ω–¥–µ–∫—Å–∞
                                            }
                                            
                                            // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å–≤–µ—á—É –≤ monotonicData –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                            let closestCandle = null;
                                            let minDiff = Infinity;
                                            for (let i = 0; i < monotonicData.length; i++) {
                                                const diff = Math.abs(monotonicData[i].time - pointTime);
                                                if (diff < minDiff) {
                                                    minDiff = diff;
                                                    closestCandle = { index: i, time: monotonicData[i].time };
                                                }
                                            }
                                            
                                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è –∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å–≤–µ—á–∏
                                            if (closestCandle && point.price) {
                                                supportLinePoints.push({
                                                    time: closestCandle.time,
                                                    value: Number(point.price)
                                                });
                                            }
                                        }
                                    }
                                    
                                    // –ï—Å–ª–∏ —Ç–æ—á–µ–∫ –∫–∞—Å–∞–Ω–∏—è –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º slope/intercept –∫–∞–∫ fallback
                                    if (resistanceLinePoints.length === 0 || supportLinePoints.length === 0) {
                                        const resSlope = Number(pd.resistance_slope) || 0;
                                        const resIntercept = Number(pd.resistance_intercept) || 0;
                                        const supSlope = Number(pd.support_slope) || 0;
                                        const supIntercept = Number(pd.support_intercept) || 0;
                                        
                                        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –≤ monotonicData –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                        let startIdxInMonotonic = 0;
                                        let endIdxInMonotonic = monotonicData.length - 1;
                                        
                                        for (let i = 0; i < monotonicData.length; i++) {
                                            if (monotonicData[i].time >= startTime) {
                                                startIdxInMonotonic = i;
                                                break;
                                            }
                                        }
                                        
                                        for (let i = monotonicData.length - 1; i >= 0; i--) {
                                            if (monotonicData[i].time <= endTime) {
                                                endIdxInMonotonic = i;
                                                break;
                                            }
                                        }
                                        
                                        const startTimeForLine = monotonicData[startIdxInMonotonic]?.time || startTime;
                                        const endTimeForLine = monotonicData[endIdxInMonotonic]?.time || endTime;
                                        
                                        if (resistanceLinePoints.length === 0) {
                                            resistanceLinePoints.push(
                                                { time: startTimeForLine, value: resSlope * startIdxInMonotonic + resIntercept },
                                                { time: endTimeForLine, value: resSlope * endIdxInMonotonic + resIntercept }
                                            );
                                        }
                                        
                                        if (supportLinePoints.length === 0) {
                                            supportLinePoints.push(
                                                { time: startTimeForLine, value: supSlope * startIdxInMonotonic + supIntercept },
                                                { time: endTimeForLine, value: supSlope * endIdxInMonotonic + supIntercept }
                                            );
                                        }
                                    }
                                    
                                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                                    resistanceLinePoints.sort((a, b) => a.time - b.time);
                                    supportLinePoints.sort((a, b) => a.time - b.time);
                                    
                                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
                                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
                                    const lastTriangleTime = Math.max(
                                        ...resistanceLinePoints.map(p => p.time),
                                        ...supportLinePoints.map(p => p.time)
                                    );
                                    
                                    let lastTriangleIdx = currentCandleIndex;
                                    for (let i = 0; i < monotonicData.length; i++) {
                                        if (monotonicData[i].time >= lastTriangleTime) {
                                            lastTriangleIdx = i;
                                            break;
                                        }
                                    }
                                    
                                    console.log(`üìê –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ${pattern.pattern_type}:`, {
                                        resistancePoints: resistanceLinePoints.length,
                                        supportPoints: supportLinePoints.length,
                                        resistanceLine: resistanceLinePoints,
                                        supportLine: supportLinePoints,
                                        lastTriangleIdx
                                    });
                                    
                                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                                    const triangleStatus = getTriangleStatus(pattern, lastClose, lastTriangleIdx);
                                    
                                    // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –ª–∏–Ω–∏–∏ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                                    if (triangleStatus === 'INSIDE' || triangleStatus === 'NEAR_BOUNDARY') {
                                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º slope/intercept –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                                        const resSlope = Number(pd.resistance_slope) || 0;
                                        const resIntercept = Number(pd.resistance_intercept) || 0;
                                        const supSlope = Number(pd.support_slope) || 0;
                                        const supIntercept = Number(pd.support_intercept) || 0;
                                        
                                        const currentResValue = resSlope * currentCandleIndex + resIntercept;
                                        const currentSupValue = supSlope * currentCandleIndex + supIntercept;
                                        
                                        // –í—ã—á–∏—Å–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
                                        const startResValue = resSlope * startIdxInMonotonic + resIntercept;
                                        const endResValue = resSlope * endIdxInMonotonic + resIntercept;
                                        const startSupValue = supSlope * startIdxInMonotonic + supIntercept;
                                        const endSupValue = supSlope * endIdxInMonotonic + supIntercept;
                                        
                                        console.log(`‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ${pattern.pattern_type}:`, {
                                            status: triangleStatus,
                                            currentPrice: lastClose,
                                            currentSupport: currentSupValue,
                                            currentResistance: currentResValue
                                        });
                                        
                                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                                        if (resistanceLinePoints.length > 0 && supportLinePoints.length > 0) {
                                            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –Ω–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ç–æ—á–∫–∞–º
                                            resistanceLineData = [
                                                ...resistanceLinePoints,
                                                { time: lastTime, value: currentResValue }
                                            ];
                                            supportLineData = [
                                                ...supportLinePoints,
                                                { time: lastTime, value: currentSupValue }
                                            ];
                                        } else {
                                            // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                                            resistanceLineData = [
                                                { time: startTimeForLine, value: startResValue },
                                                { time: endTimeForLine, value: endResValue },
                                                { time: lastTime, value: currentResValue }
                                            ];
                                            
                                            supportLineData = [
                                                { time: startTimeForLine, value: startSupValue },
                                                { time: endTimeForLine, value: endSupValue },
                                                { time: lastTime, value: currentSupValue }
                                            ];
                                        }
                                    } else {
                                        // –î–ª—è –ø—Ä–æ–±–∏—Ç—ã—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è
                                        resistanceLineData = [...resistanceLinePoints];
                                        supportLineData = [...supportLinePoints];
                                    }
                                    
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ª–∏–Ω–∏–π
                                    // resistanceLineData –∏ supportLineData —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –≤—ã—à–µ
                                    
                                    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ: –∞–∫—Ç–∏–≤–Ω—ã–π - —è—Ä–∫–∏–µ —Å–ø–ª–æ—à–Ω—ã–µ –ª–∏–Ω–∏–∏, –ø—Ä–æ–±–∏—Ç—ã–π - –ø—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç–∏—Ä–Ω—ã–µ
                                    let supportColor, resistanceColor, lineWidth, lineStyle;
                                    
                                    if (triangleStatus === 'INSIDE' || triangleStatus === 'NEAR_BOUNDARY') {
                                        // –ê–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ - —è—Ä–∫–∏–µ —Å–ø–ª–æ—à–Ω—ã–µ –¢–û–õ–°–¢–´–ï –ª–∏–Ω–∏–∏ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
                                        supportColor = pattern.direction === 'bullish' ? '#00ff41' : '#ff006e';
                                        resistanceColor = pattern.direction === 'bullish' ? '#00ff41' : '#ff006e';
                                        lineWidth = 3; // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 2 –¥–æ 3 –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
                                        lineStyle = 1; // Solid
                                    } else {
                                        // –ü—Ä–æ–±–∏—Ç—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ - –ø—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç–∏—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏, –Ω–æ —Ç–æ–∂–µ —Ç–æ–ª—Å—Ç—ã–µ
                                        supportColor = pattern.direction === 'bullish' ? '#00aa33' : '#aa0033';
                                        resistanceColor = pattern.direction === 'bullish' ? '#00aa33' : '#aa0033';
                                        lineWidth = 2; // –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 1 –¥–æ 2
                                        lineStyle = 2; // Dashed
                                    }
                                    
                                    const supportLine = chart.addLineSeries({
                                        color: supportColor,
                                        lineWidth: lineWidth,
                                        lineStyle: lineStyle,
                                        title: `–ü–æ–¥–¥–µ—Ä–∂–∫–∞ ${pattern.pattern_type}${triangleStatus ? ` (${triangleStatus})` : ''}`,
                                        priceLineVisible: false,
                                        lastValueVisible: false,
                                    });
                                    
                                    const resistanceLine = chart.addLineSeries({
                                        color: resistanceColor,
                                        lineWidth: lineWidth,
                                        lineStyle: lineStyle,
                                        title: `–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ ${pattern.pattern_type}${triangleStatus ? ` (${triangleStatus})` : ''}`,
                                        priceLineVisible: false,
                                        lastValueVisible: false,
                                    });
                                    
                                    supportLine.setData(supportLineData);
                                    resistanceLine.setData(resistanceLineData);
                                    
                                    patternLineSeries.push(supportLine, resistanceLine);
                                    
                                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
                                    if (resistanceLineData.length > 0 && supportLineData.length > 0) {
                                        const firstResPoint = resistanceLineData[0];
                                        const lastResPoint = resistanceLineData[resistanceLineData.length - 1];
                                        const firstSupPoint = supportLineData[0];
                                        const lastSupPoint = supportLineData[supportLineData.length - 1];
                                        
                                        // –ú–∞—Ä–∫–µ—Ä—ã –Ω–∞ –Ω–∞—á–∞–ª–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ (–ª–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞)
                                        patternMarkers.push({
                                            time: firstResPoint.time,
                                            position: 'aboveBar',
                                            color: resistanceColor,
                                            shape: 'circle',
                                            text: '‚ñ≤',
                                            size: 2
                                        });
                                        
                                        patternMarkers.push({
                                            time: firstSupPoint.time,
                                            position: 'belowBar',
                                            color: supportColor,
                                            shape: 'circle',
                                            text: '‚ñº',
                                            size: 2
                                        });
                                        
                                        // –ú–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–æ–Ω—Ü–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ (–ø—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞)
                                        patternMarkers.push({
                                            time: lastResPoint.time,
                                            position: 'aboveBar',
                                            color: resistanceColor,
                                            shape: 'circle',
                                            text: '‚ñ≤',
                                            size: 2
                                        });
                                        
                                        patternMarkers.push({
                                            time: lastSupPoint.time,
                                            position: 'belowBar',
                                            color: supportColor,
                                            shape: 'circle',
                                            text: '‚ñº',
                                            size: 2
                                        });
                                    }
                                } else {
                                    // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∏–≥—É—Ä –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
                                    supportLineData = [
                                        { time: startTime, value: supportLevel },
                                        { time: endTime, value: supportLevel }
                                    ];
                                    
                                    resistanceLineData = [
                                        { time: startTime, value: resistanceLevel },
                                        { time: endTime, value: resistanceLevel }
                                    ];
                                }
                                
                                // –î–ª—è —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –ª–∏–Ω–∏–∏ —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤ –±–ª–æ–∫–µ isTriangle –≤—ã—à–µ
                                // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∏–≥—É—Ä —Å–æ–∑–¥–∞–µ–º –ª–∏–Ω–∏–∏ –∑–¥–µ—Å—å
                                if (!isTriangle) {
                                    const supportColor = pattern.direction === 'bullish' ? '#00ff41' : '#ff006e';
                                    const resistanceColor = pattern.direction === 'bullish' ? '#00ff41' : '#ff006e';
                                    
                                    const supportLine = chart.addLineSeries({
                                        color: supportColor,
                                        lineWidth: 2,
                                        lineStyle: 1, // Solid
                                        title: `–ü–æ–¥–¥–µ—Ä–∂–∫–∞ ${pattern.pattern_type}`,
                                        priceLineVisible: false,
                                        lastValueVisible: false,
                                    });
                                    
                                    const resistanceLine = chart.addLineSeries({
                                        color: resistanceColor,
                                        lineWidth: 2,
                                        lineStyle: 1, // Solid
                                        title: `–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ ${pattern.pattern_type}`,
                                        priceLineVisible: false,
                                        lastValueVisible: false,
                                    });
                                    
                                    supportLine.setData(supportLineData);
                                    resistanceLine.setData(resistanceLineData);
                                    
                                    patternLineSeries.push(supportLine, resistanceLine);
                                }
                                
                                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é —à–µ–∏ –¥–ª—è Head and Shoulders, Double Top/Bottom
                                const necklineLevel = Number(pattern.neckline);
                                const hasValidNeckline =
                                    isFinite(necklineLevel) &&
                                    necklineLevel > 0;

                                if (hasValidNeckline && (pattern.pattern_type === 'head_and_shoulders' || 
                                    pattern.pattern_type === 'double_top' || 
                                    pattern.pattern_type === 'double_bottom')) {
                                    const neckline = chart.addLineSeries({
                                        color: '#888',
                                        lineWidth: 1,
                                        lineStyle: 2, // Dashed
                                        title: `–õ–∏–Ω–∏—è —à–µ–∏ ${pattern.pattern_type}`,
                                        priceLineVisible: false,
                                        lastValueVisible: false,
                                    });
                                    
                                    neckline.setData([
                                        { time: startTime, value: necklineLevel },
                                        { time: endTime, value: necklineLevel }
                                    ]);
                                    
                                    patternLineSeries.push(neckline);
                                }
                                
                                // –†–∏—Å—É–µ–º –∑–∞–∫—Ä–∞—à–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å —Ñ–∏–≥—É—Ä—ã (Area Series)
                                // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: areaSeries –∏–Ω–æ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–µ Value is null –≤–Ω—É—Ç—Ä–∏ LightweightCharts.
                                // –õ–∏–Ω–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –∏ –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è,
                                // —á—Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∏–≥—É—Ä.
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –Ω–∞—á–∞–ª–æ —Ñ–∏–≥—É—Ä—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
                                const patternName = pattern.pattern_type.replace(/_/g, ' ').toUpperCase();
                                const emoji = pattern.direction === 'bullish' ? 'üü¢' : pattern.direction === 'bearish' ? 'üî¥' : '‚ö™';
                                
                                patternMarkers.push({
                                    time: startTime,
                                    position: pattern.direction === 'bullish' ? 'belowBar' : 'aboveBar',
                                    color: pattern.direction === 'bullish' ? '#00ff41' : '#ff006e',
                                    shape: 'circle',
                                    text: `${emoji} ${patternName}`,
                                    size: 1
                                });
                            }
                        } catch (e) {
                            console.error(`–û—à–∏–±–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∏–≥—É—Ä—ã ${pattern.pattern_type}:`, e);
                        }
                    });
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —Ñ–∏–≥—É—Ä –∫ –≥—Ä–∞—Ñ–∏–∫—É (–∑–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º)
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ —Å–∏–≥–Ω–∞–ª–æ–≤
                    const allMarkers = [...patternMarkers];
                    if (window.signalMarkers && Array.isArray(window.signalMarkers)) {
                        allMarkers.push(...window.signalMarkers);
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
                    window.allChartMarkers = allMarkers;
                    
                    if (candlestickSeries && allMarkers.length > 0) {
                        try {
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≤–º–µ—Å—Ç–µ (–ø–∞—Ç—Ç–µ—Ä–Ω—ã + —Å–∏–≥–Ω–∞–ª—ã)
                            candlestickSeries.setMarkers(allMarkers);
                            console.log(`‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${allMarkers.length} –º–∞—Ä–∫–µ—Ä–æ–≤ (${patternMarkers.length} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ + ${window.signalMarkers?.length || 0} —Å–∏–≥–Ω–∞–ª–æ–≤)`);
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤:', e);
                        }
                    } else if (candlestickSeries && window.signalMarkers && window.signalMarkers.length > 0) {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤, –Ω–æ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä—ã —Å–∏–≥–Ω–∞–ª–æ–≤
                        window.allChartMarkers = window.signalMarkers;
                        try {
                            candlestickSeries.setMarkers(window.signalMarkers);
                            console.log(`‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${window.signalMarkers.length} –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤`);
                        } catch (e) {
                            console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤:', e);
                        }
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–æ–≤, –æ—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                        window.allChartMarkers = [];
                    }
                    
                    console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${patternLineSeries.length} —Å–µ—Ä–∏–π –¥–ª—è ${filteredPatterns.length} —Ñ–∏–≥—É—Ä`);
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∏–≥—É—Ä –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
                    renderChartPatterns(filteredPatterns);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω–æ–≤—ã—Ö —Ñ–∏–≥—É—Ä:', e);
                }
            } else {
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∏–≥—É—Ä, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                const patternsContainer = document.getElementById('chart-patterns-list');
                if (patternsContainer) {
                    patternsContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–≥—É—Ä</div>';
                }
            }

            // Fit content
            try {
                if (chart && typeof chart.timeScale === 'function') {
                    chart.timeScale().fitContent();
                    
                    // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –ø–æ—Å–ª–µ fitContent, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –º–æ–∂–µ—Ç —Å–±—Ä–æ—Å–∏—Ç—å –∏—Ö
                    // –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–≥, –∫–æ–≥–¥–∞ –º–∞—Ä–∫–µ—Ä—ã –ø—Ä–æ–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
                    setTimeout(() => {
                        if (candlestickSeries && window.allChartMarkers && window.allChartMarkers.length > 0) {
                            try {
                                candlestickSeries.setMarkers(window.allChartMarkers);
                                console.log(`üîÑ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${window.allChartMarkers.length} –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ—Å–ª–µ fitContent`);
                            } catch (e) {
                                console.warn('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ—Å–ª–µ fitContent:', e);
                            }
                        }
                    }, 100);
                }
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ fitContent:', e);
            }
        }

        // Update Current Price Display
        function updateCurrentPriceDisplay(pairSymbol, currentPrice) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –≤ –ª–µ–≤–æ–º –±–ª–æ–∫–µ (—Å–ø–∏—Å–æ–∫ –ø–∞—Ä)
            const pairItem = document.querySelector(`.pair-item[data-pair="${pairSymbol}"]`);
            if (pairItem) {
                const priceElement = pairItem.querySelector('.pair-price');
                if (priceElement) {
                    priceElement.textContent = `$${formatPrice(currentPrice)}`;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –≤ –ø—Ä–∞–≤–æ–º –±–ª–æ–∫–µ (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä–µ)
            const infoContainer = document.getElementById('pair-info');
            if (infoContainer) {
                const priceItem = infoContainer.querySelector('.info-item');
                if (priceItem) {
                    const priceValue = priceItem.querySelector('.info-item-value');
                    if (priceValue) {
                        priceValue.textContent = `$${formatPrice(currentPrice)}`;
                    }
                }
            }
        }

        // Load Pair Info
        async function loadPairInfo(pairSymbol) {
            const pairData = pairsData[pairSymbol];
            if (!pairData) return;

            // Update pair info
            const infoContainer = document.getElementById('pair-info');
            if (infoContainer) {
                infoContainer.innerHTML = `
                    <div class="info-item">
                        <span class="info-item-label">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</span>
                        <span class="info-item-value">$${formatPrice(pairData.current_price || 0)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-item-label">–¢—Ä–µ–Ω–¥ 1H:</span>
                        <span class="info-item-value">${pairData.trend_1h || 'UNKNOWN'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-item-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</span>
                        <span class="info-item-value ${(pairData.price_change_24h || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(pairData.price_change_24h || 0) >= 0 ? '+' : ''}${(pairData.price_change_24h || 0).toFixed(2)}%
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-item-label">–û–±—ä–µ–º 24—á:</span>
                        <span class="info-item-value">${(pairData.volume_24h || 0).toFixed(1)}M</span>
                    </div>
                `;
            }

            // Load levels
            await loadPairLevels(pairSymbol);
        }

        function renderChartPatterns(patterns) {
            const container = document.getElementById('chart-patterns-list');
            if (!container) return;

            if (!patterns || patterns.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–≥—É—Ä</div>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (–≤—ã—Å–æ–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–≤—ã–º–∏)
            const sortedPatterns = [...patterns].sort((a, b) => (b.reliability || 0) - (a.reliability || 0));

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            const MIN_VALID_TIMESTAMP = 946684800000; // 2000-01-01 –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            
            const validPatterns = sortedPatterns.filter(pattern => {
                if (!pattern.start_time || !pattern.end_time) {
                    return false;
                }
                const startTs = new Date(pattern.start_time).getTime();
                const endTs = new Date(pattern.end_time).getTime();
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –¥–∞—Ç–∞–º–∏ –¥–æ 2000 –≥–æ–¥–∞ (1970 –∏ —Ç.–¥.)
                return startTs >= MIN_VALID_TIMESTAMP && endTs >= MIN_VALID_TIMESTAMP;
            });
            
            container.innerHTML = validPatterns.map(pattern => {
                const patternName = pattern.pattern_type.replace(/_/g, ' ').toUpperCase();
                const direction = pattern.direction || 'neutral';
                const reliability = (pattern.reliability || 0) * 100;
                const category = pattern.pattern_category || 'unknown';
                
                const directionEmoji = direction === 'bullish' ? 'üü¢' : direction === 'bearish' ? 'üî¥' : '‚ö™';
                const categoryText = category === 'reversal' ? '–†–∞–∑–≤–æ—Ä–æ—Ç' : category === 'continuation' ? '–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ' : '–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è';
                
                const startDate = new Date(pattern.start_time);
                const endDate = new Date(pattern.end_time);
                
                return `
                    <div class="level-item" style="margin-bottom: 0.75rem; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--glass-border); border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: var(--text-primary);">
                                ${directionEmoji} ${patternName}
                            </span>
                            <span style="font-size: 0.75rem; color: var(--accent-primary);">
                                ${reliability.toFixed(0)}%
                            </span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                            ${categoryText} ‚Ä¢ ${direction === 'bullish' ? '–ë—ã—á–∏–π' : direction === 'bearish' ? '–ú–µ–¥–≤–µ–∂–∏–π' : '–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π'}
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">
                            ${startDate.toLocaleDateString('ru-RU')} - ${endDate.toLocaleDateString('ru-RU')}
                        </div>
                        ${pattern.target_price ? `
                            <div style="font-size: 0.7rem; color: var(--accent-primary); margin-top: 0.25rem;">
                                –¶–µ–ª—å: $${formatPrice(pattern.target_price)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Load Pair Levels
        async function loadPairLevels(pairSymbol) {
            try {
                const response = await fetch(`${baseUrl}/api/chart-data?pair=${encodeURIComponent(pairSymbol)}&timeframe=${currentTimeframe}`);
                const data = await response.json();
                
                if (data.success && data.levels) {
                    renderLevels(data.levels, pairsData[pairSymbol]?.current_price || 0);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–≤–Ω–µ–π:', error);
            }
        }

        function renderLevels(levels, currentPrice) {
            const container = document.getElementById('levels-list');
            if (!container) return;

            if (!levels || levels.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π</div>';
                return;
            }

            // Sort by distance from current price
            const sortedLevels = [...levels].sort((a, b) => {
                const distA = Math.abs((a.price - currentPrice) / currentPrice * 100);
                const distB = Math.abs((b.price - currentPrice) / currentPrice * 100);
                return distA - distB;
            });

            container.innerHTML = sortedLevels.map(level => {
                if (!level.is_active) return '';
                
                const distance = ((level.price - currentPrice) / currentPrice * 100);
                const distanceStr = distance >= 0 ? `+${distance.toFixed(2)}%` : `${distance.toFixed(2)}%`;
                
                return `
                    <div class="level-item">
                        <div class="level-price">$${formatPrice(level.price)}</div>
                        <div class="level-type">${level.level_type === 'support' ? '–ü–æ–¥–¥–µ—Ä–∂–∫–∞' : '–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ'}</div>
                        <div class="level-distance">${distanceStr} –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã</div>
                    </div>
                `;
            }).filter(html => html).join('');
        }


        // Utility Functions
        function formatPrice(price) {
            if (price >= 1000) {
                return price.toFixed(2);
            } else if (price >= 1) {
                return price.toFixed(4);
            } else {
                return price.toFixed(6);
            }
        }

        // Live Trading Toggle
        async function fetchLiveTradingStatus() {
            try {
                const response = await fetch(`${baseUrl}/api/trading/live/status`);
                const data = await response.json();
                if (typeof data.enabled === 'boolean') {
                    liveTradingEnabled = data.enabled;
                    updateLiveTradingToggleButton();
                }
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å live-—Ç–æ—Ä–≥–æ–≤–ª–∏:', error);
            }
        }

        function updateLiveTradingToggleButton() {
            const btn = document.getElementById('live-trading-toggle');
            if (!btn) return;
            btn.classList.toggle('live-on', liveTradingEnabled);
            btn.classList.toggle('live-off', !liveTradingEnabled);
            btn.textContent = liveTradingEnabled ? 'LIVE: –í–ö–õ' : 'LIVE: –í–´–ö–õ';
        }

        async function toggleLiveTrading(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            try {
                const response = await fetch(`${baseUrl}/api/trading/live/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !liveTradingEnabled })
                });
                const data = await response.json();
                if (typeof data.enabled === 'boolean') {
                    liveTradingEnabled = data.enabled;
                    updateLiveTradingToggleButton();
                }
            } catch (error) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å live-—Ä–µ–∂–∏–º:', error);
            }
        }

        // Design Menu
        function toggleDesignMenu() {
            const menu = document.getElementById('design-menu');
            const dropdown = document.querySelector('.design-dropdown');
            const isActive = menu && menu.classList.contains('active');
            const isCosmic = document.body.classList.contains('theme-cosmic');
            
            if (!menu) return;
            
            if (!isActive && dropdown) {
                if (isCosmic) {
                    // –î–ª—è –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —Ç–µ–º—ã –ø–µ—Ä–µ–º–µ—â–∞–µ–º –º–µ–Ω—é –≤ –∫–æ–Ω–µ—Ü body, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–±—Ä–µ–∑–∞–Ω–∏—è
                    const menuClone = menu.cloneNode(true);
                    menuClone.id = 'design-menu-cosmic';
                    menuClone.classList.add('cosmic-menu-portal');
                    document.body.appendChild(menuClone);
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
                    const rect = dropdown.getBoundingClientRect();
                    menuClone.style.position = 'fixed';
                    menuClone.style.top = (rect.bottom + 8) + 'px';
                    menuClone.style.right = (window.innerWidth - rect.right) + 'px';
                    menuClone.style.left = 'auto';
                    menuClone.style.bottom = 'auto';
                    menuClone.style.zIndex = '99999';
                    menuClone.style.display = 'block';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ–Ω—é
                    menuClone.querySelectorAll('.design-option').forEach(option => {
                        option.onclick = function() {
                            const theme = this.dataset.theme;
                            switchTheme(theme);
                            // –£–¥–∞–ª—è–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é
                            menuClone.remove();
                            menu.classList.remove('active');
                        };
                    });
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –º–µ–Ω—é
                    menu.style.display = 'none';
                } else {
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–µ–º —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏
                    menu.style.position = '';
                    menu.style.top = '';
                    menu.style.right = '';
                    menu.style.left = '';
                    menu.style.bottom = '';
                    menu.style.display = '';
                }
            } else if (isActive && isCosmic) {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π —Ç–µ–º–µ
                const cosmicMenu = document.getElementById('design-menu-cosmic');
                if (cosmicMenu) {
                    cosmicMenu.remove();
                }
                menu.style.display = '';
            }
            
            menu.classList.toggle('active');
            menu.classList.toggle('show'); // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        }

        function switchTheme(themeName) {
            console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã –Ω–∞:', themeName);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
            localStorage.setItem('selectedTheme', themeName);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É - —É–¥–∞–ª—è–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã —Ç–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π
            document.body.classList.remove('theme-cyberpunk', 'theme-classic', 'theme-cosmic');
            document.body.classList.add(`theme-${themeName}`);
            
            console.log('–¢–µ–∫—É—â–∏–µ –∫–ª–∞—Å—Å—ã body:', document.body.className);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
            document.querySelectorAll('.design-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === themeName) {
                    option.classList.add('active');
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–æ—Ç–∏–ø –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è)
            if (typeof updateLogo === 'function') {
                updateLogo(themeName);
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
            const menu = document.getElementById('design-menu');
            const cosmicMenu = document.getElementById('design-menu-cosmic');
            if (menu) {
                menu.classList.remove('active');
                menu.classList.remove('show');
            }
            if (cosmicMenu) {
                cosmicMenu.remove();
            }
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∫–µ—à–∏—Ä—É–µ—Ç)
            document.body.style.display = 'none';
            document.body.offsetHeight; // Trigger reflow
            document.body.style.display = '';
        }


        // Auto-update chart
        function startChartAutoUpdate() {
            if (chartUpdateInterval) {
                clearInterval(chartUpdateInterval);
            }
            
            if (!currentPair) {
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            const updateIntervals = {
                '1m': 30 * 1000,      // 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è 1-–º–∏–Ω—É—Ç–Ω—ã—Ö —Å–≤–µ—á–µ–π
                '5m': 60 * 1000,     // 1 –º–∏–Ω—É—Ç–∞ –¥–ª—è 5-–º–∏–Ω—É—Ç–Ω—ã—Ö
                '15m': 2 * 60 * 1000, // 2 –º–∏–Ω—É—Ç—ã –¥–ª—è 15-–º–∏–Ω—É—Ç–Ω—ã—Ö
                '1h': 5 * 60 * 1000,  // 5 –º–∏–Ω—É—Ç –¥–ª—è —á–∞—Å–æ–≤—ã—Ö
                '4h': 15 * 60 * 1000  // 15 –º–∏–Ω—É—Ç –¥–ª—è 4-—á–∞—Å–æ–≤—ã—Ö
            };
            
            const updateInterval = updateIntervals[currentTimeframe] || 60 * 1000; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –º–∏–Ω—É—Ç–∞
            
            chartUpdateInterval = setInterval(() => {
                if (currentPair) {
                    loadChartData(currentPair, currentTimeframe);
                    loadPairInfo(currentPair);
                }
            }, updateInterval);
        }

        // Close design menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.design-dropdown');
            const menu = document.getElementById('design-menu');
            const cosmicMenu = document.getElementById('design-menu-cosmic');
            const isCosmic = document.body.classList.contains('theme-cosmic');
            
            if (isCosmic && cosmicMenu && !cosmicMenu.contains(e.target) && dropdown && !dropdown.contains(e.target)) {
                cosmicMenu.remove();
                if (menu) {
                    menu.classList.remove('active');
                    menu.classList.remove('show');
                    menu.style.display = '';
                }
            } else if (!isCosmic && dropdown && !dropdown.contains(e.target)) {
                if (menu) {
                    menu.classList.remove('active');
                    menu.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>

