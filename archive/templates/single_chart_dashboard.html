<!DOCTYPE html>
<html>
<head>
    <title>BTC/USDT - Interactive Chart</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #131722;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .menu-bar {
            background-color: #1e222d;
            border-bottom: 1px solid #2B2B43;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        .menu-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .symbol-info {
            display: flex;
            flex-direction: column;
        }
        .symbol-name {
            font-size: 18px;
            font-weight: bold;
            color: #d1d4dc;
        }
        .current-price {
            font-size: 24px;
            font-weight: bold;
            color: #26a69a;
        }
        
        .connection-status {
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .status-connected {
            background-color: #26a69a;
            color: white;
        }
        
        .status-disconnected {
            background-color: #ef5350;
            color: white;
        }
        .timeframe-switcher {
            display: flex;
            gap: 5px;
        }
        .timeframe-btn {
            padding: 8px 16px;
            background-color: #2a2e39;
            color: #787b86;
            border: 1px solid #3a3f4b;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .timeframe-btn:hover {
            background-color: #3a3f4b;
            color: #d1d4dc;
        }
        .timeframe-btn.active {
            background-color: #2962ff;
            color: white;
            border-color: #2962ff;
        }
        .drawing-tools {
            display: flex;
            gap: 10px;
            margin-left: 20px;
            align-items: center;
        }
        .tool-group {
            display: flex;
            gap: 3px;
            padding: 2px;
            border-radius: 4px;
            background-color: #1a1e2a;
            border: 1px solid #2a2e39;
        }
        .tool-btn {
            padding: 8px 12px;
            background-color: #2a2e39;
            color: #787b86;
            border: 1px solid #3a3f4b;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
        }
        .tool-btn:hover {
            background-color: #3a3f4b;
            color: #d1d4dc;
        }
        .tool-btn.active {
            background-color: #26a69a;
            color: white;
            border-color: #26a69a;
        }
        .tool-btn.eraser {
            background-color: #ef5350;
            color: white;
            border-color: #ef5350;
        }
        .tool-btn.eraser:hover {
            background-color: #d32f2f;
        }
        .menu-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .control-btn {
            padding: 8px 16px;
            background-color: #2a2e39;
            color: #d1d4dc;
            border: 1px solid #3a3f4b;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .control-btn:hover {
            background-color: #3a3f4b;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            height: calc(100vh - 60px);
            padding: 20px;
        }
        .chart-section {
            background-color: #1e222d;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chart-title {
            font-size: 16px;
            font-weight: bold;
            color: #d1d4dc;
        }
        .chart-price {
            font-size: 18px;
            font-weight: bold;
            color: #26a69a;
        }
        .chart-wrapper {
            position: relative;
            flex: 1;
        }
        .chart-container {
            width: 100%;
            height: 600px;
            background-color: #131722;
            position: relative;
            z-index: 1;
        }
        .volume-container {
            height: 120px;
            background-color: #131722;
            border-radius: 4px;
            border-top: 1px solid #2B2B43;
        }
        .sidebar {
            background-color: #1e222d;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .signal-card {
            background-color: #2a2e39;
            padding: 15px;
            border-radius: 6px;
        }
        .signal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #d1d4dc;
        }
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #3a3f4b;
        }
        .signal-item:last-child {
            border-bottom: none;
        }
        .signal-label {
            color: #787b86;
            font-size: 12px;
        }
        .signal-value {
            color: #d1d4dc;
            font-weight: bold;
        }
        .signal-value.buy {
            color: #26a69a;
        }
        .signal-value.sell {
            color: #ef5350;
        }
        .signal-value.neutral {
            color: #787b86;
        }
        .stats-card {
            background-color: #2a2e39;
            padding: 15px;
            border-radius: 6px;
        }
        .stats-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #d1d4dc;
        }
        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #3a3f4b;
        }
        .stats-item:last-child {
            border-bottom: none;
        }
        .stats-label {
            color: #787b86;
            font-size: 12px;
        }
        .stats-value {
            color: #d1d4dc;
            font-weight: bold;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-buy {
            background-color: #26a69a;
        }
        .status-sell {
            background-color: #ef5350;
        }
        .status-neutral {
            background-color: #787b86;
        }
        .drawing-info {
            background-color: #2a2e39;
            padding: 15px;
            border-radius: 6px;
            margin-top: auto;
        }
        .drawing-info h3 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #d1d4dc;
        }
        .drawing-info p {
            font-size: 12px;
            color: #787b86;
            margin: 5px 0;
        }
        .drawing-info .key {
            color: #26a69a;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <script>
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —à–∞–±–ª–æ–Ω–∞ (Jinja2)
        // (–£–¥–∞–ª—è–µ–º –ª–æ–≥–∏ Jinja2, —Ç.–∫. –º–∞—Å—Å–∏–≤—ã —Å–≤–µ—á–µ–π –±–æ–ª—å—à–µ –Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è)
    </script>
    <div class="menu-bar">
        <div class="menu-left">
            <div class="symbol-info">
                <div class="symbol-name">BTC/USDT</div>
                <div class="current-price" id="current-price">$107838.66</div>
                <div class="connection-status" id="connection-status">üî¥ Offline</div>
            </div>
            
            <div class="timeframe-switcher">
                <button class="timeframe-btn active" onclick="switchTimeframe('5m')">5M</button>
                <button class="timeframe-btn" onclick="switchTimeframe('15m')">15M</button>
                <button class="timeframe-btn" onclick="switchTimeframe('1h')">1H</button>
                <button class="timeframe-btn" onclick="switchTimeframe('4h')">4H</button>
            </div>
            
            <div class="drawing-tools">
                <div class="tool-group">
                    <button class="tool-btn" onclick="setDrawingTool('horizontal')" title="–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è (H)">
                        <span>‚îÄ</span>
                    </button>
                    <button class="tool-btn" onclick="setDrawingTool('vertical')" title="–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è (V)">
                        <span>‚îÇ</span>
                    </button>
                    <button class="tool-btn" onclick="setDrawingTool('trend')" title="–õ–∏–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞ (T)">
                        <span>‚Üó</span>
                    </button>
                </div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="setDrawingTool('arrow')" title="–°—Ç—Ä–µ–ª–∫–∞ (A)">
                        <span>‚Üí</span>
                    </button>
                    <button class="tool-btn" onclick="setDrawingTool('rectangle')" title="–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (R)">
                        <span>‚ñ°</span>
                    </button>
                    <button class="tool-btn" onclick="setDrawingTool('ellipse')" title="–≠–ª–ª–∏–ø—Å (E)">
                        <span>‚óã</span>
                    </button>
                </div>
                
                <div class="tool-group">
                    <button class="tool-btn" onclick="setDrawingTool('fibonacci')" title="–§–∏–±–æ–Ω–∞—á—á–∏ (F)">
                        <span>F</span>
                    </button>
                    <button class="tool-btn" onclick="setDrawingTool('text')" title="–¢–µ–∫—Å—Ç (X)">
                        <span>T</span>
                    </button>
                    <button class="tool-btn eraser" onclick="setDrawingTool('eraser')" title="–õ–∞—Å—Ç–∏–∫ (Delete)">
                        <span>‚å´</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="menu-right">
            <button class="control-btn" onclick="clearAllDrawings()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <button class="control-btn" onclick="exportChart()">–≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">BTC/USDT - <span id="timeframe-display">5M</span></div>
                <div class="chart-price" id="chart-price">$107838.66</div>
            </div>
            
            <div class="chart-wrapper">
                <div id="chart" class="chart-container"></div>
            <div id="volume-chart" class="volume-container"></div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="signal-card">
                <div class="signal-title">–°–∏–≥–Ω–∞–ª—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
                            <div class="signal-item">
                    <span class="signal-label">–¢—Ä–µ–Ω–¥ 1H:</span>
                    <span class="signal-value neutral">
                        –ù–ò–°–•–û–î–Ø–©–ò–ô
                    </span>
                            </div>
                <div class="signal-item">
                    <span class="signal-label">ADX 1H:</span>
                    <span class="signal-value">0.0</span>
                </div>
                <div class="signal-item">
                    <span class="signal-label">–£—Ä–æ–≤–Ω–∏:</span>
                    <span class="signal-value">0</span>
                </div>
                <div class="signal-item">
                    <span class="signal-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–≥–Ω–∞–ª:</span>
                    <span class="signal-value neutral">
                        N/A
                    </span>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="stats-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="stats-item">
                    <span class="stats-label">–°–≤–µ—á–µ–π:</span>
                    <span class="stats-value" id="candles-count">288</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</span>
                    <span class="stats-value sell">
                        -0.58%
                    </span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">–û–±—ä–µ–º 24—á:</span>
                    <span class="stats-value">10,073</span>
                </div>
            </div>
            
            <div class="drawing-info">
                <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è</h3>
                <p><span class="key">H</span> - –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è</p>
                <p><span class="key">V</span> - –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è</p>
                <p><span class="key">T</span> - –õ–∏–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞</p>
                <p><span class="key">A</span> - –°—Ç—Ä–µ–ª–∫–∞</p>
                <p><span class="key">R</span> - –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</p>
                <p><span class="key">E</span> - –≠–ª–ª–∏–ø—Å</p>
                <p><span class="key">F</span> - –§–∏–±–æ–Ω–∞—á—á–∏</p>
                <p><span class="key">T</span> - –¢–µ–∫—Å—Ç</p>
                <p><span class="key">Delete</span> - –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</p>
                <p><span class="key">Esc</span> - –û—Ç–º–µ–Ω–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</p>
            </div>
        </div>
    </div>

    <script>
        // === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
        let chart, volumeChart, candlestick, volume;
        let currentTimeframe = '5m';
        let websocket = null;
        let ajaxInterval;
        // chartData —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ AJAX-–∑–∞–≥—Ä—É–∑–∫–∏
        let chartData = {};

        // === –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–≤–µ—á–µ–π —á–µ—Ä–µ–∑ AJAX –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ===
        function loadInitialCandles() {
            const ports = [8080, 8081, 5000];
            let portIndex = 0;
            function tryNextPort() {
                if (portIndex >= ports.length) {
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –ø–æ—Ä—Ç—É!');
                    return;
                }
                const port = ports[portIndex++];
                const url = `http://localhost:${port}/api/data`;
                console.log('üì° –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ—Ä—Ç—É', port + '...');
                fetch(url)
                    .then(r => r.json())
                    .then(resp => {
                        console.log('üì° –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', resp);
                        if (resp.status !== 'success') {
                            throw new Error('API error');
                        }
                        const data = resp.data;
                        console.log('üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);
                        // chartData —Ç–µ–ø–µ—Ä—å –º–∞—Å—Å–∏–≤—ã
                        chartData = data;
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                        initChartWithData(chartData);
                    })
                    .catch(e => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ—Ä—Ç—É', port + ':', e);
                        tryNextPort();
                    });
            }
            tryNextPort();
        }

        // === –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ ===
        function initChartWithData(chartData) {
            ['5m','15m','1h','4h'].forEach(tf => {
                const candles = chartData[tf];
                console.log(`[CHART INIT] –¢–∞–π–º—Ñ—Ä–µ–π–º ${tf}: typeof=`, typeof candles, ', Array.isArray=', Array.isArray(candles));
                if (Array.isArray(candles)) {
                    console.log(`[CHART INIT] ${tf} length:`, candles.length);
                    if (candles.length > 0) {
                        console.log(`[CHART INIT] ${tf} first:`, candles[0]);
                        console.log(`[CHART INIT] ${tf} last:`, candles[candles.length-1]);
                    }
                } else {
                    console.error(`[CHART INIT] ‚ùå chartData[${tf}] –Ω–µ –º–∞—Å—Å–∏–≤!`, candles);
                }
            });
            // –ü—Ä–∏–º–µ—Ä –¥–ª—è 5m
            const candles = chartData['5m'];
            if (!Array.isArray(candles)) {
                console.error('‚ùå chartData[5m] –Ω–µ –º–∞—Å—Å–∏–≤!', candles);
                return;
            }
            if (candles.length === 0) {
                console.warn('‚ö†Ô∏è chartData[5m] –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤!');
                return;
            }
            console.log(`[CHART INIT] –¢–∞–π–º—Ñ—Ä–µ–π–º 5m, —Å–≤–µ—á–µ–π: ${candles.length}`);
            // ... –∑–¥–µ—Å—å —Ç–≤–æ—è –ª–æ–≥–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ ...
            // chart.setData(candles) –∏ —Ç.–¥.
        }
        
        // === –ü—Ä–æ—Å—Ç—ã–µ AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ===
        function startAjaxUpdates() {
            console.log('üîÑ –ó–∞–ø—É—Å–∫ AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (ajaxInterval) {
                clearInterval(ajaxInterval);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            ajaxInterval = setInterval(() => {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ä–∞–∑–Ω—ã–º –ø–æ—Ä—Ç–∞–º
                const ports = [8080, 8081, 8082, 8083, 8084, 8085];
                let currentPortIndex = 0;
                
                function tryNextPort() {
                    if (currentPortIndex >= ports.length) {
                        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –ø–æ—Ä—Ç—É');
                        updateConnectionStatus(false);
                        return;
                    }
                    
                    const port = ports[currentPortIndex];
                    console.log(`üì° –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ—Ä—Ç—É ${port}...`);
                    
                    fetch(`http://localhost:${port}/api/data`)
                        .then(response => {
                            console.log('üì° –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('üì° –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
                            if (data.status === 'success' && data.data) {
                                console.log('üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data.data);
                                handleAjaxData(data.data);
                            } else {
                                console.warn('‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:', data);
                            }
                        })
                        .catch(error => {
                            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø–æ—Ä—Ç—É ${port}:`, error);
                            currentPortIndex++;
                            setTimeout(tryNextPort, 100); // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ 100–º—Å
                        });
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                tryNextPort();
            }, 5000);
        }
        
        function handleAjaxData(data) {
            console.log('üì° –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ AJAX:', data);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            Object.keys(data).forEach(interval => {
                if (data[interval]) {
                    console.log(`üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${interval}:`, data[interval]);
                    updateLiveData(interval, data[interval]);
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            updateConnectionStatus(true);
        }
        
        function updateLiveData(interval, newCandle) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            if (interval === currentTimeframe) {
                console.log(`üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${interval}:`, newCandle);
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–≤–µ—á—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                const newData = {
                    time: Math.floor(newCandle.timestamp / 1000),
                    open: newCandle.open,
                    high: newCandle.high,
                    low: newCandle.low,
                    close: newCandle.close,
                    volume: newCandle.volume
                };
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö
                if (!chartData[interval]) {
                    chartData[interval] = [];
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–≤–µ—á–∞ —Å —Ç–∞–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
                const existingIndex = chartData[interval].findIndex(candle => candle.time === newData.time);
                
                if (existingIndex >= 0) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–≤–µ—á—É
                    chartData[interval][existingIndex] = newData;
                    console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–≤–µ—á–∞: ${newData.time}`);
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å–≤–µ—á—É
                    chartData[interval].push(newData);
                    console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Å–≤–µ—á–∞: ${newData.time}`);
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                chartData[interval].sort((a, b) => a.time - b.time);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å–≤–µ—á–µ–π
                candlestick.setData(chartData[interval]);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–±—ä–µ–º–∞
                const volumeData = chartData[interval].map(item => ({
                        time: item.time,
                        value: item.volume,
                        color: item.close >= item.open ? '#26a69a' : '#ef5350'
                    }));
                    volume.setData(volumeData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                document.getElementById('chart-price').textContent = `$${newCandle.close.toFixed(2)}`;
                document.getElementById('current-price').textContent = `$${newCandle.close.toFixed(2)}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStatistics(newCandle);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–≤–µ—á–µ–π
                document.getElementById('candles-count').textContent = chartData[interval].length;
                
                console.log(`‚úÖ –ì—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω. –í—Å–µ–≥–æ —Å–≤–µ—á–µ–π: ${chartData[interval].length}`);
            }
        }
        
        function updateChartData(data) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö
            Object.keys(data).forEach(interval => {
                if (data[interval]) {
                    chartData[interval] = [{
                        time: Math.floor(data[interval].timestamp / 1000),
                        open: data[interval].open,
                        high: data[interval].high,
                        low: data[interval].low,
                        close: data[interval].close,
                        volume: data[interval].volume
                    }];
                }
            });
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                statusElement.textContent = connected ? 'üü¢ Live' : 'üî¥ Offline';
                statusElement.className = connected ? 'status-connected' : 'status-disconnected';
            }
        }
        
        function updateStatistics(latestCandle) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            const priceChange = latestCandle.close - latestCandle.open;
            const priceChangePercent = (priceChange / latestCandle.open) * 100;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã
            const changeElement = document.getElementById('price-change');
            if (changeElement) {
                const changeText = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)} (${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent.toFixed(2)}%)`;
                changeElement.textContent = changeText;
                changeElement.className = priceChange >= 0 ? 'positive-change' : 'negative-change';
            }
        }
        
        // === –°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è ===
        let drawingState = {
            mode: 'view', // 'view', 'drawing', 'selecting'
            currentTool: null,
            isDrawing: false,
            startPoint: null,
            endPoint: null,
            previewElement: null,
            selectedElement: null
        };
        
        // === –ö–æ–ª–ª–µ–∫—Ü–∏—è –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ===
        let drawingElements = [];
        
        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è ===
        function setDrawingTool(tool) {
            // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            
            if (tool === null) {
                drawingState.mode = 'view';
                drawingState.currentTool = null;
                clearPreview();
                return;
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            const toolBtn = document.querySelector(`[onclick="setDrawingTool('${tool}')"]`);
            if (toolBtn) toolBtn.classList.add('active');
            
            drawingState.mode = 'drawing';
            drawingState.currentTool = tool;
            clearPreview();
            
            console.log(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${tool}`);
        }
        
        function clearPreview() {
            if (drawingState.previewElement) {
                if (Array.isArray(drawingState.previewElement)) {
                    drawingState.previewElement.forEach(el => el.remove());
            } else {
                    drawingState.previewElement.remove();
                }
                drawingState.previewElement = null;
            }
        }

        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –≥—Ä–∞—Ñ–∏–∫–∞ ===
        function handleChartClick(param) {
            if (drawingState.mode === 'view') {
                // –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const clickedElement = findElementAtPoint(param.time, param.point);
                if (clickedElement) {
                    selectElement(clickedElement);
                    // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤—ã–±—Ä–∞–Ω
                    startDragging(param);
                } else {
                    selectElement(null);
                }
                return;
            }
            
            if (drawingState.mode === 'drawing') {
                // –†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                if (drawingState.currentTool === 'text') {
                    // –î–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–∑–¥–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
                    handleTextClick(param);
                } else if (drawingState.currentTool === 'eraser') {
                    // –î–ª—è –ª–∞—Å—Ç–∏–∫–∞ —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
                    const elementToDelete = findElementAtPoint(param.time, param.point);
                    if (elementToDelete) {
                        deleteElement(elementToDelete);
                    }
                } else if (!drawingState.isDrawing) {
                    // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - –Ω–∞—á–∞–ª–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                    startDrawing(param);
                } else {
                    // –í—Ç–æ—Ä–æ–π –∫–ª–∏–∫ - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                    finishDrawing(param);
                }
            }
        }
        
        // === –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è ===
        let isDragging = false;
        let dragStartPoint = null;
        
        function startDragging(param) {
            if (drawingState.selectedElement) {
                isDragging = true;
                dragStartPoint = {
                time: param.time,
                    price: param.seriesData.get(candlestick)?.close || 0
                };
                console.log('–ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞:', drawingState.selectedElement.type);
            }
        }
        
        function moveElement(element, newTime, newPrice) {
            if (!element) return;
            
            switch (element.type) {
                case 'horizontal':
                    if (element.priceLine) {
                        element.priceLine.applyOptions({
                            price: newPrice,
                            title: `–£—Ä–æ–≤–µ–Ω—å ${newPrice.toFixed(2)}`
                        });
                        element.price = newPrice;
                    }
                    break;
                case 'text':
                    if (element.marker) {
                        const newMarkers = [{
                            time: newTime,
                            position: 'inBar',
                            color: element.marker.color,
                            shape: element.marker.shape,
                            text: element.marker.text
                        }];
                        candlestick.setMarkers(newMarkers);
                        element.time = newTime;
                        element.price = newPrice;
                    }
                    break;
                case 'trend':
                    if (element.series) {
                        // –î–ª—è –ª–∏–Ω–∏–∏ —Ç—Ä–µ–Ω–¥–∞ –ø–µ—Ä–µ–º–µ—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É
                        element.series.setData([
                            { time: element.startTime, value: element.startPrice },
                            { time: newTime, value: newPrice }
                        ]);
                        element.endTime = newTime;
                        element.endPrice = newPrice;
                    }
                    break;
                case 'arrow':
                case 'rectangle':
                    if (element.series) {
                        element.series.setData([
                            { time: element.startTime, value: element.startPrice },
                            { time: newTime, value: newPrice }
                        ]);
                        element.endTime = newTime;
                        element.endPrice = newPrice;
                    }
                    break;
            }
        }
        
        function handleDrag(param) {
            if (isDragging && drawingState.selectedElement && dragStartPoint) {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
                let currentPrice = 0;
                if (param.seriesData && param.seriesData.size > 0) {
                    const seriesData = param.seriesData.get(candlestick);
                    if (seriesData) {
                        currentPrice = seriesData.close;
                    }
                }
                
                if (currentPrice === 0 && param.point) {
                    currentPrice = getPriceFromPoint(param.point);
                }
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
                if (param.time !== dragStartPoint.time || Math.abs(currentPrice - dragStartPoint.price) > 1) {
                    moveElement(drawingState.selectedElement, param.time, currentPrice);
                    dragStartPoint = { time: param.time, price: currentPrice };
                }
            }
        }
        
        function stopDragging() {
            isDragging = false;
            dragStartPoint = null;
            console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
        }
        
        function moveElement(element, newTime, newPrice) {
            if (!element) return;
            
            switch (element.type) {
                case 'text':
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏
                    element.series.setData([
                        { time: newTime, value: newPrice }
                    ]);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
                    const markers = [{
                        time: newTime,
                        position: 'aboveBar',
                        color: '#ffeb3b', // –ñ–µ–ª—Ç—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                        shape: 'circle',
                        text: element.text,
                        size: 1
                    }];
                    element.series.setMarkers(markers);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
                    element.time = newTime;
                    element.price = newPrice;
                    break;
                    
                case 'horizontal':
                    if (element.priceLine) {
                        element.priceLine.applyOptions({ price: newPrice });
                        element.price = newPrice;
                    }
                    break;
                    
                case 'vertical':
                    // –î–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                    element.series.setData([
                        { time: newTime, value: element.price }
                    ]);
                    element.time = newTime;
                    break;
                    
                case 'trend':
                case 'arrow':
                case 'rectangle':
                    // –î–ª—è –ª–∏–Ω–∏–π –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫—É
                    element.series.setData([
                        { time: element.startTime, value: element.startPrice },
                        { time: newTime, value: newPrice }
                    ]);
                    element.endTime = newTime;
                    element.endPrice = newPrice;
                    break;
            }
        }
        
        function handleTextClick(param) {
            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–∏–∏
            let price = 0;
            if (param.seriesData && param.seriesData.size > 0) {
                const seriesData = param.seriesData.get(candlestick);
                if (seriesData) {
                    price = seriesData.close;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            if (price === 0 && param.point) {
                price = getPriceFromPoint(param.point);
            }
            
            const point = {
                time: param.time,
                price: price
            };
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é
            const element = createTextAnnotation(point);
            if (element) {
                drawingElements.push(element);
                console.log(`–°–æ–∑–¥–∞–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è:`, element);
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            setDrawingTool(null);
        }
        
        function startDrawing(param) {
            drawingState.isDrawing = true;
            
            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–∏–∏
            let price = 0;
            if (param.seriesData && param.seriesData.size > 0) {
                const seriesData = param.seriesData.get(candlestick);
                if (seriesData) {
                    price = seriesData.close;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            if (price === 0 && param.point) {
                price = getPriceFromPoint(param.point);
            }
            
            drawingState.startPoint = {
                time: param.time,
                price: price
            };
            
            console.log(`–ù–∞—á–∞–ª–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è ${drawingState.currentTool} –≤ —Ç–æ—á–∫–µ:`, drawingState.startPoint);
        }
        
        function finishDrawing(param) {
            if (!drawingState.startPoint) return;
            
            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–∏–∏
            let price = 0;
            if (param.seriesData && param.seriesData.size > 0) {
                const seriesData = param.seriesData.get(candlestick);
                if (seriesData) {
                    price = seriesData.close;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            if (price === 0 && param.point) {
                price = getPriceFromPoint(param.point);
            }
            
            const endPoint = {
                time: param.time,
                price: price
            };
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            const element = createDrawingElement(drawingState.currentTool, drawingState.startPoint, endPoint);
            if (element) {
                drawingElements.push(element);
                console.log(`–°–æ–∑–¥–∞–Ω —ç–ª–µ–º–µ–Ω—Ç:`, element);
            }
            
            // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            clearPreview();
            drawingState.isDrawing = false;
            drawingState.startPoint = null;
            drawingState.endPoint = null;
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                setDrawingTool(null);
        }
        
        function handleChartMouseMove(param) {
            if (drawingState.mode === 'drawing' && drawingState.isDrawing && drawingState.currentTool !== 'text') {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –º—ã—à–∏
                updatePreview(param);
            }
        }
        
        function updatePreview(param) {
            if (!drawingState.startPoint) return;
            
            clearPreview();
            
            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–∏–∏
            let currentPrice = 0;
            if (param.seriesData && param.seriesData.size > 0) {
                const seriesData = param.seriesData.get(candlestick);
                if (seriesData) {
                    currentPrice = seriesData.close;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            if (currentPrice === 0 && param.point) {
                currentPrice = getPriceFromPoint(param.point);
            }
            
            switch (drawingState.currentTool) {
                case 'horizontal':
                    createHorizontalLinePreview(drawingState.startPoint.price);
                    break;
                case 'vertical':
                    createVerticalLinePreview(drawingState.startPoint.time);
                    break;
                case 'trend':
                    createTrendLinePreview(drawingState.startPoint, { time: param.time, price: currentPrice });
                    break;
                case 'arrow':
                    createArrowPreview(drawingState.startPoint, { time: param.time, price: currentPrice });
                    break;
                case 'rectangle':
                    createRectanglePreview(drawingState.startPoint, { time: param.time, price: currentPrice });
                    break;
                case 'text':
                    createTextPreview({ time: param.time, price: currentPrice });
                    break;
            }
        }
        
        // === –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è ===
        function createDrawingElement(type, startPoint, endPoint) {
            switch (type) {
                case 'horizontal':
                    return createHorizontalLine(startPoint.price);
                case 'vertical':
                    return createVerticalLine(startPoint.time);
                case 'trend':
                    return createTrendLine(startPoint, endPoint);
                case 'arrow':
                    return createArrow(startPoint, endPoint);
                case 'rectangle':
                    return createRectangle(startPoint, endPoint);
                case 'text':
                    return createTextAnnotation(startPoint);
                default:
                    return null;
            }
        }
        
        function createHorizontalLine(price) {
            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ createPriceLine –Ω–∞ —Å–µ—Ä–∏–∏ candlestick
            const priceLine = candlestick.createPriceLine({
                price: price,
                        color: '#26a69a',
                        lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Solid,
                axisLabelVisible: true,
                title: `–£—Ä–æ–≤–µ–Ω—å ${price.toFixed(2)}`
            });
            
            return {
                        type: 'horizontal',
                price: price,
                priceLine: priceLine,
                id: Date.now()
            };
        }
        
        function createHorizontalLinePreview(price) {
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—É—é –ª–∏–Ω–∏—é
            const priceLine = candlestick.createPriceLine({
                price: price,
                            color: '#26a69a',
                            lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                axisLabelVisible: true,
                title: `–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å ${price.toFixed(2)}`
            });
            
            drawingState.previewElement = priceLine;
        }
        
        function createVerticalLine(time) {
            // –î–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞—Ä–∫–µ—Ä—ã
            const markers = [{
                time: time,
                position: 'inBar',
                color: '#ef5350',
                shape: 'circle',
                text: '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è'
            }];
            
            // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ—Ä–∏—é –º–∞—Ä–∫–µ—Ä–æ–≤
            const markerSeries = chart.addLineSeries({
                color: '#ef5350',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Solid,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
            markerSeries.setMarkers(markers);
            
            return {
                            type: 'vertical',
                time: time,
                series: markerSeries,
                id: Date.now()
            };
        }
        
        function createVerticalLinePreview(time) {
            const markers = [{
                time: time,
                position: 'inBar',
                color: '#ef5350',
                shape: 'circle',
                text: '–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è'
            }];
            
            const markerSeries = chart.addLineSeries({
                color: '#ef5350',
                        lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            markerSeries.setMarkers(markers);
            drawingState.previewElement = markerSeries;
        }
        
        function createTrendLine(startPoint, endPoint) {
            // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ—Ä–∏—é –¥–ª—è –ª–∏–Ω–∏–∏ —Ç—Ä–µ–Ω–¥–∞
            const lineSeries = chart.addLineSeries({
                color: '#2962ff',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Solid,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            lineSeries.setData([
                { time: startPoint.time, value: startPoint.price },
                { time: endPoint.time, value: endPoint.price }
            ]);
            
            return {
                        type: 'trend',
                startTime: startPoint.time,
                startPrice: startPoint.price,
                endTime: endPoint.time,
                endPrice: endPoint.price,
                series: lineSeries,
                id: Date.now()
            };
        }
        
        function createTrendLinePreview(startPoint, endPoint) {
            const lineSeries = chart.addLineSeries({
                color: '#2962ff',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            lineSeries.setData([
                { time: startPoint.time, value: startPoint.price },
                { time: endPoint.time, value: endPoint.price }
            ]);
            
            drawingState.previewElement = lineSeries;
        }
        
        function createArrow(startPoint, endPoint) {
            const lineSeries = chart.addLineSeries({
                color: '#ff9800',
                lineWidth: 3,
                lineStyle: LightweightCharts.LineStyle.Solid,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–µ–ª–∫—É –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤
            const arrowData = calculateArrowPoints(startPoint, endPoint);
            lineSeries.setData(arrowData);
            
            return {
                type: 'arrow',
                startTime: startPoint.time,
                startPrice: startPoint.price,
                endTime: endPoint.time,
                endPrice: endPoint.price,
                series: lineSeries,
                id: Date.now()
            };
        }
        
        function createArrowPreview(startPoint, endPoint) {
            const lineSeries = chart.addLineSeries({
                color: '#ff9800',
                lineWidth: 3,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            const arrowData = calculateArrowPoints(startPoint, endPoint);
            lineSeries.setData(arrowData);
            
            drawingState.previewElement = lineSeries;
        }
        
        function calculateArrowPoints(startPoint, endPoint) {
            // –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–µ–ª–∫–∞ - –ª–∏–Ω–∏—è —Å –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫–æ–º
            const dx = endPoint.time - startPoint.time;
            const dy = endPoint.price - startPoint.price;
            const arrowLength = Math.abs(dx) * 0.1; // 10% –æ—Ç –¥–ª–∏–Ω—ã –ª–∏–Ω–∏–∏
            
            const arrowData = [
                { time: startPoint.time, value: startPoint.price },
                { time: endPoint.time, value: endPoint.price }
            ];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∫–æ–Ω–µ—á–Ω–∏–∫ —Å—Ç—Ä–µ–ª–∫–∏
            if (dx > 0) {
                arrowData.push({ time: endPoint.time - arrowLength, value: endPoint.price - dy * 0.1 });
                arrowData.push({ time: endPoint.time, value: endPoint.price });
                arrowData.push({ time: endPoint.time - arrowLength, value: endPoint.price + dy * 0.1 });
            }
            
            return arrowData;
        }
        
        function createRectangle(startPoint, endPoint) {
            const lineSeries = chart.addLineSeries({
                color: '#9c27b0',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Solid,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∏–∑ 4 –ª–∏–Ω–∏–π
            const rectData = [
                { time: startPoint.time, value: startPoint.price },
                { time: endPoint.time, value: startPoint.price },
                { time: endPoint.time, value: endPoint.price },
                { time: startPoint.time, value: endPoint.price },
                { time: startPoint.time, value: startPoint.price }
            ];
            
            lineSeries.setData(rectData);
            
            return {
                type: 'rectangle',
                startTime: startPoint.time,
                startPrice: startPoint.price,
                endTime: endPoint.time,
                endPrice: endPoint.price,
                series: lineSeries,
                id: Date.now()
            };
        }
        
        function createRectanglePreview(startPoint, endPoint) {
                    const lineSeries = chart.addLineSeries({
                color: '#9c27b0',
                lineWidth: 2,
                lineStyle: LightweightCharts.LineStyle.Dashed,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            const rectData = [
                { time: startPoint.time, value: startPoint.price },
                { time: endPoint.time, value: startPoint.price },
                { time: endPoint.time, value: endPoint.price },
                { time: startPoint.time, value: endPoint.price },
                { time: startPoint.time, value: startPoint.price }
            ];
            
            lineSeries.setData(rectData);
            
            drawingState.previewElement = lineSeries;
        }
        
        function createTextAnnotation(point) {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const text = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏:', '–¢–µ–∫—Å—Ç');
            if (!text) return null;
            
            // –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–µ—Ä–∏—é –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
            const markerSeries = chart.addLineSeries({
                color: '#ffffff',
                lineWidth: 0,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Ä–∏—é (–Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤)
            markerSeries.setData([
                { time: point.time, value: point.price }
            ]);
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å —Ç–µ–∫—Å—Ç–æ–º
            const markers = [{
                time: point.time,
                position: 'aboveBar',
                color: '#ffffff',
                shape: 'circle',
                text: text,
                size: 1
            }];
            
            markerSeries.setMarkers(markers);
            
            return {
                type: 'text',
                time: point.time,
                price: point.price,
                text: text,
                series: markerSeries,
                id: Date.now()
            };
        }
        
        function createTextPreview(point) {
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
            const markerSeries = chart.addLineSeries({
                color: '#ffffff',
                lineWidth: 0,
                lastValueVisible: false,
                priceLineVisible: false
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Ä–∏—é
            markerSeries.setData([
                { time: point.time, value: point.price }
            ]);
            
            const markers = [{
                time: point.time,
                position: 'aboveBar',
                color: '#ffffff',
                shape: 'circle',
                text: '–¢–µ–∫—Å—Ç',
                size: 1
            }];
            
            markerSeries.setMarkers(markers);
            drawingState.previewElement = markerSeries;
        }
        
        // === –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ ===
        function selectElement(element) {
            drawingState.selectedElement = element;
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            drawingElements.forEach(el => {
                if (el.series) {
                    if (el.type === 'text') {
                        // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞
                        const markers = el === element ? 
                            [{ time: el.time, position: 'aboveBar', color: '#ffeb3b', shape: 'circle', text: el.text, size: 1 }] :
                            [{ time: el.time, position: 'aboveBar', color: '#ffffff', shape: 'circle', text: el.text, size: 1 }];
                        el.series.setMarkers(markers);
                    } else {
                        el.series.applyOptions({ lineWidth: el === element ? 4 : 2 });
                    }
                }
                if (el.priceLine) {
                    el.priceLine.applyOptions({ 
                        lineWidth: el === element ? 4 : 2,
                        color: el === element ? '#ffeb3b' : '#26a69a'
                    });
                }
            });
            
            console.log('–í—ã–±—Ä–∞–Ω —ç–ª–µ–º–µ–Ω—Ç:', element);
        }
        
        function deleteElement(element) {
            if (!element) return;
            
            const index = drawingElements.indexOf(element);
            if (index > -1) {
                drawingElements.splice(index, 1);
            }
            
            if (element.series) {
                    if (Array.isArray(element.series)) {
                        element.series.forEach(series => {
                            if (series && typeof series.remove === 'function') {
                                series.remove();
                            }
                        });
                    } else {
                        if (typeof element.series.remove === 'function') {
                            element.series.remove();
                        }
                    }
                }
            if (element.priceLine) {
                if (typeof element.priceLine.remove === 'function') {
                    element.priceLine.remove();
                }
            }
            if (element.marker) {
                candlestick.setMarkers([]);
            }
            
            // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª –≤—ã–±—Ä–∞–Ω, —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (drawingState.selectedElement === element) {
                drawingState.selectedElement = null;
            }
            
            console.log('–≠–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω:', element.type);
        }
        
        function deleteSelectedElement() {
            if (drawingState.selectedElement) {
                deleteElement(drawingState.selectedElement);
            }
        }
        
        function findElementAtPoint(time, point) {
            if (!time || !point) return null;
            
            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —ç–ª–µ–º–µ–Ω—Ç
            for (let element of drawingElements) {
                if (isPointNearElement(element, time, point)) {
                    return element;
                }
            }
            return null;
        }
        
        function isPointNearElement(element, time, point) {
            if (!element) return false;
            
            const tolerance = 20; // –ü–∏–∫—Å–µ–ª–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–ª–∏–∑–æ—Å—Ç–∏
            
            switch (element.type) {
                case 'horizontal':
                    const price = getPriceFromPoint(point);
                    return Math.abs(price - element.price) < tolerance;
                    
                case 'vertical':
                    return Math.abs(time - element.time) < tolerance;
                    
                case 'text':
                    // –î–ª—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–∏–∑–æ—Å—Ç—å –∫ —Ç–æ—á–∫–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ü–µ–Ω—ã
                    const textPrice = getPriceFromPoint(point);
                    const timeDiff = Math.abs(time - element.time);
                    const priceDiff = Math.abs(textPrice - element.price);
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º tolerance –¥–ª—è —Ç–µ–∫—Å—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ —Å–ª–æ–∂–Ω–µ–µ –∫–ª–∏–∫–Ω—É—Ç—å
                    return timeDiff < tolerance * 2 && priceDiff < tolerance * 2;
                    
                case 'trend':
                case 'arrow':
                case 'rectangle':
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ª–∏–Ω–∏–∏
                    const distance = distanceToLine(
                        time, getPriceFromPoint(point),
                        element.startTime, element.startPrice,
                        element.endTime, element.endPrice
                    );
                    return distance < tolerance;
                    
                default:
                    return false;
            }
        }
        
        function distanceToLine(x, y, x1, y1, x2, y2) {
            const A = x - x1;
            const B = y - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;
            
            if (lenSq !== 0) param = dot / lenSq;
            
            let xx, yy;
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = x - xx;
            const dy = y - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        function getPriceFromPoint(point) {
            if (!point) return 0;
            
            // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
            const data = chartData[currentTimeframe];
            if (data && data.length > 0) {
                const maxPrice = Math.max(...data.map(d => d.high));
                const minPrice = Math.min(...data.map(d => d.low));
                const chartHeight = chart.clientHeight;
                const pricePerPixel = (maxPrice - minPrice) / chartHeight;
                return maxPrice - (point.y * pricePerPixel);
            }
            return 0;
        }
        
        function clearAllDrawings() {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            drawingElements.forEach(element => {
                deleteElement(element);
            });
            
            drawingElements = [];
            drawingState.selectedElement = null;
            clearPreview();
            
            console.log('–í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã');
        }
        
        // === –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º–∏ ===
        function switchTimeframe(timeframe) {
            currentTimeframe = timeframe;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('timeframe-display').textContent = timeframe.toUpperCase();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
            const data = chartData[timeframe];
            if (data && data.length > 0) {
                candlestick.setData(data);
                const volumeData = data.map(item => ({
                    time: item.time,
                    value: item.volume,
                    color: item.close >= item.open ? '#26a69a' : '#ef5350'
                }));
                volume.setData(volumeData);
                document.getElementById('candles-count').textContent = data.length;
            }
            
            // –ü–æ–¥–≥–æ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            chart.timeScale().fitContent();
            volumeChart.timeScale().fitContent();
        }

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ ===
        function initCharts() {
            // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫
            chart = LightweightCharts.createChart(document.getElementById('chart'), {
                width: document.getElementById('chart').clientWidth,
                height: document.getElementById('chart').clientHeight,
                layout: {
                    background: {
                        type: 'solid',
                        color: '#1e222d',
                    },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: {
                        color: '#2B2B43',
                    },
                    horzLines: {
                        color: '#2B2B43',
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2B2B43',
                },
                timeScale: {
                    borderColor: '#2B2B43',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –æ–±—ä–µ–º–∞
            volumeChart = LightweightCharts.createChart(document.getElementById('volume-chart'), {
                width: document.getElementById('volume-chart').clientWidth,
                height: document.getElementById('volume-chart').clientHeight,
                layout: {
                    background: {
                        type: 'solid',
                        color: '#131722',
                    },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: {
                        color: '#2B2B43',
                    },
                    horzLines: {
                        color: '#2B2B43',
                    },
                },
                rightPriceScale: {
                    borderColor: '#2B2B43',
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0.1,
                    },
                },
                timeScale: {
                    borderColor: '#2B2B43',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫
            candlestick = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderDownColor: '#ef5350',
                borderUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                wickUpColor: '#26a69a',
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–º
            volume = volumeChart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            const data = chartData[currentTimeframe];
            if (data && data.length > 0) {
                candlestick.setData(data);
                const volumeData = data.map(item => ({
                    time: item.time,
                    value: item.volume,
                    color: item.close >= item.open ? '#26a69a' : '#ef5350'
                }));
                volume.setData(volumeData);
                document.getElementById('candles-count').textContent = data.length;
            }

            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã
            chart.subscribeCrosshairMove(param => {
                if (param.time && param.seriesData.size > 0) {
                    const price = param.seriesData.get(candlestick);
                    if (price) {
                        document.getElementById('chart-price').textContent = `$${price.close.toFixed(2)}`;
                    }
                }
            });

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∫–∞–ª—ã
            chart.timeScale().subscribeVisibleTimeRangeChange(() => {
                const timeRange = chart.timeScale().getVisibleRange();
                if (timeRange) {
                    volumeChart.timeScale().setVisibleRange(timeRange);
                }
            });

            // === –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ ===
            chart.subscribeClick(param => {
                    handleChartClick(param);
            });
            
            // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è ===
            chart.subscribeCrosshairMove(param => {
                handleChartMouseMove(param);
                if (isDragging && drawingState.selectedElement) {
                    handleDrag(param);
                }
            });
            
            // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –º—ã—à–∏ ===
            document.addEventListener('mouseup', () => {
                stopDragging();
            });

            // –ü–æ–¥–≥–æ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            chart.timeScale().fitContent();
            volumeChart.timeScale().fitContent();
        }
        
        // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã ===
        document.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'Delete':
                case 'Backspace':
                    deleteSelectedElement();
                    break;
                case 'Escape':
                    setDrawingTool(null);
                    selectElement(null);
                    break;
                case 'h':
                case 'H':
                    setDrawingTool('horizontal');
                    break;
                case 'v':
                case 'V':
                    setDrawingTool('vertical');
                    break;
                case 't':
                case 'T':
                    setDrawingTool('trend');
                    break;
                case 'a':
                case 'A':
                    setDrawingTool('arrow');
                    break;
                case 'r':
                case 'R':
                    setDrawingTool('rectangle');
                    break;
            }
        });

        // === –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ ===
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart').clientWidth,
                    height: document.getElementById('chart').clientHeight
                });
            }
            if (volumeChart) {
                volumeChart.applyOptions({
                    width: document.getElementById('volume-chart').clientWidth,
                    height: document.getElementById('volume-chart').clientHeight
                });
            }
        });

        // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialCandles();
        });

        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ chartData –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:
        document.addEventListener('DOMContentLoaded', function() {
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –≤—ã–≤–æ–¥–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—á–µ–π –∏ –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–π/–ø–æ—Å–ª–µ–¥–Ω–µ–π
            Object.keys(chartData).forEach(tf => {
                if (chartData[tf] && chartData[tf].length > 0) {
                    const first = chartData[tf][0];
                    const last = chartData[tf][chartData[tf].length-1];
                    console.log(`–¢–∞–π–º—Ñ—Ä–µ–π–º ${tf}: ${chartData[tf].length} —Å–≤–µ—á–µ–π`);
                    console.log(`  –ü–µ—Ä–≤–∞—è: ${new Date(first.time*1000).toLocaleString()} (${first.time})`);
                    console.log(`  –ü–æ—Å–ª–µ–¥–Ω—è—è: ${new Date(last.time*1000).toLocaleString()} (${last.time})`);
                }
            });
            // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö —Å–≤–µ—á–µ–π
            const btn = document.createElement('button');
            btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–≤–µ—á–∏';
            btn.style.position = 'fixed';
            btn.style.top = '10px';
            btn.style.right = '10px';
            btn.style.zIndex = 1000;
            btn.onclick = function() {
                if (typeof chart !== 'undefined' && chart.timeScale) {
                    chart.timeScale().fitContent();
                }
                if (typeof volumeChart !== 'undefined' && volumeChart.timeScale) {
                    volumeChart.timeScale().fitContent();
                }
            };
            document.body.appendChild(btn);
        });

        document.addEventListener('DOMContentLoaded', function() {
            // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –≤—ã–≤–æ–¥–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            Object.keys(chartData).forEach(tf => {
                if (chartData[tf] && chartData[tf].length > 0) {
                    const first = chartData[tf][0];
                    const last = chartData[tf][chartData[tf].length-1];
                    console.log(`[DIAG] chartData[${tf}]: ${chartData[tf].length} —Å–≤–µ—á–µ–π`);
                    console.log(`[DIAG] chartData[${tf}] –ø–µ—Ä–≤–∞—è:`, first);
                    console.log(`[DIAG] chartData[${tf}] –ø–æ—Å–ª–µ–¥–Ω—è—è:`, last);
                }
            });
            // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞–Ω–Ω—ã—Ö
            const btn = document.createElement('button');
            btn.textContent = '–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö';
            btn.style.position = 'fixed';
            btn.style.top = '50px';
            btn.style.right = '10px';
            btn.style.zIndex = 1000;
            btn.onclick = function() {
                const tf = currentTimeframe;
                if (chartData[tf] && chartData[tf].length > 0) {
                    const first = chartData[tf][0];
                    const last = chartData[tf][chartData[tf].length-1];
                    alert(`–¢–∞–π–º—Ñ—Ä–µ–π–º: ${tf}\n–°–≤–µ—á–µ–π: ${chartData[tf].length}\n–ü–µ—Ä–≤–∞—è: ${new Date(first.time*1000).toLocaleString()}\n–ü–æ—Å–ª–µ–¥–Ω—è—è: ${new Date(last.time*1000).toLocaleString()}`);
                } else {
                    alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞');
                }
            };
            document.body.appendChild(btn);
        });
    </script>
</body>
</html> 