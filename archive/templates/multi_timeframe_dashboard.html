<!DOCTYPE html>
<html>
<head>
    <title>{{ symbol }} - Multi Timeframe Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #131722;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-container {
            background-color: #1e222d;
            border-radius: 8px;
            padding: 15px;
            height: calc((100vh - 120px) / 3);
        }
        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        .chart {
            width: 100%;
            height: calc(100% - 40px);
        }
        .sidebar {
            background-color: #1e222d;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .price-card {
            background-color: #2a2e39;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .current-price {
            font-size: 24px;
            font-weight: bold;
            color: #26a69a;
        }
        .signal-card {
            background-color: #2a2e39;
            padding: 15px;
            border-radius: 6px;
        }
        .signal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .signal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #3a3f4b;
        }
        .signal-item:last-child {
            border-bottom: none;
        }
        .signal-timeframe {
            font-weight: bold;
        }
        .signal-value {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .signal-buy {
            background-color: #26a69a;
            color: white;
        }
        .signal-sell {
            background-color: #ef5350;
            color: white;
        }
        .signal-hold {
            background-color: #ff9800;
            color: white;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .control-btn {
            padding: 8px 16px;
            background-color: #2962ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .control-btn:hover {
            background-color: #1e53e5;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="charts-section">
            <div class="controls">
                <button class="control-btn" onclick="fitAllCharts()">Весь период</button>
                <button class="control-btn" onclick="showLastCandles(50)">Последние 50</button>
                <button class="control-btn" onclick="showLastCandles(20)">Последние 20</button>
                <button class="control-btn" onclick="resetCharts()">Сброс</button>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">
                    <span>5M Таймфрейм</span>
                    <span id="price-5m">Загрузка...</span>
                </div>
                <div id="chart-5m" class="chart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">
                    <span>15M Таймфрейм</span>
                    <span id="price-15m">Загрузка...</span>
                </div>
                <div id="chart-15m" class="chart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">
                    <span>1H Таймфрейм</span>
                    <span id="price-1h">Загрузка...</span>
                </div>
                <div id="chart-1h" class="chart"></div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="price-card">
                <div>Текущая цена</div>
                <div class="current-price" id="current-price">
                    {% if current_price %}${{ "{:,.2f}".format(current_price) }}{% else %}Загрузка...{% endif %}
                </div>
            </div>
            
            <div class="signal-card">
                <div class="signal-title">Торговые сигналы</div>
                {% if analysis_results %}
                    {% for timeframe in ['5m', '15m', '1h'] %}
                        {% if timeframe in analysis_results %}
                            {% set analysis = analysis_results[timeframe] %}
                            {% set signal_class = 'signal-buy' if analysis.signal == 'ПОКУПКА' else 'signal-sell' if analysis.signal == 'ПРОДАЖА' else 'signal-hold' %}
                            <div class="signal-item">
                                <span class="signal-timeframe">{{ timeframe.upper() }}</span>
                                <span class="signal-value {{ signal_class }}">{{ analysis.signal }} ({{ "%.0f"|format(analysis.confidence) }}%)</span>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div>Анализ не выполнен</div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // === Глобальные переменные ===
        const charts = {};
        const candlestickSeries = {};
        const volumeSeries = {};
        const chartData = {{ chart_data | safe }};

        // === Функции для управления графиками ===
        function showLastCandles(count) {
            Object.entries(charts).forEach(([timeframe, chart]) => {
                const data = chartData[timeframe];
                if (data && data.length >= count) {
                    const lastCandles = data.slice(-count);
                    const timeRange = {
                        from: lastCandles[0].time,
                        to: lastCandles[lastCandles.length-1].time
                    };
                    chart.timeScale().setVisibleRange(timeRange);
                }
            });
        }

        function fitAllCharts() {
            Object.values(charts).forEach(chart => {
                chart.timeScale().fitContent();
            });
        }

        function resetCharts() {
            Object.values(charts).forEach(chart => {
                chart.timeScale().scrollToPosition(0, false);
            });
        }

        // === Создание графика ===
        function createChart(containerId, data, timeframe) {
            const chart = LightweightCharts.createChart(document.getElementById(containerId), {
                width: document.getElementById(containerId).clientWidth,
                height: document.getElementById(containerId).clientHeight,
                layout: {
                    background: {
                        type: 'solid',
                        color: '#1e222d',
                    },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: {
                        color: '#2B2B43',
                    },
                    horzLines: {
                        color: '#2B2B43',
                    },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2B2B43',
                },
                timeScale: {
                    borderColor: '#2B2B43',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            // Добавляем свечной график
            const candlestick = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderDownColor: '#ef5350',
                borderUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                wickUpColor: '#26a69a',
            });
            
            candlestick.setData(data);
            
            // Добавляем объем
            const volume = chart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
            });
            
            const volumeData = data.map(item => ({
                time: item.time,
                value: item.volume,
                color: item.close >= item.open ? '#26a69a' : '#ef5350'
            }));
            volume.setData(volumeData);
            
            // Подписываемся на изменения цены
            chart.subscribeCrosshairMove(param => {
                if (param.time && param.seriesData.size > 0) {
                    const price = param.seriesData.get(candlestick);
                    if (price) {
                        document.getElementById(`price-${timeframe}`).textContent = `$${price.close.toFixed(2)}`;
                    }
                }
            });
            
            return { chart, candlestick, volume };
        }

        // === Инициализация графиков ===
        function initCharts() {
            Object.entries(chartData).forEach(([timeframe, data]) => {
                const result = createChart(`chart-${timeframe}`, data, timeframe);
                charts[timeframe] = result.chart;
                candlestickSeries[timeframe] = result.candlestick;
                volumeSeries[timeframe] = result.volume;
            });
        }

        // === Обработка изменения размера окна ===
        window.addEventListener('resize', () => {
            Object.entries(charts).forEach(([timeframe, chart]) => {
                chart.applyOptions({
                    width: document.getElementById(`chart-${timeframe}`).clientWidth,
                    height: document.getElementById(`chart-${timeframe}`).clientHeight
                });
            });
        });

        // === Инициализация при загрузке страницы ===
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
        });
    </script>
</body>
</html> 