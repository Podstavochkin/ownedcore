# Жизненный цикл сигнала

## 1. ФОРМИРОВАНИЕ СИГНАЛА ИЗ ES (Elder's Screen)

### Условия генерации сигнала:
- **Уровень прошел Elder's Screens** (`elder_screens_passed = True`)
- **Расстояние до уровня ≤ 0.7%** (`price_diff_pct <= 0.7`)
- **Статус в ES**: `ready_for_signal = True`

### Где происходит:
- `tasks/level_touch_tasks.py` - `check_level_touches()` (каждые 30 сек - 10 мин, адаптивно)
- `core/analysis_engine.py` - `analyze_pair()` (каждые 5 минут)

### Код:
```python
ready_for_signal = elder_screens_passed and price_diff_pct <= 0.7  # В пределах 0.7% (увеличено с 0.6% для учета колебаний)
```

---

## 2. ПРОВЕРКА ПРИ РАЗМЕЩЕНИИ ОРДЕРА

### Допустимое отклонение цены (адаптивное):
- **Базовое отклонение**: `BASE_MAX_DEVIATION_PCT = 0.3%`
- **Минимальное**: `MIN_DEVIATION_PCT = 0.2%`
- **Максимальное**: `MAX_DEVIATION_PCT = 1.0%`
- **С учетом волатильности**: `base + (volatility * VOLATILITY_COEFF / 10.0)`
  - Для тихих монет: ~0.2-0.3%
  - Для волатильных: до 1.0%

### Если цена в допустимом диапазоне:
- **≤ 0.15%** → Market ордер (если `MARKET_ENTRY_THRESHOLD_PCT = 0.15`)
- **> 0.15% и ≤ allowed_deviation** → Limit ордер
- Статус: `PLACED` → ожидание исполнения

### Если цена слишком далеко:
- **> allowed_deviation** → Статус: `PRICE_DEVIATION_TOO_LARGE`
- Сигнал переходит в режим мониторинга (watcher)

---

## 3. МОНИТОРИНГ СИГНАЛА (Watcher)

### Watcher запускается каждые 30 секунд

### Проверяет сигналы со статусами:

#### A) `WAITING_FOR_PRICE`
- Сигнал ждет подхода цены к уровню
- Проверяет, не стал ли сигнал неактивным
- Если цена в допустимом диапазоне → попытка разместить ордер

#### B) `PRICE_DEVIATION_TOO_LARGE` (НОВОЕ!)
- Сигнал был создан, когда цена была далеко
- Watcher перепроверяет, вернулась ли цена ближе
- Если цена в допустимом диапазоне → статус меняется на `WAITING_FOR_PRICE`
- **Только свежие сигналы** (не старше `MAX_SIGNAL_AGE_SECONDS`)

#### C) `LEVEL_BROKEN`
- Уровень был пробит против направления сигнала
- Watcher перепроверяет, восстановился ли уровень
- Если уровень восстановлен → статус меняется на `WAITING_FOR_PRICE`
- **Только свежие сигналы** (не старше `MAX_SIGNAL_AGE_SECONDS`)

---

## 4. ПРОВЕРКА ВАЛИДНОСТИ СИГНАЛА

### Функция: `check_signal_invalidated()`

#### Проверка 1: Отклонение цены > 2%
- **Порог**: `MAX_DEVIATION_PCT = 2.0%`
- Если отклонение > 2% → Статус: `PRICE_DEVIATION_TOO_LARGE`
- **Сигнал становится неактивным**

#### Проверка 2: Пробитие уровня против направления
- **Порог пробития**: `LEVEL_BREAK_THRESHOLD_PCT = 0.2%`
- **LONG**: если цена < уровня на >0.2% → Статус: `LEVEL_BROKEN`
- **SHORT**: если цена > уровня на >0.2% → Статус: `LEVEL_BROKEN`
- **Сигнал становится неактивным**

---

## 5. МАКСИМАЛЬНЫЙ ВОЗРАСТ СИГНАЛА

### Параметр:
- **`MAX_SIGNAL_AGE_SECONDS = 30 * 60 = 1800 секунд (30 минут)`**

### Применение:
- Сигналы старше 30 минут **НЕ обрабатываются** watcher'ом
- Статус меняется на: `SIGNAL_TOO_OLD`
- Сигнал перестает мониториться

### Исключения:
- Сигналы с уже размещенными ордерами (`demo_order_id != None`) продолжают обрабатываться
- Сигналы с открытыми позициями продолжают обрабатываться

---

## 6. ЖИЗНЕННЫЙ ЦИКЛ СИГНАЛА (Схема)

```
┌─────────────────────────────────────────────────────────────┐
│ 1. ES (Elder's Screen)                                      │
│    - Уровень прошел Elder's Screens                        │
│    - Расстояние ≤ 0.7%                                     │
│    → ready_for_signal = True                               │
└──────────────────────┬────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. ГЕНЕРАЦИЯ СИГНАЛА                                        │
│    - Сигнал создан в БД                                     │
│    - Статус: ACTIVE                                         │
│    - demo_status: None                                      │
└──────────────────────┬────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. ПОПЫТКА РАЗМЕЩЕНИЯ ОРДЕРА                                │
│    Проверка цены:                                           │
│    - Если ≤ 0.15% → Market ордер                            │
│    - Если > 0.15% и ≤ allowed_deviation → Limit ордер      │
│    - Если > allowed_deviation → PRICE_DEVIATION_TOO_LARGE  │
└──────────────────────┬────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌──────────────────┐      ┌──────────────────────────────┐
│ 4A. ОРДЕР РАЗМЕЩЕН│      │ 4B. ЦЕНА ДАЛЕКО              │
│    Статус: PLACED │      │    Статус: PRICE_DEVIATION_  │
│                   │      │              TOO_LARGE        │
│    → Ожидание     │      │                               │
│      исполнения   │      │    → Мониторинг watcher'ом   │
└─────────┬─────────┘      └──────────────┬───────────────┘
          │                               │
          │                               │
          ▼                               ▼
┌──────────────────┐      ┌──────────────────────────────┐
│ 5A. ОРДЕР ИСПОЛНЕН│      │ 5B. WATCHER ПЕРЕПРОВЕРЯЕТ     │
│    Статус: FILLED │      │    - Каждые 30 секунд         │
│                   │      │    - Если цена вернулась      │
│    → Мониторинг   │      │      → WAITING_FOR_PRICE      │
│      позиции      │      │    - Если > 2% или пробит     │
│                   │      │      → PRICE_DEVIATION_       │
│                   │      │        TOO_LARGE /            │
│                   │      │        LEVEL_BROKEN           │
└─────────┬─────────┘      └──────────────┬───────────────┘
          │                               │
          │                               │
          ▼                               ▼
┌──────────────────┐      ┌──────────────────────────────┐
│ 6A. ПОЗИЦИЯ ЗАКРЫТА│      │ 6B. СИГНАЛ НЕАКТИВЕН          │
│    Статус: CLOSED │      │    - PRICE_DEVIATION_TOO_LARGE │
│                   │      │    - LEVEL_BROKEN             │
│    → Финализация  │      │    - SIGNAL_TOO_OLD            │
│      результата   │      │                               │
│                   │      │    → Перестает мониториться  │
└───────────────────┘      └──────────────────────────────┘
```

---

## 7. ПАРАМЕТРЫ ОТКЛОНЕНИЙ (Сводка)

| Параметр | Значение | Описание |
|----------|----------|----------|
| **Формирование из ES** | ≤ 0.7% | Максимальное расстояние для генерации сигнала |
| **Market ордер** | ≤ 0.15% | Если цена очень близко к уровню |
| **Limit ордер** | 0.15% - 1.0% | Адаптивно, с учетом волатильности |
| **PRICE_DEVIATION_TOO_LARGE** | > allowed_deviation | При создании сигнала |
| **Неактивность (check_signal_invalidated)** | > 2.0% | Финальная проверка валидности |
| **LEVEL_BROKEN** | > 0.2% | Пробитие уровня против направления |
| **Максимальный возраст** | 30 минут | После этого сигнал не мониторится |

---

## 8. КОГДА СИГНАЛ ПЕРЕСТАЕТ МОНИТОРИТЬСЯ

### Финальные статусы (не мониторятся):
1. **`SIGNAL_TOO_OLD`** - Сигнал старше 30 минут
2. **`CLOSED`** - Позиция закрыта (TP/SL)
3. **`POSITION_ALREADY_OPEN`** - Уже есть открытая позиция/ордер

### Статусы, которые мониторятся (могут восстановиться):
1. **`PRICE_DEVIATION_TOO_LARGE`** - Перепроверяется watcher'ом (только свежие)
2. **`LEVEL_BROKEN`** - Перепроверяется watcher'ом (только свежие)
3. **`WAITING_FOR_PRICE`** - Активно мониторится

### Статусы с активной позицией:
1. **`FILLED`** - Ордер исполнен, позиция открыта
2. **`PLACED`** - Ордер размещен, ожидание исполнения
3. **`SL_TO_BREAKEVEN`** - Стоп-лосс перенесен в безубыток

---

## 9. ПРИМЕРЫ

### Пример 1: Сигнал создан, цена близко
- ES: уровень на расстоянии 0.5% → сигнал создан
- При размещении: цена 0.3% → Limit ордер размещен
- Статус: `PLACED` → ожидание исполнения

### Пример 2: Сигнал создан, цена далеко
- ES: уровень на расстоянии 0.7% → сигнал НЕ создан (превышен порог 0.6%)
- Если уровень приблизится к 0.5% → сигнал будет создан
- При размещении: если цена 1.2% (больше allowed_deviation) → `PRICE_DEVIATION_TOO_LARGE`
- Watcher перепроверяет каждые 30 сек
- Если цена вернется к 0.5% → статус `WAITING_FOR_PRICE` → попытка разместить ордер

### Пример 3: Сигнал создан, уровень пробит
- ES: уровень на расстоянии 0.5% → сигнал создан
- При размещении: цена пробила уровень на 0.3% → `LEVEL_BROKEN`
- Watcher перепроверяет каждые 30 сек
- Если уровень восстановлен → статус `WAITING_FOR_PRICE` → попытка разместить ордер

### Пример 4: Сигнал устарел
- Сигнал создан 35 минут назад
- Watcher пропускает (возраст > 30 минут)
- Статус: `SIGNAL_TOO_OLD`
- Сигнал больше не мониторится

---

## 10. ВАЖНЫЕ ЗАМЕЧАНИЯ

1. **Сигналы создаются ТОЛЬКО из ES** - если уровень не прошел Elder's Screens, сигнал не создается
2. **Строгий порог формирования** - сигналы создаются только при расстоянии ≤ 0.6% (было ≤ 1.0%)
3. **Мониторинг ограничен по времени** - только свежие сигналы (< 30 минут) перепроверяются
4. **Адаптивное отклонение** - учитывается волатильность монеты
5. **Восстановление возможно** - сигналы с `PRICE_DEVIATION_TOO_LARGE` и `LEVEL_BROKEN` могут восстановиться
6. **Финальные проверки** - отклонение > 2% или пробитие > 0.2% делают сигнал неактивным

