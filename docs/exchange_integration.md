## Взаимодействие с биржей (Bybit) в нашем проекте

Этот документ описывает, как наш сервис работает с биржей: от момента формирования сигнала до выставления и сопровождения ордера. Максимально без «жаргона», но точно.

---

### 1. Откуда вообще берутся сигналы

1. **Сбор данных по рынку**
   - Мы периодически подтягиваем котировки (свечи) по всем нужным парам.
   - Для каждой пары считаем:
     - уровни поддержки/сопротивления;
     - тренд (EMA, ADX и т.п.);
     - волатильность (через диапазон свечей).

2. **Формирование сигнала**
   - Когда цена подходит к важному уровню и выполняются наши условия (например, уровень поддержки + восходящий тренд) — формируется сигнал:
     - пара (`XRP/USDT`, `THETA/USDT` и т.д.);
     - направление (`LONG` / `SHORT`);
     - уровень входа (цена, по которой хотим войти);
     - стоп‑лосс и тейк‑профит в процентах от входа.
   - Сигнал сохраняется в базу и помечается как `ACTIVE`.
   - В этот момент **ещё нет ордера на бирже** — только торговая идея.

---

### 2. Как мы решаем, когда именно ставить ордер

Наша задача — не просто создать сигнал, а **войти по адекватной цене**, не «догоняя» цену слишком далеко от уровня.

1. **Адаптивный допуск по цене (учёт волатильности)**
   - Для каждой пары мы оцениваем волатильность:
     - берём последние N (например, 30) минутных свечей;
     - считаем средний диапазон свечи `(high - low)`;
     - делим на среднюю цену закрытия → получаем волатильность в процентах.
   - На основе этого считаем допустимое отклонение:
     - базово хотим около `0.3%`;
     - для тихих пар минимум — `0.2%`;
     - для очень резких допускаем до `1.0%`.
   - В результате:
     - спокойные монеты требуют аккуратного входа (малый допуск),
     - быстрые монеты позволяют чуть больший люфт.

2. **Две фазы ожидания: быстрая и «ленивая»**

Когда появляется новый сигнал:

- **Быстрая фаза (до ~30 секунд)**
  - Сервис несколько раз в секунду проверяет текущую цену:
    - если цена вошла в допустимый диапазон от уровня — ордер создаётся сразу;
    - если цена резко улетела далеко (намного больше допустимого порога) — сигнал помечается как «цена ушла слишком далеко», и мы его больше не трогаем;
    - если цена ни дошла, ни улетела — мы временно переводим сигнал в статус `WAITING_FOR_PRICE` («ждём подхода цены») и завершаем быструю фазу.

- **Фоновый watcher**
  - Отдельная фоновая задача периодически (например, каждые 30 секунд) просматривает все сигналы в статусе `WAITING_FOR_PRICE`.
  - Для каждого:
    - если цена наконец‑то вошла в допустимый диапазон — запускаем ордер;
    - если цена ушла слишком далеко — помечаем сигнал как `PRICE_DEVIATION_TOO_LARGE` и перестаём его трогать;
    - если сигнал «протух» по времени (например, старше 15 минут) — считаем его неактуальным.

Таким образом:

- сигнал не пропадает сразу, если рынок медленно подходит к уровню;
- мы не ставим лимитные ордера, которые будут висеть часами;
- при этом **не гоняемся** за ценой, если она уже ушла куда‑то далеко.

---

### 3. Что именно создаётся на бирже

Когда условия подхода цены выполнены и мы решили входить:

1. **Тип ордера**
   - По умолчанию ставим **лимитный ордер** по цене уровня сигнала — это гарантирует вход «как рассчитывали».
   - Если цена уже практически вплотную к уровню (отклонение ≤ 0.15 % — параметр в настройках), чтобы не упустить импульс, переходим на **market**:
     - объём считаем от текущей цены;
     - сразу же считаем TP/SL от фактического входа;
     - логируем, что вход произошёл агрессивно, чтобы видеть это в отчётах.

2. **Размер позиции**
   - Размер позиции считается из настройки «объём в USDT»:
     - например, `50 USDT` на сделку;
     - делим сумму на цену инструмента, округляем по допустимой точности количества (quantity precision).

3. **Стоп‑лосс и тейк‑профит**
   - Сначала рассчитываем цены SL и TP от **ожидаемой** цены входа (уровня сигнала).
   - После фактического исполнения:
     - проверяем реальную цену входа (с биржи);
     - если она заметно отличается от ожидаемой — пересчитываем TP/SL от реальной цены;
     - выставляем отдельные защитные ордера (stop‑loss и take‑profit) так, чтобы при срабатывании они **закрывали позицию целиком**.

4. **Авто‑отмена лимитного ордера при сильном уходе цены**
   - После постановки лимитного ордера по цене уровня система продолжает следить за рынком.
   - Если текущая рыночная цена уходит от уровня **более чем на 2 %**:
     - лимитный ордер автоматически снимается через API (отменяется на бирже);
     - сигнал получает статус вроде `ORDER_CANCELLED_PRICE_MOVED` (смысл: «ордер отменён из‑за сильного ухода цены»);
     - такая сделка в статистике считается неотработанной, чтобы не «задним числом» считать прибыль/убыток по входу, который фактически уже был нереализуем.

---

### 4. Как мы учитываем ошибки и странные ситуации

В процессе могут случиться разные отклонения. Мы для каждого отдельно фиксируем статус сигнала:

- `WAITING_FOR_PRICE` — сигнал есть, цена ещё не зашла в нужный диапазон, watcher будет продолжать следить.
- `PRICE_DEVIATION_TOO_LARGE` — цена ушла слишком далеко, вход по этой идее уже не имеет смысла.
- `SIGNAL_TOO_OLD` — сигнал слишком старый (прошло слишком много времени, рынок уже «другой»).
- `INVALID_MARKET_PRICE` / `INVALID_ENTRY` — не удалось получить корректную цену с биржи или уровень некорректный.
- `FAILED` — ошибка при отправке на биржу (например, сетевой сбой).
- `FILLED` — ордер исполнен, позиция открыта, TP/SL выставлены.

Эти статусы:

- отображаются в интерфейсе;
- используются для логики: повторно пытаться или уже нет;
- дают нам прозрачную статистику: по каким сигналам реально были сделки, а какие были отклонены и почему.

---

### 5. Итоговая картина «от сигнала до сделки»

1. Анализатор находит уровень и формирует сигнал.
2. Сигнал сохраняется в БД и отображается в UI.
3. Запускается Celery‑задача:
   - «быстрая фаза»:
     - если цена уже рядом — сразу создаём ордер;
     - если цена далеко, но сохраняется шанс подхода — переводим сигнал в `WAITING_FOR_PRICE`;
     - если цена улетела — помечаем сигнал как «слишком далеко».
4. Параллельно работает watcher:
   - периодически проверяет сигналы в `WAITING_FOR_PRICE`;
   - при подходе цены — создаёт ордер;
   - при уходе цены или устаревании — ставит финальный статус.
5. После исполнения ордера:
   - фиксируем реальную цену входа;
   - выставляем (или обновляем) TP/SL;
   - храним всю информацию в сигнале для статистики.

---

### 6. Зачем всё это нужно

Такой подход даёт:

- **максимально точное соответствие** между сигналами и реальными сделками;
- **контроль над качеством входа** (через адаптивный допуск по цене);
- **прозрачную статистику**:
  - сколько сигналов реально отработали на бирже,
  - сколько было пропущено из‑за ухода цены,
  - сколько стали неактуальными по времени.

И главное — стратегия остаётся честной: мы **не «рисуем» сигналы задним числом** и не считаем прибыль по тем идеям, по которым реальный вход уже был невозможен.


