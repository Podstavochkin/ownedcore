# ТЕХНИЧЕСКОЕ ЗАДАНИЕ: Реализация системы трех экранов Элдера

## 1. ОБЩЕЕ ОПИСАНИЕ

### 1.1. Цель
Реализовать систему трех экранов Александра Элдера для улучшения качества торговых сигналов. Система должна фильтровать сигналы на трех уровнях (4H → 1H → 15M), блокируя плохие сигналы и пропуская только качественные.

### 1.2. Адаптация таймфреймов
- **Экран 1 (Долгосрочный тренд):** 4H таймфрейм
- **Экран 2 (Среднесрочный анализ):** 1H таймфрейм  
- **Экран 3 (Точка входа):** 15M таймфрейм

### 1.3. Принципы Элдера
1. Торговать только в направлении долгосрочного тренда
2. Использовать осцилляторы для подтверждения входов
3. Входить на откатах, а не в пробоях
4. Динамический размер позиции в зависимости от силы уровня
5. Строгое управление рисками (правило 2%)

---

## 2. ЭКРАН 1: 4H - ДОЛГОСРОЧНЫЙ ТРЕНД

### 2.1. Назначение
Определить общее направление рынка. Блокировать сигналы, идущие против основного тренда.

### 2.2. Проверки

#### 2.2.1. Тренд BTC/USDT на 4H
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Получать тренд BTC на 4H таймфрейме
- Определять: 'UP', 'DOWN', 'SIDEWAYS'

**Логика фильтрации:**
```
IF BTC тренд == 'UP':
    ✅ Разрешены LONG позиции
    ❌ Запрещены SHORT позиции (кроме level_score > 60)
    
IF BTC тренд == 'DOWN':
    ✅ Разрешены SHORT позиции
    ❌ Запрещены LONG позиции (кроме level_score > 60)
    
IF BTC тренд == 'SIDEWAYS':
    ✅ Разрешены и LONG, и SHORT позиции
```

**Логирование:**
- `SCREEN_1_BTC_TREND`: Записать BTC тренд, решение (разрешено/запрещено), причина
- Если блокировка: `SCREEN_1_BTC_BLOCKED` с причиной

#### 2.2.2. Тренд пары на 4H (НОВОЕ)
**Текущее состояние:** ❌ Не реализовано

**Требования:**
- Рассчитать EMA20 и EMA50 на 4H таймфрейме для пары
- Рассчитать ADX на 4H таймфрейме
- Определить направление тренда пары

**Логика:**
```
EMA20 > EMA50 → Восходящий тренд
EMA20 < EMA50 → Нисходящий тренд
EMA20 ≈ EMA50 (разница < 0.5%) → Боковой тренд

ADX > 25 → Сильный тренд
ADX < 25 → Слабый тренд (боковик)
```

**Правило фильтрации:**
```
Для LONG сигнала:
    ✅ EMA20 > EMA50 (восходящий тренд пары)
    ❌ EMA20 < EMA50 → Блокировать (исключение: level_score > 60)
    
Для SHORT сигнала:
    ✅ EMA20 < EMA50 (нисходящий тренд пары)
    ❌ EMA20 > EMA50 → Блокировать (исключение: level_score > 60)
```

**Логирование:**
- `SCREEN_1_PAIR_TREND`: Записать EMA20, EMA50, ADX, направление тренда, решение
- Если блокировка: `SCREEN_1_PAIR_BLOCKED` с причиной и значениями EMA

**Обработка ошибок:**
- Если не удалось получить 4H свечи → логировать `SCREEN_1_ERROR_NO_DATA`
- Если ошибка расчета EMA/ADX → логировать `SCREEN_1_ERROR_CALCULATION`
- В случае ошибки → разрешить сигнал (не блокировать), но записать предупреждение

### 2.3. Итоговое решение Экран 1
**Логика:**
```
IF (BTC тренд разрешает ИЛИ level_score > 60) AND (тренд пары разрешает ИЛИ level_score > 60):
    ✅ ПРОЙДЕН
ELSE:
    ❌ ЗАБЛОКИРОВАН
```

**Логирование:**
- `SCREEN_1_RESULT`: Записать итоговое решение, все проверки, причины блокировки (если есть)

---

## 3. ЭКРАН 2: 1H - СРЕДНЕСРОЧНЫЙ АНАЛИЗ И УРОВНИ

### 3.1. Назначение
Найти уровни поддержки/сопротивления и определить направление входа. Блокировать входы в пробой.

### 3.2. Проверки

#### 3.2.1. Идентификация уровня
**Текущее состояние:** ✅ Реализовано

**Требования:**
- level_score >= 30
- historical_touches >= 3
- В пределах 2% от текущей цены

**Логирование:**
- `SCREEN_2_LEVEL_CHECK`: Записать level_score, historical_touches, расстояние до уровня, решение

#### 3.2.2. Проверка направления подхода цены к уровню (КРИТИЧНО - НОВОЕ)
**Текущее состояние:** ❌ Не реализовано

**Требования:**
- Определить, с какой стороны цена подходит к уровню
- Блокировать входы в пробой

**Логика:**
```
Для LONG на support:
    ✅ current_price < level_price (цена НИЖЕ уровня - подход снизу)
    ❌ current_price > level_price + 0.1% → Блокировать (пробой вверх)
    
Для SHORT на resistance:
    ✅ current_price > level_price (цена ВЫШЕ уровня - подход сверху)
    ❌ current_price < level_price - 0.1% → Блокировать (пробой вниз)
```

**Проверка на истории свечей (дополнительная):**
- Для LONG на support: проверить, что последние 3-5 свечей 1H были НИЖЕ уровня
- Для SHORT на resistance: проверить, что последние 3-5 свечи 1H были ВЫШЕ уровня
- Это предотвратит входы, когда цена только что пробила уровень

**Логирование:**
- `SCREEN_2_PRICE_APPROACH`: Записать current_price, level_price, разница в %, направление подхода, решение
- Если блокировка: `SCREEN_2_PRICE_APPROACH_BLOCKED` с детальной причиной (пробой вверх/вниз)

**Обработка ошибок:**
- Если не удалось получить текущую цену → логировать `SCREEN_2_ERROR_NO_PRICE`, блокировать сигнал
- Если ошибка проверки истории свечей → разрешить сигнал, но записать предупреждение

#### 3.2.3. Проверка осцилляторов (НОВОЕ)
**Текущее состояние:** ❌ Не реализовано

**Требования:**
- Рассчитать RSI на 1H таймфрейме
- Рассчитать MACD на 1H таймфрейме
- Использовать для фильтрации входов

**RSI (Relative Strength Index):**
```
Для LONG:
    ✅ RSI < 70 (не перекуплен)
    ⚠️ RSI 70-75 → Предупреждение, но разрешить
    ❌ RSI > 75 → Блокировать вход
    
Для SHORT:
    ✅ RSI > 30 (не перепродан)
    ⚠️ RSI 25-30 → Предупреждение, но разрешить
    ❌ RSI < 25 → Блокировать вход
```

**MACD (Moving Average Convergence Divergence):**
```
Для LONG:
    ✅ MACD > Signal (бычий сигнал)
    ❌ MACD < Signal → Блокировать вход
    
Для SHORT:
    ✅ MACD < Signal (медвежий сигнал)
    ❌ MACD > Signal → Блокировать вход
```

**Логирование:**
- `SCREEN_2_RSI`: Записать значение RSI, порог, решение
- `SCREEN_2_MACD`: Записать MACD, Signal, разница, решение
- Если блокировка: `SCREEN_2_OSCILLATOR_BLOCKED` с причиной (RSI/MACD)

**Обработка ошибок:**
- Если не удалось рассчитать RSI/MACD → логировать `SCREEN_2_ERROR_OSCILLATOR`, разрешить сигнал с предупреждением

#### 3.2.4. Проверка объемов
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Текущий объем >= MIN_VOLUME_RATIO * средний объем (по умолчанию 1.0)

**Логирование:**
- `SCREEN_2_VOLUME`: Записать текущий объем, средний объем, соотношение, решение

#### 3.2.5. Проверка волатильности
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Волатильность (ATR-based) >= MIN_VOLATILITY_PCT (по умолчанию 0.2%)

**Логирование:**
- `SCREEN_2_VOLATILITY`: Записать волатильность, порог, решение

#### 3.2.6. Проверка расстояния до уровня
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Расстояние <= MAX_DISTANCE_FOR_SIGNAL_PCT (по умолчанию 1.0%)

**Логирование:**
- `SCREEN_2_DISTANCE`: Записать расстояние в %, порог, решение

### 3.3. Итоговое решение Экран 2
**Логика:**
```
IF все проверки пройдены:
    ✅ ПРОЙДЕН
ELSE:
    ❌ ЗАБЛОКИРОВАН (с указанием причины)
```

**Логирование:**
- `SCREEN_2_RESULT`: Записать итоговое решение, все проверки, причины блокировки (если есть)

---

## 4. ЭКРАН 3: 15M - ТОЧКА ВХОДА

### 4.1. Назначение
Уточнить момент входа и установить стоп-лоссы/тейк-профиты.

### 4.2. Проверки

#### 4.2.1. Касание уровня на 15M
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Low свечи <= level_price <= High свечи
- ИЛИ abs(current_price - level_price) / level_price <= live_touch_tolerance (0.5%)

**Логирование:**
- `SCREEN_3_TOUCH`: Записать Low, High, Close свечи, level_price, решение

#### 4.2.2. Повторная проверка направления подхода (НОВОЕ)
**Текущее состояние:** ❌ Частично реализовано

**Требования:**
- Повторно проверить направление на 15M свечах
- Блокировать, если цена уже пробила уровень

**Логика:**
```
Для LONG на support:
    ✅ Low свечи 15M <= level_price
    ✅ Close свечи 15M < level_price (или очень близко, < 0.2%)
    ❌ Close свечи 15M > level_price + 0.2% → Блокировать (пробой)
    
Для SHORT на resistance:
    ✅ High свечи 15M >= level_price
    ✅ Close свечи 15M > level_price (или очень близко, < 0.2%)
    ❌ Close свечи 15M < level_price - 0.2% → Блокировать (пробой)
```

**Логирование:**
- `SCREEN_3_PRICE_APPROACH`: Записать Close, High, Low свечи, level_price, решение
- Если блокировка: `SCREEN_3_PRICE_APPROACH_BLOCKED` с причиной

#### 4.2.3. Определение типа ордера
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Если расстояние <= MARKET_ENTRY_THRESHOLD_PCT (0.15%) → MARKET ордер
- Если расстояние > MARKET_ENTRY_THRESHOLD_PCT → LIMIT ордер

**Логирование:**
- `SCREEN_3_ORDER_TYPE`: Записать расстояние, порог, выбранный тип ордера

#### 4.2.4. Расчет стоп-лосса и тейк-профита
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Стоп-лосс: 0.4% от entry_price
- Тейк-профит: 1.5% от entry_price

**Логирование:**
- `SCREEN_3_TP_SL`: Записать entry_price, stop_loss, take_profit, риск в %

#### 4.2.5. Проверка свежести сигнала
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Сигнал должен быть создан не более MAX_SIGNAL_AGE_SECONDS (30 минут) назад

**Логирование:**
- `SCREEN_3_AGE`: Записать возраст сигнала в секундах, порог, решение

#### 4.2.6. Проверка дубликатов
**Текущее состояние:** ✅ Реализовано

**Требования:**
- Не должно быть активной позиции по этой паре
- Не должно быть активного входного ордера по этой паре
- Не должно быть уже существующего сигнала для этого уровня

**Логирование:**
- `SCREEN_3_DUPLICATES`: Записать проверку позиций, ордеров, существующих сигналов, решение

### 4.3. Итоговое решение Экран 3
**Логика:**
```
IF все проверки пройдены:
    ✅ ПРОЙДЕН → РАЗМЕСТИТЬ ОРДЕР
ELSE:
    ❌ ЗАБЛОКИРОВАН (с указанием причины)
```

**Логирование:**
- `SCREEN_3_RESULT`: Записать итоговое решение, все проверки, причины блокировки (если есть)
- `SCREEN_3_ORDER_PLACED`: Записать успешное размещение ордера с деталями

---

## 5. ЛОГИРОВАНИЕ И ОТСЛЕЖИВАНИЕ

### 5.1. Структура логирования

#### 5.1.1. Уровни логирования
- `INFO`: Успешные проверки, прохождение экранов
- `WARNING`: Предупреждения, но сигнал разрешен
- `ERROR`: Ошибки, блокировка сигнала
- `DEBUG`: Детальная информация для отладки

#### 5.1.2. Типы событий
Все события должны записываться в `SignalLiveLog` с типом события:

**Экран 1:**
- `SCREEN_1_BTC_TREND` - Проверка BTC тренда
- `SCREEN_1_PAIR_TREND` - Проверка тренда пары
- `SCREEN_1_BTC_BLOCKED` - Блокировка по BTC тренду
- `SCREEN_1_PAIR_BLOCKED` - Блокировка по тренду пары
- `SCREEN_1_RESULT` - Итоговое решение Экран 1
- `SCREEN_1_ERROR_NO_DATA` - Ошибка получения данных
- `SCREEN_1_ERROR_CALCULATION` - Ошибка расчета индикаторов

**Экран 2:**
- `SCREEN_2_LEVEL_CHECK` - Проверка уровня
- `SCREEN_2_PRICE_APPROACH` - Проверка направления подхода
- `SCREEN_2_PRICE_APPROACH_BLOCKED` - Блокировка по направлению подхода
- `SCREEN_2_RSI` - Проверка RSI
- `SCREEN_2_MACD` - Проверка MACD
- `SCREEN_2_OSCILLATOR_BLOCKED` - Блокировка по осцилляторам
- `SCREEN_2_VOLUME` - Проверка объемов
- `SCREEN_2_VOLATILITY` - Проверка волатильности
- `SCREEN_2_DISTANCE` - Проверка расстояния
- `SCREEN_2_RESULT` - Итоговое решение Экран 2
- `SCREEN_2_ERROR_NO_PRICE` - Ошибка получения цены
- `SCREEN_2_ERROR_OSCILLATOR` - Ошибка расчета осцилляторов

**Экран 3:**
- `SCREEN_3_TOUCH` - Проверка касания уровня
- `SCREEN_3_PRICE_APPROACH` - Повторная проверка направления
- `SCREEN_3_PRICE_APPROACH_BLOCKED` - Блокировка по направлению
- `SCREEN_3_ORDER_TYPE` - Определение типа ордера
- `SCREEN_3_TP_SL` - Расчет TP/SL
- `SCREEN_3_AGE` - Проверка свежести
- `SCREEN_3_DUPLICATES` - Проверка дубликатов
- `SCREEN_3_RESULT` - Итоговое решение Экран 3
- `SCREEN_3_ORDER_PLACED` - Успешное размещение ордера

#### 5.1.3. Формат записи в SignalLiveLog
```python
{
    "event_type": "SCREEN_X_CHECK_NAME",
    "message": "Детальное описание проверки",
    "status": "PASSED" | "BLOCKED" | "WARNING" | "ERROR",
    "metadata": {
        "screen": 1 | 2 | 3,
        "check_name": "название проверки",
        "values": {
            # Все значения, использованные в проверке
        },
        "decision": "разрешено" | "заблокировано",
        "reason": "причина блокировки (если есть)",
        "error": "текст ошибки (если есть)"
    }
}
```

### 5.2. Обработка ошибок

#### 5.2.1. Принципы
1. **Не падать на ошибках:** Если проверка не удалась, логировать ошибку и принимать консервативное решение
2. **Консервативность:** При сомнениях блокировать сигнал
3. **Детальное логирование:** Записывать все ошибки с контекстом

#### 5.2.2. Типы ошибок и действия

**Ошибка получения данных (свечи, цена):**
- Действие: Блокировать сигнал
- Логирование: `SCREEN_X_ERROR_NO_DATA`
- Сообщение: "Не удалось получить данные для проверки"

**Ошибка расчета индикаторов (EMA, RSI, MACD):**
- Действие: Разрешить сигнал с предупреждением (если это не критично)
- Логирование: `SCREEN_X_ERROR_CALCULATION`
- Сообщение: "Ошибка расчета индикатора, проверка пропущена"

**Ошибка API биржи:**
- Действие: Блокировать сигнал
- Логирование: `SCREEN_X_ERROR_API`
- Сообщение: "Ошибка API биржи: {детали}"

**Ошибка базы данных:**
- Действие: Блокировать сигнал
- Логирование: `SCREEN_X_ERROR_DB`
- Сообщение: "Ошибка базы данных: {детали}"

### 5.3. Агрегированная статистика

#### 5.3.1. Статистика по экранам
Для каждого сигнала записывать:
- Прошел/не прошел каждый экран
- Причина блокировки (если заблокирован)
- Время прохождения каждого экрана

#### 5.3.2. Общая статистика
В отдельной таблице или метаданных сигнала хранить:
```python
{
    "screen_1_passed": True/False,
    "screen_1_blocked_reason": "причина",
    "screen_2_passed": True/False,
    "screen_2_blocked_reason": "причина",
    "screen_3_passed": True/False,
    "screen_3_blocked_reason": "причина",
    "final_decision": "PASSED" | "BLOCKED",
    "blocked_at_screen": 1 | 2 | 3 | None,
    "all_checks": {
        "screen_1": {...},
        "screen_2": {...},
        "screen_3": {...}
    }
}
```

---

## 6. UI РЕАЛИЗАЦИЯ

### 6.1. Отображение процесса отбора на странице сигналов

#### 6.1.1. Новая колонка "Экраны"
Добавить колонку в таблицу сигналов:
- Иконки для каждого экрана: ✅ (прошел) / ❌ (заблокирован) / ⏳ (в процессе)
- При наведении: показывать причину блокировки

#### 6.1.2. Модальное окно "Детали отбора"
При клике на сигнал открывать модальное окно с детальной информацией:

**Вкладка 1: "Прохождение экранов"**
```
┌─────────────────────────────────────────┐
│ ЭКРАН 1: 4H - Долгосрочный тренд       │
│ ✅ ПРОЙДЕН                              │
│                                         │
│ BTC тренд: UP ✅                        │
│ Тренд пары: UP (EMA20=100.5 > EMA50=99)│
│ ADX: 28 (сильный тренд)                 │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ЭКРАН 2: 1H - Среднесрочный анализ      │
│ ✅ ПРОЙДЕН                              │
│                                         │
│ Уровень: Support @ 100.00 ✅            │
│ level_score: 45 ✅                      │
│ Направление: цена 99.50 < уровня ✅    │
│ RSI: 55 (< 70) ✅                       │
│ MACD: 0.5 > Signal 0.3 ✅               │
│ Объем: 1.2x среднего ✅                 │
│ Волатильность: 0.8% ✅                  │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ЭКРАН 3: 15M - Точка входа              │
│ ✅ ПРОЙДЕН → ОРДЕР РАЗМЕЩЕН             │
│                                         │
│ Касание уровня: ✅                      │
│ Направление: Close 99.50 < уровня ✅   │
│ Тип ордера: LIMIT @ 100.00              │
│ Стоп-лосс: 99.60 (0.4%)                 │
│ Тейк-профит: 101.50 (1.5%)              │
└─────────────────────────────────────────┘
```

**Вкладка 2: "Хронология событий"**
- Хронологический список всех событий из SignalLiveLog
- Фильтрация по экранам
- Поиск по типу события

**Вкладка 3: "Ошибки и предупреждения"**
- Список всех ошибок и предупреждений
- Детали ошибок с контекстом
- Ссылки на соответствующие события

#### 6.1.3. Визуализация на графике
На графике сигнала отображать:
- Линии EMA20 и EMA50 на 4H (если доступны)
- Уровень RSI на момент сигнала
- Уровень MACD на момент сигнала
- Стрелки/маркеры для каждого экрана

### 6.2. Статистика по экранам

#### 6.2.1. Новая страница "Статистика экранов"
Создать страницу `/screen-statistics` с:

**Общая статистика:**
- Всего сигналов за период
- Прошло Экран 1: X (Y%)
- Прошло Экран 2: X (Y%)
- Прошло Экран 3: X (Y%)
- Размещено ордеров: X (Y%)

**Статистика по причинам блокировки:**
- Экран 1: BTC тренд - X, Тренд пары - X
- Экран 2: Направление подхода - X, RSI - X, MACD - X, Объем - X, и т.д.
- Экран 3: Касание - X, Направление - X, Свежесть - X, и т.д.

**Графики:**
- Распределение блокировок по экранам (pie chart)
- Тренд прохождения экранов во времени (line chart)
- Winrate по сигналам, прошедшим разные комбинации экранов

### 6.3. Фильтры на странице сигналов

Добавить фильтры:
- Показать только прошедшие все экраны
- Показать только заблокированные на Экран 1/2/3
- Показать только с ошибками
- Показать только с предупреждениями

---

## 7. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

### 7.1. Новые функции для реализации

#### 7.1.1. Расчет тренда пары на 4H
**Файл:** `core/analysis_engine.py`

**Функция:** `get_pair_trend_4h(pair: str) -> Dict[str, Any]`

**Возвращает:**
```python
{
    "trend": "UP" | "DOWN" | "SIDEWAYS",
    "ema20": float,
    "ema50": float,
    "adx": float,
    "strength": "STRONG" | "WEAK",
    "confidence": float  # 0-1
}
```

**Логирование:**
- При успехе: `SCREEN_1_PAIR_TREND`
- При ошибке: `SCREEN_1_ERROR_CALCULATION`

#### 7.1.2. Проверка направления подхода цены
**Файл:** `core/analysis_engine.py`

**Функция:** `check_price_approach_direction(level_type: str, level_price: float, current_price: float, candles_1h: List[Dict]) -> Tuple[bool, str, Dict]`

**Возвращает:**
```python
(
    is_valid: bool,  # True если подход правильный
    reason: str,     # Причина блокировки (если is_valid=False)
    details: Dict    # Детали проверки
)
```

**Логирование:**
- При успехе: `SCREEN_2_PRICE_APPROACH`
- При блокировке: `SCREEN_2_PRICE_APPROACH_BLOCKED`

#### 7.1.3. Расчет осцилляторов
**Файл:** `core/analysis_engine.py`

**Функция:** `calculate_oscillators(candles_1h: List[Dict]) -> Dict[str, Any]`

**Возвращает:**
```python
{
    "rsi": float,
    "macd": float,
    "macd_signal": float,
    "macd_histogram": float
}
```

**Логирование:**
- При успехе: `SCREEN_2_RSI`, `SCREEN_2_MACD`
- При ошибке: `SCREEN_2_ERROR_OSCILLATOR`

#### 7.1.4. Интеграция проверок в генерацию сигналов
**Файл:** `core/analysis_engine.py`

**Функция:** `check_elder_screens(signal_type: str, level: Dict, current_price: float, candles_4h: List[Dict], candles_1h: List[Dict], candles_15m: List[Dict]) -> Tuple[bool, Dict]`

**Возвращает:**
```python
(
    passed: bool,  # True если все экраны пройдены
    details: Dict  # Детали всех проверок
)
```

**Логирование:**
- Все события прохождения экранов записываются в SignalLiveLog

### 7.2. Модификация существующих функций

#### 7.2.1. `analyze_pair` в `core/analysis_engine.py`
**Изменения:**
- Добавить вызов `check_elder_screens` перед генерацией сигнала
- Если экраны не пройдены → не генерировать сигнал
- Записать все проверки в логи

#### 7.2.2. `place_order_for_signal` в `core/trading/demo_trade_executor.py`
**Изменения:**
- Добавить проверку, что сигнал прошел все экраны (если это не было проверено ранее)
- Записать проверки Экран 3 в логи

### 7.3. Новые поля в модели Signal

**Файл:** `core/models.py`

**Добавить поля:**
```python
# Экраны Элдера
elder_screen_1_passed = Column(Boolean, default=False)
elder_screen_1_blocked_reason = Column(Text)
elder_screen_2_passed = Column(Boolean, default=False)
elder_screen_2_blocked_reason = Column(Text)
elder_screen_3_passed = Column(Boolean, default=False)
elder_screen_3_blocked_reason = Column(Text)
elder_screens_metadata = Column(JSON)  # Детали всех проверок
```

### 7.4. Миграция базы данных

**Файл:** `migrations/versions/XXXX_add_elder_screens_fields.py`

**Добавить:**
- Колонки для хранения результатов прохождения экранов
- Индексы для быстрого поиска

---

## 8. ПРИОРИТЕТЫ РЕАЛИЗАЦИИ

### 8.1. Приоритет 1 (Критично - немедленно)

1. **Проверка направления подхода цены к уровню**
   - Функция `check_price_approach_direction`
   - Интеграция в Экран 2
   - Логирование
   - UI отображение

2. **Расчет тренда пары на 4H**
   - Функция `get_pair_trend_4h`
   - Интеграция в Экран 1
   - Логирование
   - UI отображение

### 8.2. Приоритет 2 (Важно - в ближайшее время)

3. **Расчет осцилляторов (RSI, MACD)**
   - Функция `calculate_oscillators`
   - Интеграция в Экран 2
   - Логирование
   - UI отображение

4. **UI для отображения прохождения экранов**
   - Модальное окно с деталями
   - Колонка в таблице сигналов
   - Статистика по экранам

### 8.3. Приоритет 3 (Желательно - в будущем)

5. **Динамический размер позиции**
   - Зависимость от level_score
   - Интеграция в расчет размера ордера

6. **Улучшенная статистика**
   - Страница статистики экранов
   - Графики и аналитика

---

## 9. ТЕСТИРОВАНИЕ

### 9.1. Unit-тесты

Для каждой новой функции:
- Тесты с корректными данными
- Тесты с некорректными данными
- Тесты обработки ошибок

### 9.2. Интеграционные тесты

- Тест полного прохождения всех экранов
- Тест блокировки на каждом экране
- Тест обработки ошибок

### 9.3. Ручное тестирование

- Проверить на исторических данных
- Проверить на реальных сигналах
- Проверить UI отображение

---

## 10. ДОКУМЕНТАЦИЯ

### 10.1. Техническая документация

- Описание всех новых функций
- Описание структуры логирования
- Описание формата данных

### 10.2. Пользовательская документация

- Описание системы трех экранов
- Как читать результаты отбора
- Как интерпретировать статистику

---

## 11. КРИТЕРИИ ПРИЕМКИ

### 11.1. Функциональность

- ✅ Все проверки Экран 1 реализованы и работают
- ✅ Все проверки Экран 2 реализованы и работают
- ✅ Все проверки Экран 3 реализованы и работают
- ✅ Логирование всех событий работает
- ✅ UI отображает результаты отбора

### 11.2. Качество

- ✅ Обработка всех типов ошибок
- ✅ Детальное логирование
- ✅ Нет падений на ошибках
- ✅ Консервативные решения при сомнениях

### 11.3. Производительность

- ✅ Проверки не замедляют генерацию сигналов более чем на 10%
- ✅ Логирование не блокирует основной поток

---

## 12. ПЛАН РЕАЛИЗАЦИИ

### Этап 1: Экран 1 (1-2 дня)
1. Реализовать `get_pair_trend_4h`
2. Интегрировать в `analyze_pair`
3. Добавить логирование
4. Тестирование

### Этап 2: Экран 2 - Направление подхода (1 день)
1. Реализовать `check_price_approach_direction`
2. Интегрировать в Экран 2
3. Добавить логирование
4. Тестирование

### Этап 3: Экран 2 - Осцилляторы (2-3 дня)
1. Реализовать `calculate_oscillators`
2. Интегрировать в Экран 2
3. Добавить логирование
4. Тестирование

### Этап 4: Экран 3 - Улучшения (1 день)
1. Улучшить проверку направления на 15M
2. Добавить логирование
3. Тестирование

### Этап 5: UI (2-3 дня)
1. Модальное окно с деталями экранов
2. Колонка в таблице сигналов
3. Статистика по экранам
4. Тестирование

### Этап 6: Миграция и финализация (1 день)
1. Миграция базы данных
2. Обновление документации
3. Финальное тестирование

**Общее время: 8-11 дней**

---

**Примечание:** Это техническое задание. Реализация должна начинаться только после утверждения ТЗ и обсуждения деталей.
