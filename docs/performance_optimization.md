# Оптимизация производительности

## Проблемы до оптимизации

### 1. `/api/signal-chart-data/{signal_id}` - Медленная загрузка графика
- **300 свечей** загружалось с биржи (слишком много)
- **Нет таймаута** на запрос к бирже (может зависнуть)
- **Двойная валидация** свечей (2 цикла обработки)
- **Кэш 5 минут** (слишком короткий)

### 2. `/api/potential-signals` - Медленная загрузка страницы ES
- **TTL кэша 30 секунд** (слишком часто пересчитывается)
- **Много запросов к бирже** (3 таймфрейма на каждую пару)
- **Пересчет Elder's Screens** для всех уровней

---

## Решения

### 1. Оптимизация `/api/signal-chart-data/{signal_id}`

#### Уменьшено количество свечей:
- **Было**: 300 свечей
- **Стало**: 150 для 15m, 100 для других таймфреймов
- **Экономия**: ~50% данных
- **Достаточно**: 150 свечей 15m = ~37.5 часов истории

#### Добавлен таймаут:
- **Таймаут**: 5 секунд на запрос к бирже
- **При таймауте**: используется кэш (если есть)
- **Защита**: от зависания запросов

#### Упрощена валидация:
- **Было**: 2 цикла обработки свечей
- **Стало**: 1 цикл с улучшенной обработкой ошибок
- **Результат**: быстрее обработка данных

#### Увеличен TTL кэша:
- **Было**: 5 минут (300 сек)
- **Стало**: 10 минут (600 сек)
- **Результат**: меньше запросов к бирже

### 2. Оптимизация `/api/potential-signals`

#### Увеличен TTL кэша:
- **Было**: 30 секунд
- **Стало**: 300 секунд (5 минут)
- **Синхронизировано**: с `analyze_pair` (каждые 5 минут)
- **Результат**: меньше пересчетов Elder's Screens

#### Использование кэша из БД:
- **Приоритет**: данные из `level.meta_data` (если свежие < 5 минут)
- **Пересчет**: только если данные устарели
- **Результат**: значительное ускорение

---

## Сложность процесса сбора данных

### `/api/signal-chart-data/{signal_id}`:
- **Запрос к БД**: 1 (получение сигнала)
- **Запрос к бирже**: 1 (150 свечей для графика)
- **Обработка**: валидация свечей (1 цикл)
- **Кэш**: 10 минут
- **Elder's Screens**: НЕ пересчитываются (берутся из `signal.elder_screens_metadata`)

### `/api/potential-signals`:
- **Запрос к БД**: 1 (получение всех уровней)
- **Запрос к бирже**: N пар × 3 таймфрейма (1H, 4H, 15M)
  - Только если данные устарели или отсутствуют
  - Используется кэш из БД (`level.meta_data`)
- **Обработка**: Elder's Screens для каждого уровня
  - Приоритет: кэш из БД (если свежий)
  - Пересчет: только если нужно
- **Кэш**: 5 минут (синхронизировано с `analyze_pair`)

### `/api/signals`:
- **Запрос к БД**: 1 (получение сигналов)
- **Запрос к бирже**: 0 (данные из БД)
- **Обработка**: минимальная (`to_dict`)
- **Кэш**: есть

---

## Результаты оптимизации

### Производительность:
- ✅ График сигнала загружается **быстрее** (~50% меньше данных)
- ✅ Защита от таймаутов (5 сек)
- ✅ Меньше запросов к бирже (увеличен кэш)
- ✅ Улучшена производительность всех страниц

### Нагрузка на биржу:
- ✅ Меньше запросов благодаря кэшированию
- ✅ Оптимизированное количество свечей
- ✅ Использование кэша из БД для Elder's Screens

### Пользовательский опыт:
- ✅ Быстрая загрузка графиков
- ✅ Нет зависаний (таймаут 5 сек)
- ✅ Стабильная работа страниц

---

## Рекомендации для дальнейшей оптимизации

1. **Параллельные запросы**: группировать запросы свечей для нескольких пар
2. **Инкрементальное обновление**: обновлять только измененные данные
3. **WebSocket**: для real-time обновлений без постоянных запросов
4. **CDN**: для статических данных графиков

