# Руководство по перезагрузке исторических данных OHLCV

## Обзор

Функция `reload_historical_data_from_exchange()` используется для исправления неправильных исторических данных в БД путем перезагрузки их с биржи.

## Когда использовать

### ✅ Рекомендуемые варианты вызова

#### 1. **Ручной вызов через API** (Рекомендуется)
**Когда:** При обнаружении проблемы с конкретной парой/таймфреймом на графике

**Как:**
```bash
# Перезагрузить последние 3 дня для конкретной пары и таймфрейма
curl -X POST "http://localhost:8000/api/reload-historical-ohlcv?pair=BTC/USDT&timeframe=1h&days=3&force_update_closed=true"

# Перезагрузить все пары и таймфреймы (осторожно - может занять время)
curl -X POST "http://localhost:8000/api/reload-historical-ohlcv?days=1&force_update_closed=true"
```

**Преимущества:**
- Точечное исправление проблем
- Контроль над процессом
- Не перегружает систему

**Недостатки:**
- Требует ручного вмешательства

---

#### 2. **Автоматическая проверка расхождений** (Будущее улучшение)
**Когда:** При обнаружении расхождений между данными БД и биржи

**Логика:**
- Сравнивать последние N свечей из БД с данными биржи
- Если расхождение > порога (например, 0.1%) → автоматически перезагружать
- Выполнять раз в день для последних 1-2 дней

**Реализация (TODO):**
```python
def check_data_discrepancies(pair, timeframe, days=1, threshold=0.001):
    # Сравниваем данные БД с биржей
    # Если расхождение > threshold → reload_historical_data
```

**Преимущества:**
- Автоматическое обнаружение и исправление проблем
- Проактивный подход

**Недостатки:**
- Требует реализации проверки расхождений
- Может быть ложные срабатывания

---

#### 3. **По расписанию (редко)** (Опционально)
**Когда:** Профилактическая проверка раз в неделю

**Расписание:**
- Раз в неделю (например, воскресенье ночью)
- Только для последних 1-2 дней
- Только для основных таймфреймов (15m, 1h, 4h)

**Добавить в `celery_app.conf.beat_schedule`:**
```python
'reload-historical-data-weekly': {
    'task': 'tasks.ohlcv_tasks.reload_historical_data',
    'schedule': crontab(hour=3, minute=0, day_of_week=0),  # Воскресенье 3:00
    'kwargs': {
        'pair': None,  # Все пары
        'timeframe': None,  # Все таймфреймы
        'days': 2,  # Последние 2 дня
        'force_update_closed': False  # Только незакрытые
    }
}
```

**Преимущества:**
- Профилактика проблем
- Автоматическое исправление

**Недостатки:**
- Может быть избыточным, если проблем нет
- Нагрузка на API биржи

---

#### 4. **При первом запуске после простоя** (Опционально)
**Когда:** Система не работала более 24 часов

**Логика:**
- При старте проверять, когда последний раз обновлялись данные
- Если прошло > 24 часов → перезагрузить последние 1-2 дня

**Реализация:**
```python
def check_system_downtime():
    last_update = get_last_ohlcv_update_time()
    if (datetime.now() - last_update).total_seconds() > 86400:
        reload_historical_data(days=2, force_update_closed=False)
```

**Преимущества:**
- Автоматическое восстановление после простоя

**Недостатки:**
- Может замедлить старт системы

---

### ❌ НЕ рекомендуется

1. **Частые автоматические вызовы** - перегружает API биржи
2. **Обновление всех данных** - слишком долго и ресурсоемко
3. **force_update_closed=True без необходимости** - может перезаписать правильные данные

---

## Параметры функции

### `pair` (Optional[str])
- `None` - все пары (30 пар)
- `"BTC/USDT"` - конкретная пара

### `timeframe` (Optional[str])
- `None` - все таймфреймы (15m, 1h, 4h)
- `"1h"` - конкретный таймфрейм

### `days` (int)
- `1` - последний день (рекомендуется для частых проверок)
- `3` - последние 3 дня (по умолчанию, баланс между объемом и временем)
- `7` - последняя неделя (только при серьезных проблемах)

### `force_update_closed` (bool)
- `False` - обновляет только незакрытые свечи (по умолчанию)
- `True` - обновляет ВСЕ свечи, включая закрытые (только для исправления ошибок!)

---

## Рекомендации по использованию

### Сценарий 1: Обнаружена проблема на графике
```bash
# Перезагрузить только проблемную пару и таймфрейм
curl -X POST "http://localhost:8000/api/reload-historical-ohlcv?pair=AAVE/USDT&timeframe=1h&days=3&force_update_closed=true"
```

### Сценарий 2: Профилактическая проверка
```bash
# Перезагрузить последний день для всех пар (быстро)
curl -X POST "http://localhost:8000/api/reload-historical-ohlcv?days=1&force_update_closed=false"
```

### Сценарий 3: После долгого простоя системы
```bash
# Перезагрузить последние 2 дня для всех пар
curl -X POST "http://localhost:8000/api/reload-historical-ohlcv?days=2&force_update_closed=false"
```

---

## Мониторинг

Проверка статуса задачи:
```bash
curl "http://localhost:8000/api/tasks"
```

Логи:
```bash
tail -f /tmp/celery_worker.log | grep "Перезагрузка"
```

---

## Производительность

**Оценка времени:**
- 1 пара, 1 таймфрейм, 3 дня: ~5-10 секунд
- Все пары (30), все таймфреймы (3), 3 дня: ~5-10 минут

**Rate Limiting:**
- Задержка 0.5 сек между парами
- Не более 1 запроса в секунду к бирже

---

## Важные замечания

1. **force_update_closed=True** используйте ТОЛЬКО при обнаружении ошибок в закрытых свечах
2. Не вызывайте слишком часто - уважайте rate limits биржи
3. Для больших объемов (все пары, много дней) лучше запускать в нерабочее время
4. Всегда проверяйте логи после выполнения

