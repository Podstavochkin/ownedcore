# Автоматическое поддержание актуальности данных OHLCV

## Обзор

Система автоматически поддерживает актуальность исторических данных свечей (OHLCV) без ручного вмешательства. Это гарантирует, что после любой паузы (несколько часов, день, два) данные будут автоматически восстановлены и актуализированы.

## Автоматические процессы

### 1. Обновление текущих свечей (каждую минуту)

**Задача:** `update_current_candles`  
**Частота:** Каждую минуту (60 секунд)  
**Что делает:**
- Обновляет последнюю свечу для всех пар и таймфреймов (1m, 5m, 15m, 1h, 4h)
- Обеспечивает актуальность текущих данных в реальном времени

**Результат:** Всегда актуальные текущие свечи

### 2. Проверка и заполнение пропусков (каждые 6 часов)

**Задача:** `check_and_fill_gaps`  
**Частота:** Каждые 6 часов (21600 секунд)  
**Что делает:**
- Обнаруживает пропуски (gaps) в данных за последние 24 часа
- Автоматически заполняет обнаруженные пропуски свечами с биржи
- Сохраняет хронологическую целостность данных

**Результат:** Нет пропусков в данных за последние 24 часа

### 3. Обеспечение исторических данных (каждые 12 часов)

**Задача:** `ensure_historical_data`  
**Частота:** Каждые 12 часов (43200 секунд)  
**Что делает:**
- Проверяет наличие данных за последние 7 дней для всех пар
- Если данных недостаточно (<80% от ожидаемого) - автоматически загружает недостающие
- Проверяет и заполняет пропуски в исторических данных

**Результат:** Всегда есть минимум 7 дней истории для анализа

## Как это работает при паузах

### Пауза 2-3 часа
1. **При возобновлении работы:**
   - `update_current_candles` (каждую минуту) быстро заполнит пропуски в текущих свечах
   - `check_and_fill_gaps` (каждые 6 часов) обнаружит и заполнит пропуски

2. **Результат:** Данные восстановлены автоматически в течение нескольких минут

### Пауза 1-2 дня
1. **При возобновлении работы:**
   - `update_current_candles` обновит текущие свечи
   - `check_and_fill_gaps` обнаружит пропуски за последние 24 часа и заполнит их
   - `ensure_historical_data` проверит наличие 7 дней истории и загрузит недостающие данные

2. **Результат:** Данные восстановлены автоматически в течение 12 часов (максимум)

### Пауза неделя и более
1. **При возобновлении работы:**
   - Все три процесса работают совместно
   - `ensure_historical_data` загрузит недостающие исторические данные
   - `check_and_fill_gaps` заполнит пропуски
   - `update_current_candles` обновит текущие данные

2. **Результат:** Полное восстановление данных в течение 12-24 часов

## Хронологическая целостность

### Гарантии системы:

1. **Проверка хронологии при сохранении:**
   - Каждая свеча сохраняется с точным timestamp
   - Уникальный индекс `(symbol, timeframe, timestamp)` предотвращает дубликаты
   - При обновлении существующей свечи проверяется, что timestamp совпадает

2. **Обнаружение пропусков:**
   - Система вычисляет ожидаемый интервал между свечами на основе таймфрейма
   - Обнаруживает промежутки, превышающие ожидаемый интервал
   - Заполняет пропуски свечами с правильными timestamp'ами

3. **Порядок данных:**
   - Все запросы к БД сортируются по `timestamp ASC`
   - Данные всегда возвращаются в хронологическом порядке
   - Нет искажения истории

## Ручное вмешательство

### Когда НЕ нужно:

- ✅ После паузы в работе системы
- ✅ После перезапуска серверов
- ✅ После обновления кода
- ✅ При недостатке данных в БД

**Система автоматически восстановит все данные!**

### Когда может понадобиться (опционально):

- Если нужно загрузить больше 7 дней истории (например, 30 дней)
- Если нужно ускорить восстановление после длительной паузы

**Команда для ручной загрузки:**
```bash
python3 scripts/load_all_historical_ohlcv.py 30  # Загрузить 30 дней истории
```

## Мониторинг

### Логи для проверки:

1. **Обновление текущих свечей:**
   ```
   ✅ Обновление завершено: X свечей обновлено
   ```

2. **Заполнение пропусков:**
   ```
   ✅ Заполнен пропуск для SYMBOL TIMEFRAME: X свечей
   ✅ Заполнено пропусков: X свечей
   ```

3. **Обеспечение исторических данных:**
   ```
   ✅ SYMBOL TIMEFRAME: загружено/дополнено X свечей
   ✅ Обеспечение исторических данных завершено: X свечей загружено/дополнено
   ```

### Проверка данных в БД:

```python
# Проверить количество свечей для пары
from core.database import init_database, SessionLocal
from core.models import OHLCV
from sqlalchemy import func

init_database()
db = SessionLocal()
count = db.query(func.count(OHLCV.id)).filter(
    OHLCV.symbol == 'ICP',
    OHLCV.timeframe == '15m'
).scalar()
print(f"ICP/USDT 15m: {count} свечей")
```

## Итог

**Система полностью автоматическая!**

- ✅ Автоматическое обновление текущих данных (каждую минуту)
- ✅ Автоматическое заполнение пропусков (каждые 6 часов)
- ✅ Автоматическое обеспечение исторических данных (каждые 12 часов)
- ✅ Гарантия хронологической целостности
- ✅ Работает после любых пауз без ручного вмешательства

**Вам больше не нужно вручную загружать данные!** Система сама поддерживает актуальность.

