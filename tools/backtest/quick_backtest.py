"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ "–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–µ —É—Ä–æ–≤–Ω–∏"
–ê–≤—Ç–æ—Ä: CryptoProject v0.01
–û–ø–∏—Å–∞–Ω–∏–µ: –ë—ã—Å—Ç—Ä—ã–π –±—ç–∫—Ç–µ—Å—Ç —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏—Å—Ç–æ—â–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞
"""

import sys
import os
from datetime import datetime

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from backtest_engine import BacktestEngine
from royal_levels_strategy import RoyalLevelsStrategy

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –±—ç–∫—Ç–µ—Å—Ç–∞"""
    print("üöÄ –ë–´–°–¢–†–´–ô –ë–≠–ö–¢–ï–°–¢ –°–¢–†–ê–¢–ï–ì–ò–ò '–ö–û–†–û–õ–ï–í–°–ö–ò–ï –£–†–û–í–ù–ò'")
    print("="*80)
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±—ç–∫—Ç–µ—Å—Ç–∞
    symbol = 'BTC/USDT'
    start_date = '2024-01-01'  # –ë–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞
    end_date = '2024-06-30'
    initial_deposit = 10000
    commission = 0.001  # 0.1%
    
    print(f"üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±—ç–∫—Ç–µ—Å—Ç–∞:")
    print(f"  –°–∏–º–≤–æ–ª: {symbol}")
    print(f"  –ü–µ—Ä–∏–æ–¥: {start_date} - {end_date}")
    print(f"  –ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç: ${initial_deposit:,.2f}")
    print(f"  –ö–æ–º–∏—Å—Å–∏—è: {commission*100:.1f}%")
    print(f"  –ü–æ—Ä–æ–≥ –∏—Å—Ç–æ—â–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞: 50%")
    print()
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    round_tolerance = 10  # –î–æ–ø—É—Å–∫ –æ–∫—Ä—É–≥–ª–æ—Å—Ç–∏ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
    silent_mode = False   # –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    
    print(f"‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:")
    print(f"  –î–æ–ø—É—Å–∫ –æ–∫—Ä—É–≥–ª–æ—Å—Ç–∏: {round_tolerance}")
    print(f"  –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º: {'–î–∞' if silent_mode else '–ù–µ—Ç'}")
    print()
    
    # –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–æ–∫ –±—ç–∫—Ç–µ—Å—Ç–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    engine = BacktestEngine(initial_deposit=initial_deposit, commission=commission)
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞
    engine.log_every_n_trades = 5      # –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é 5-—é —Å–¥–µ–ª–∫—É
    engine.log_every_n_steps = 500     # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 500 —à–∞–≥–æ–≤
    engine.verbose_logging = False     # –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    engine.strategy = RoyalLevelsStrategy(
        deposit=initial_deposit,
        round_tolerance=round_tolerance,
        silent=silent_mode
    )
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö...")
        saved_data = engine.load_data_from_csv('BTCUSDT')
        
        if not saved_data or len(saved_data) < 4:
            print("üì• –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–∫–∞—á–∏–≤–∞–µ–º —Å –±–∏—Ä–∂–∏...")
            
            # –°–∫–∞—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
            data = engine.download_historical_data(
                symbol=symbol,
                start_date=start_date,
                end_date=end_date
            )
            
            if not data or len(data) < 4:
                print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ")
                return
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ CSV
            engine.save_data_to_csv(data, 'BTCUSDT')
        else:
            print("‚úÖ –ù–∞–π–¥–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ")
            data = saved_data
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫—Ç–µ—Å—Ç
        print("\nüéØ –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä–æ–≥–æ –±—ç–∫—Ç–µ—Å—Ç–∞...")
        print("üí° –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª")
        print("‚ö†Ô∏è  –ë—ç–∫—Ç–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–∏ –∏—Å—Ç–æ—â–µ–Ω–∏–∏ –¥–µ–ø–æ–∑–∏—Ç–∞ –Ω–∞ 50%")
        print()
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        log_filename = f"detailed_backtest_logs_{timestamp}.txt"
        engine.setup_logging(log_filename)
        
        results = engine.run_backtest(data, symbol)
        
        if results:
            # –í—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
            print(f"\nüìã –ö–†–ê–¢–ö–ê–Ø –°–í–û–î–ö–ê:")
            print(f"  –í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫: {results['total_trades']}")
            print(f"  –í–∏–Ω—Ä–µ–π—Ç: {results['winrate']:.2f}%")
            print(f"  –ö–æ–Ω–µ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${results['final_balance']:,.2f}")
            print(f"  –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: {results['total_return_pct']:+.2f}%")
            print(f"  –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞: {results['max_drawdown_pct']:.2f}%")
            
            if results['final_balance'] <= 5000:
                print(f"  ‚ö†Ô∏è  –ë–≠–ö–¢–ï–°–¢ –û–°–¢–ê–ù–û–í–õ–ï–ù –ò–ó-–ó–ê –ò–°–¢–û–©–ï–ù–ò–Ø –î–ï–ü–û–ó–ò–¢–ê!")
                print(f"  üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏")
            else:
                print(f"  ‚úÖ –ë–≠–ö–¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û")
            
            print(f"\nüíæ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: {log_filename}")
            print(f"üìä –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª —Å –ª–æ–≥–∞–º–∏")
            
        else:
            print("‚ùå –ë—ç–∫—Ç–µ—Å—Ç –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
            
    except Exception as e:
        print(f"‚ùå –û–®–ò–ë–ö–ê –ü–†–ò –í–´–ü–û–õ–ù–ï–ù–ò–ò –ë–≠–ö–¢–ï–°–¢–ê: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main() 